<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Board Game Guide</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
/* ============================
   全域色彩與變數
============================ */
:root{
  --c-border:#1e90ff;
  --c-muted:#6b7280;
  --c-bg:#fafafa;
  --chip-bg:#eef6ff;
  --chip-active:#d9ebff;
  --chip-active-border:#1e90ff;
  --card-shadow:0 2px 6px rgba(0,0,0,0.08);
  --w-max:1280px;
}

/* ============================
   Global
============================ */
body{
  font:16px/1.5 system-ui, sans-serif;
  margin:0;
  background:var(--c-bg);
  color:#1f2937;
  padding-bottom:80px;
}

/* 容器限制 */
.container{
  width:100%;
  max-width:var(--w-max);
  margin:0 auto;
}

/* ============================
   Header（搜尋列、下拉、排序）
============================ */
header{
  background:#fff;
  border-bottom:1px solid var(--c-border);
  padding:12px 16px;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:10px;
  position:sticky;
  top:0;
  z-index:20;
}

header input,
header select,
header button{
  font:inherit;
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #d1d5db;
  background:#fff;
}

header button{
  color:var(--c-border);
  border:1px solid var(--c-border);
  cursor:pointer;
}
header button:hover{
  background:var(--c-border);
  color:#fff;
}

/* ============================
   Grid（遊戲卡片區）
============================ */
#GRID{
  padding:16px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:18px;
  max-width:var(--w-max);
  margin:0 auto;
}

.card{
  background:#fff;
  border-radius:12px;
  border:1px solid #e5e7eb;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  transition:0.15s;
  cursor:pointer;
}

.card:hover{
  border-color:var(--c-border);
  box-shadow:var(--card-shadow);
}

/* 封面圖片（正方形） */
.cover{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  background:#f3f4f6;
  border-radius:10px;
}

/* 標題與副標 */
.title{
  font-size:18px;
  font-weight:700;
}
.subtitle{
  color:var(--c-muted);
  font-size:14px;
}

/* ============================
   Chips（分類 / 機制）
============================ */
.chip{
  display:inline-block;
  padding:4px 8px;
  border-radius:8px;
  background:var(--chip-bg);
  font-size:13px;
  margin:2px;
  border:1px solid transparent;
  user-select:none;
}

.chip:hover{
  background:var(--chip-active);
  border-color:var(--chip-active-border);
  cursor:pointer;
}

/* ============================
   詳情視窗（Overlay + Panel）
============================ */
#DETAIL{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding:20px;
  z-index:50;
}

#DETAIL .panel{
  background:#fff;
  width:100%;
  max-width:860px;
  border-radius:12px;
  padding:20px;
  max-height:100%;
  overflow:auto;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}

/* 詳情圖片 */
.detail-img{
  width:100%;
  object-fit:cover;
  border-radius:12px;
  margin-bottom:14px;
}

/* RWD 微調 */
@media (max-width:640px){
  header{
    padding:10px;
  }
  #GRID{
    padding:10px;
    gap:14px;
  }
  .card{
    padding:10px;
  }
  #DETAIL .panel{
    padding:14px;
  }
}
</style>

</head>
<body>

<header>
  <input id="Q" placeholder="搜尋：中文 / 英文 / 關鍵字">
  <select id="CAT"></select>
  <select id="MECH"></select>
  <select id="SORT">
    <option value="name_zh">按名稱（中文）</option>
    <option value="rating_bayes">BGG Bayes</option>
    <option value="rating_avg">玩家平均</option>
    <option value="users_rated">評分人數</option>
    <option value="weight">重量</option>
    <option value="used_price_twd">二手價格</option>
  </select>
  <button id="RANDOM_BTN">隨機預覽</button>
</header>

<div id="GRID"></div>

<!-- 詳情視窗 -->
<div id="DETAIL">
  <div class="panel" id="DETAIL_INNER"></div>
</div>

<script>
/* -------------------------------------------
   以下開始 JS 主程式
   Part 1 結束，Part 2 會從這裡接續
-------------------------------------------- */
/* ===============================
   全域資料與輔助函式
=============================== */
let DATA = [];
let FILTER_CAT = "";
let FILTER_MECH = "";

/* selector 快捷 */
const $ = (sel) => document.querySelector(sel);

/* 文字比對（搜尋） */
function textMatch(t, q){
  if(!q) return true;
  if(!t) return false;
  q = q.toLowerCase();
  return t.toLowerCase().includes(q);
}

/* ===============================
   產生分類 + 機制下拉
=============================== */
function buildOptions(){
  const catSet = new Set();
  const mechSet = new Set();

  for(const g of DATA){
    let cats = g.categories_zh || g.categories || [];
    let mechs = g.mechanisms_zh || g.mechanisms || [];

    for(const c of cats) catSet.add(c);
    for(const m of mechs) mechSet.add(m);
  }

  CAT.innerHTML =
    `<option value="">全部分類</option>` +
    [...catSet].sort().map(c =>
      `<option value="${c}">${c}</option>`).join("");

  MECH.innerHTML =
    `<option value="">全部機制</option>` +
    [...mechSet].sort().map(m =>
      `<option value="${m}">${m}</option>`).join("");
}

/* ===============================
   主渲染：產生卡片列表
=============================== */
function render(){
  let q = Q.value.trim();

  let list = DATA.filter(g => {
    let okSearch =
      textMatch(g.name_zh, q) ||
      textMatch(g.name_en, q) ||
      textMatch(g.name, q) ||
      (g.search_keywords || []).some(k => textMatch(k, q));

    if(!okSearch) return false;

    if(FILTER_CAT){
      let cats = g.categories_zh || g.categories || [];
      if(!cats.includes(FILTER_CAT)) return false;
    }

    if(FILTER_MECH){
      let mechs = g.mechanisms_zh || g.mechanisms || [];
      if(!mechs.includes(FILTER_MECH)) return false;
    }

    return true;
  });

  /* 排序 */
  const key = SORT.value;
  list.sort((a,b)=>{
    let A = a[key]; 
    let B = b[key];
    if(A == null) A = -999999;
    if(B == null) B = -999999;

    if(typeof A === "string") A = A.toLowerCase();
    if(typeof B === "string") B = B.toLowerCase();

    if(A > B) return 1;
    if(A < B) return -1;
    return 0;
  });

  GRID.innerHTML = list.map(g => cardHTML(g)).join("");
}

/* ===============================
   卡片 HTML
=============================== */
function cardHTML(g){
  const img = g.image || g.thumbnail || "";

  const cats = (g.categories_zh || g.categories || [])
    .map(c => `<span class="chip" onclick="chipFilter('cat','${c}',event)">${c}</span>`).join("");

  const mechs = (g.mechanisms_zh || g.mechanisms || [])
    .map(m => `<span class="chip" onclick="chipFilter('mech','${m}',event)">${m}</span>`).join("");

  return `
  <div class="card" onclick="openDetail('${g.id}')">
    <img class="cover" src="${img}" alt="">
    <div class="title">${g.name_zh || g.name_en || g.name}</div>
    <div class="subtitle">${g.name_en || ""}</div>

    <div style="font-size:14px;color:#555;">
      BGG：
      <a href="${g.bgg_url || '#'}" target="_blank">前往頁面</a>
    </div>

    <div>${cats}</div>
    <div>${mechs}</div>

    <div style="margin-top:6px;font-size:14px;">
      評分：${fmt(g.rating_bayes)}（Bayes）
    </div>
    <div style="font-size:14px;">
      玩家平均：${fmt(g.rating_avg)}　重度：${fmt(g.weight)}
    </div>

    <div style="font-size:14px;margin-top:4px;">
      二手：${g.used_price_twd ? "NT$"+g.used_price_twd : "-"}
    </div>
    <div style="font-size:14px;">
      庫存：${g.stock ?? 0}
    </div>
  </div>
  `;
}

/* 數字格式化 */
function fmt(v){
  return (v == null) ? "-" : v;
}

/* ===============================
   點擊 Chips → 套用過濾
=============================== */
function chipFilter(type, value, event){
  event.stopPropagation();
  if(type === "cat"){
    FILTER_CAT = value;
    CAT.value = value;
  }else{
    FILTER_MECH = value;
    MECH.value = value;
  }
  render();
}

/* ===============================
   詳情視窗
=============================== */
function openDetail(id){
  const g = DATA.find(x => x.id === id);
  if(!g) return;

  DETAIL.style.display = "flex";

  const cats = (g.categories_zh || g.categories || [])
    .map(c => `<span class="chip" onclick="chipFilter('cat','${c}',event)">${c}</span>`).join("");

  const mechs = (g.mechanisms_zh || g.mechanisms || [])
    .map(m => `<span class="chip" onclick="chipFilter('mech','${m}',event)">${m}</span>`).join("");

  DETAIL_INNER.innerHTML = `
    <button onclick="closeDetail()" style="float:right;margin-bottom:10px;">關閉</button>

    <img class="detail-img" src="${g.image || g.thumbnail || ''}">
    <h2>${g.name_zh || g.name_en || g.name}</h2>
    <p>${g.name_en || ""}</p>

    <p>BGG Bayes：${fmt(g.rating_bayes)}</p>
    <p>玩家平均：${fmt(g.rating_avg)}</p>
    <p>評分人數：${fmt(g.users_rated)}</p>
    <p>重量：${fmt(g.weight)}</p>

    <h3>分類</h3>
    ${cats}

    <h3>機制</h3>
    ${mechs}

    <h3>你可能也會喜歡</h3>
    <div id="RECO"></div>
  `;

  buildRecommend(g);
}

function closeDetail(){
  DETAIL.style.display = "none";
}

/* ===============================
   推薦系統（基於分類 + 機制）
=============================== */
function buildRecommend(g){
  const baseCats = new Set(g.categories_zh || g.categories || []);
  const baseMechs = new Set(g.mechanisms_zh || g.mechanisms || []);

  let scored = DATA.map(x => {
    if(x.id === g.id) return null;

    let score = 0;

    (x.mechanisms_zh || x.mechanisms || [])
      .forEach(m => { if(baseMechs.has(m)) score += 3; });

    (x.categories_zh || x.categories || [])
      .forEach(c => { if(baseCats.has(c)) score += 1; });

    return {g:x, score};
  })
  .filter(x => x && x.score > 0)
  .sort((a,b) => b.score - a.score)
  .slice(0, 6);

  RECO.innerHTML = scored.map(r => `
    <div class="card" onclick="openDetail('${r.g.id}')">
      <img class="cover" src="${r.g.image || r.g.thumbnail || ''}">
      <div>${r.g.name_zh || r.g.name_en || r.g.name}</div>
    </div>
  `).join("");
}

/* ===============================
   隨機預覽
=============================== */
RANDOM_BTN.addEventListener("click", ()=>{
  if(DATA.length === 0) return;
  const r = DATA[Math.floor(Math.random() * DATA.length)];
  openDetail(r.id);
});

/* ===============================
   事件綁定
=============================== */
Q.addEventListener("input", render);
CAT.addEventListener("change", e=>{
  FILTER_CAT = e.target.value;
  render();
});
MECH.addEventListener("change", e=>{
  FILTER_MECH = e.target.value;
  render();
});
SORT.addEventListener("change", render);

/* ===============================
   JSON 載入（主資料來源）
=============================== */
async function loadData(){
  try{
    const res = await fetch("data/games.json");
    DATA = await res.json();
    buildOptions();
    render();
  }catch(err){
    console.error("資料載入失敗：", err);
  }
}

loadData();

/* Part 2 結束，Part 3 會緊接在後面 */
/* ===============================
   RWD：自動縮放卡片、圖片避免過大
=============================== */
function applyRWD(){
  const cards = document.querySelectorAll(".card");
  cards.forEach(c=>{
    c.style.cursor = "pointer";
  });

  // 行動裝置：卡片變大、圖片比例改為 4:3
  if(window.innerWidth < 640){
    document.querySelectorAll(".cover").forEach(img=>{
      img.style.aspectRatio = "4 / 3";
      img.style.objectFit = "cover";
    });

    document.querySelector(".grid").style.gridTemplateColumns =
      "repeat(auto-fill,minmax(180px,1fr))";
  }else{
    document.querySelectorAll(".cover").forEach(img=>{
      img.style.aspectRatio = "1 / 1";
      img.style.objectFit = "cover";
    });

    document.querySelector(".grid").style.gridTemplateColumns =
      "repeat(auto-fill,minmax(260px,1fr))";
  }
}

window.addEventListener("resize", ()=>applyRWD());
window.addEventListener("load", ()=>applyRWD());

/* ===============================
   ESC 關閉詳情視窗
=============================== */
document.addEventListener("keydown", e=>{
  if(e.key === "Escape"){
    closeDetail();
  }
});

/* ===============================
   點擊背景關閉詳情
=============================== */
DETAIL.addEventListener("click", e=>{
  if(e.target === DETAIL){
    closeDetail();
  }
});

/* ===============================
   完成
=============================== */
</script>

</body>
</html>
