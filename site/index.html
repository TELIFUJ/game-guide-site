<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Board Game Guide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa;
      --chip-bg:#f8fafc; --chip-active:#eef2ff; --chip-active-b:#c7d2fe;
    }
    body{font:16px/1.5 system-ui;margin:20px;background:var(--bg);color:#222}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{position:relative;border:1px solid var(--border);padding:14px;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .poster{width:100%;aspect-ratio:1/1;object-fit:contain;background:#f3f4f6;border-radius:8px;display:block}
    .price{font-weight:700;margin-top:6px}
    .price small{font-weight:400;color:var(--muted)}
    input,select,label,button{font:inherit}
    input,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:var(--chip-bg);color:inherit;text-decoration:none;cursor:pointer;user-select:none}
    .chip.active{background:var(--chip-active);border-color:var(--chip-active-b)}
    .muted{color:var(--muted)}
    .checkbox{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:8px;align-items:center}
    .fav-btn{position:absolute;top:10px;right:10px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border);border-radius:999px;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;cursor:pointer}
    .fav-btn .star{font-size:22px;line-height:1}
    .fav-btn:hover{ transform:scale(1.06); box-shadow:0 4px 14px rgba(0,0,0,.08) }
    .fav-btn.active{ background:#fff7cc; border-color:#facc15 }
    .pagination{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:10px 0}
    .page-btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .page-btn.active{background:#eef2ff;border-color:#c7d2fe}
    .page-btn:disabled{opacity:.5;cursor:not-allowed}

    /* --- smart suggestions (æ–°å¢) --- */
    .suggest{position:fixed;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:6px;z-index:99;width:min(520px,92vw);max-height:260px;overflow:auto}
    .suggest.hidden{display:none}
    .suggest a{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:8px;text-decoration:none;color:inherit}
    .suggest a:hover{background:#f3f4f6}
    .suggest .meta{font-size:12px;color:var(--muted)}
    .suggest .ext{margin-top:6px;padding-top:6px;border-top:1px dashed var(--border);display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>

<form class="filters" autocomplete="off" onsubmit="return false">
  <input id="q" name="q_no_autofill"
         placeholder="æœå°‹ï¼šä¸­æ–‡å / EN / é—œéµå­—" style="min-width:220px"
         autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <!-- æ–°å¢ï¼šå³æ™‚å»ºè­°å®¹å™¨ï¼ˆæœƒè‡ªå‹•å®šä½åˆ° #q åº•ä¸‹ï¼‰ -->
  <div id="qSuggest" class="suggest hidden"></div>

  <select id="catSel"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
  <select id="mechSel"><option value="">å…¨éƒ¨æ©Ÿåˆ¶</option></select>

  <input id="pmin" name="pmin_no_autofill" type="number" placeholder="æœ€ä½åƒ¹ï¼ˆå«äºŒæ‰‹ï¼‰"
         autocomplete="off" inputmode="numeric" spellcheck="false">
  <input id="pmax" name="pmax_no_autofill" type="number" placeholder="æœ€é«˜åƒ¹ï¼ˆå«äºŒæ‰‹ï¼‰"
         autocomplete="off" inputmode="numeric" spellcheck="false">

  <label class="checkbox"><input type="checkbox" id="inclUsed"> å«äºŒæ‰‹åƒ¹</label>
  <label class="checkbox"><input type="checkbox" id="hotCat"> ç†±é–€åˆ†é¡ï¼ˆâ‰¥10ï¼‰</label>
  <label class="checkbox"><input type="checkbox" id="hotMech"> ç†±é–€æ©Ÿåˆ¶ï¼ˆâ‰¥10ï¼‰</label>

  <select id="sort">
    <option value="">æ’åº</option>
    <option value="min_price_asc">æœ€ä½åƒ¹æ ¼ï¼ˆå«äºŒæ‰‹ï¼‰ä½â†’é«˜</option>
    <option value="min_price_desc">æœ€ä½åƒ¹æ ¼ï¼ˆå«äºŒæ‰‹ï¼‰é«˜â†’ä½</option>
    <option value="price_asc">å”®åƒ¹ï¼ˆæ–°å“ï¼‰ä½â†’é«˜</option>
    <option value="price_desc">å”®åƒ¹ï¼ˆæ–°å“ï¼‰é«˜â†’ä½</option>
    <option value="used_asc">äºŒæ‰‹åƒ¹ ä½â†’é«˜</option>
    <option value="used_desc">äºŒæ‰‹åƒ¹ é«˜â†’ä½</option>
    <option value="weight_asc">ç­–ç•¥å¼·åº¦ ä½â†’é«˜</option>
    <option value="weight_desc">ç­–ç•¥å¼·åº¦ é«˜â†’ä½</option>
  </select>
</form>

<div class="bar">
  <span id="stats">ç¸½æ•¸ï¼š0ï½œç›®å‰é¡¯ç¤ºï¼š0ï½œæ”¶è—ï¼š0</span>
  <div class="row">
    æ¯é 
    <select id="pageSize">
      <option>15</option><option>20</option><option>25</option><option selected>40</option>
    </select> ç­†
  </div>
  <div class="row">
    <button id="prev" class="btn">â€¹ ä¸Šä¸€é </button>
    <span id="pageInfo">ç¬¬ 1/1 é </span>
    <button id="next" class="btn">ä¸‹ä¸€é  â€º</button>
  </div>
  <label class="checkbox"><input type="checkbox" id="onlyFav"> åªçœ‹æ”¶è—</label>
  <!-- æ–°å¢ï¼šéš±è—é‡è¤‡ï¼ˆè‡ªå‹•åˆä½µï¼‰ -->
  <label class="checkbox"><input type="checkbox" id="hideDup" checked> éš±è—é‡è¤‡ï¼ˆè‡ªå‹•åˆä½µï¼‰</label>
  <button id="dlCsv" class="btn">ä¸‹è¼‰ CSV</button>
  <button id="emailFav" class="btn">Email æ”¶è—æ¸…å–®</button>
</div>

<!-- ä¸Šæ–¹æ•¸å­—åˆ†é  -->
<div id="pager" class="pagination" aria-label="pagination"></div>

<div id="grid" class="grid"></div>

<!-- åº•éƒ¨åˆ†é  -->
<div id="pager-bottom" class="pagination" aria-label="pagination"></div>

<script>
  // é¿å…ç€è¦½å™¨æ²¿ç”¨èˆŠè‡ªå‹•å¡«å…¥
  document.getElementById('q').setAttribute('name','q_'+Math.random().toString(36).slice(2));

  // ---- è·¯å¾‘åŸºæº–ï¼šæ”¯æ´ GitHub Pages å°ˆæ¡ˆé ã€æœ¬æ©Ÿèˆ‡å­è³‡æ–™å¤¾ ----
  const PATH_SEGS = location.pathname.split('/').filter(Boolean);
  const REPO = PATH_SEGS.length ? PATH_SEGS[0] : '';
  const BASE = (location.hostname.endsWith('github.io') && REPO)
    ? `/${REPO}/`
    : (location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, ''));

  function absUrl(p){
    if(!p) return '';
    if(/^https?:\/\//i.test(p)) return p;
    return BASE + String(p).replace(/^\/+/, '');
  }

  // ====== è‹±â†’ä¸­å‚™æ´æ˜ å°„ ======
  const CAT_MAP = {
    "Abstract Strategy":"æŠ½è±¡ç­–ç•¥","Action / Dexterity":"å‹•ä½œï¼æ•æ·","Adventure":"å†’éšª","Age of Reason":"å•Ÿè’™æ™‚ä»£",
    "American Civil War":"ç¾åœ‹å—åŒ—æˆ°çˆ­","American Indian Wars":"åŒ—ç¾å°ç¬¬å®‰æˆ°çˆ­","American Revolutionary War":"ç¾åœ‹ç¨ç«‹æˆ°çˆ­",
    "American West":"ç¾åœ‹è¥¿éƒ¨","Ancient":"å¤ä»£","Animals":"å‹•ç‰©","Arabian":"é˜¿æ‹‰ä¼¯","Aviation / Flight":"èˆªç©ºï¼é£›è¡Œ",
    "Bluffing":"å”¬äºº","Book":"æ›¸ç±","Card Game":"å¡ç‰Œ","Children's Game":"å…’ç«¥","City Building":"åŸå¸‚å»ºè¨­","Civil War":"å…§æˆ°",
    "Civilization":"æ–‡æ˜","Collectible Components":"æ”¶è—è¦ç´ ","Comic Book / Strip":"æ¼«ç•«","Deduction":"æ¨ç†","Dice":"éª°å­",
    "Economic":"ç¶“æ¿Ÿ","Educational":"æ•™è‚²","Electronic":"é›»å­","Environmental":"ç’°å¢ƒè­°é¡Œ","Expansion for Base-game":"åŸºæœ¬æ¬¾æ“´å……",
    "Exploration":"æ¢ç´¢","Fan Expansion":"ç©å®¶è‡ªè£½æ“´å……","Fantasy":"å¥‡å¹»","Farming":"è¾²æ¥­","Fighting":"æˆ°é¬¥","Game System":"éŠæˆ²ç³»çµ±",
    "Horror":"ææ€–","Humor":"å¹½é»˜","Industry / Manufacturing":"å·¥æ¥­ï¼è£½é€ ","Korean War":"éŸ“æˆ°","Mafia":"é»‘å¹«","Math":"æ•¸å­¸",
    "Mature / Adult":"é™åˆ¶ç´šï¼æˆäºº","Maze":"è¿·å®®","Medical":"é†«ç™‚","Medieval":"ä¸­ä¸–ç´€","Memory":"è¨˜æ†¶","Miniatures":"å¾®ç¸®æ¨¡å‹",
    "Modern Warfare":"ç¾ä»£æˆ°çˆ­","Movies / TV / Radio theme":"å½±è¦–ï¼å»£æ’­ä¸»é¡Œ","Murder / Mystery":"æ‡¸ç–‘ï¼æ¨ç†","Music":"éŸ³æ¨‚",
    "Mythology":"ç¥è©±","Napoleonic":"æ‹¿ç ´å´™æ™‚ä»£","Nautical":"èˆªæµ·","Negotiation":"è«‡åˆ¤","Novel-based":"å°èªªæ”¹ç·¨","Number":"æ•¸å­—",
    "Party Game":"æ´¾å°","Pike and Shot":"çŸ›æ§èˆ‡ç«æ§æ™‚ä»£","Pirates":"æµ·ç›œ","Political":"æ”¿æ²»","Post-Napoleonic":"æ‹¿ç ´å´™å¾Œæ™‚ä»£",
    "Prehistoric":"å²å‰","Print & Play":"è‡ªå°ç‰ˆ","Puzzle":"ç›Šæ™ºï¼æ‹¼åœ–","Racing":"ç«¶é€Ÿ","Real-time":"å³æ™‚åˆ¶","Religious":"å®—æ•™",
    "Renaissance":"æ–‡è—å¾©èˆˆ","Science Fiction":"ç§‘å¹»","Space Exploration":"å¤ªç©ºæ¢ç´¢","Spies / Secret Agents":"é–“è«œ","Sports":"é‹å‹•",
    "Territory Building":"é ˜åœ°å»ºè¨­","Third-party Expansion":"ç¬¬ä¸‰æ–¹æ“´å……","Trains":"éµé“","Transportation":"äº¤é€š","Travel":"æ—…éŠ",
    "Trivia":"å•ç­”","Video Game Theme":"é›»ç©ä¸»é¡Œ","Vietnam War":"è¶Šæˆ°","Wargame":"æˆ°æ£‹","Word Game":"å­—è©",
    "World War I":"ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ°","World War II":"ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ°","Zombies":"æ®­å±"
  };

  const MECH_MAP = {
    "Action Points":"è¡Œå‹•é»","Area Majority / Influence":"å€åŸŸæ§åˆ¶","Area Movement":"å€åŸŸç§»å‹•",
    "Auction / Bidding":"ç«¶æ¨™","Bag Building":"å¸ƒè¢‹æ§‹ç¯‰","Campaign / Battle Card Driven":"åŠ‡æœ¬ï¼æˆ°å½¹å¡é©…å‹•",
    "Card Drafting":"é¸ç‰Œ","Card Play Conflict Resolution":"å‡ºç‰Œè§£è¡çª","Cooperative Game":"åˆä½œ",
    "Contracts":"åˆç´„","Deck Construction":"ç‰Œåº«æ§‹ç¯‰","Dice Rolling":"æ“²éª°","End Game Bonuses":"çµ‚å±€åŠ åˆ†",
    "Grid Movement":"æ ¼å­ç§»å‹•","Hand Management":"æ‰‹ç‰Œç®¡ç†","Hidden Movement":"éš±è—ç§»å‹•",
    "Line Drawing":"é€£ç·š","Loans":"å€Ÿè²¸","Memory":"è¨˜æ†¶","Modular Board":"æ¨¡çµ„åŒ–åœ°åœ–",
    "Movement Points":"ç§»å‹•é»","Network and Route Building":"è·¯ç¶²å»ºè¨­","Negotiation":"è«‡åˆ¤",
    "Open Drafting":"å…¬é–‹é¸ç‰Œ","Ownership":"æ‰€æœ‰æ¬Š","Pattern Recognition":"åœ–å½¢è¾¨è­˜",
    "Pick-up and Deliver":"å–è²¨é‹é€","Press Your Luck":"æŠ¼æ³¨ç¢°é‹æ°£","Rock-Paper-Scissors":"çŒœæ‹³",
    "Role Playing":"è§’è‰²æ‰®æ¼”","Scenario / Mission / Campaign Game":"åŠ‡æœ¬ï¼ä»»å‹™ï¼æˆ°å½¹",
    "Set Collection":"æ”¶é›†å¥—çµ„","Simultaneous Action Selection":"åŒæ™‚é¸æ“‡è¡Œå‹•",
    "Solo / Solitaire Game":"å–®äºº","Square Grid":"æ–¹æ ¼","Take That":"äº’å®³",
    "Tile Placement":"æ¿å¡Šæ“ºæ”¾","Trading":"äº¤æ˜“","Trick-taking":"åƒå¢©",
    "Turn Order: Claim Action":"æ¶å…ˆæ‰‹","Variable Phase Order":"å¯è®Šéšæ®µé †åº",
    "Variable Player Powers":"è§’è‰²èƒ½åŠ›","Variable Set-up":"å¯è®Šè¨­ç½®",
    "Worker Placement":"å·¥äººæ”¾ç½®","Worker Placement with Dice Workers":"éª°å­å·¥äºº",
    "Deck, Bag, and Pool Building":"å¡ï¼è¢‹ï¼æ± æ§‹ç¯‰",
    "Deck, Bag and Pool Building":"å¡ï¼è¢‹ï¼æ± æ§‹ç¯‰",
    "Different Worker Types":"ä¸åŒå·¥ç¨®å·¥äºº",
    "Worker Placement, Different Worker Types":"å¤šå·¥ç¨®å·¥äººæ”¾ç½®"
  };

  const MIN_CAT_COUNT  = 10;
  const MIN_MECH_COUNT = 10;
  const DATA_URL = absUrl('data/games_full.json') + '?ts=' + Date.now();

  const G = document.getElementById("grid"),
        Q = document.getElementById("q"),
        CAT = document.getElementById("catSel"),
        MECH = document.getElementById("mechSel"),
        S = document.getElementById("sort"),
        PMIN = document.getElementById("pmin"),
        PMAX = document.getElementById("pmax"),
        INCL = document.getElementById("inclUsed"),
        HOTC = document.getElementById("hotCat"),
        HOTM = document.getElementById("hotMech"),
        ONLYF = document.getElementById("onlyFav"),
        HIDED = document.getElementById("hideDup"),
        STATS = document.getElementById("stats"),
        PAGE_SIZE = document.getElementById("pageSize"),
        PREV = document.getElementById("prev"),
        NEXT = document.getElementById("next"),
        PAGE_INFO = document.getElementById("pageInfo"),
        DLCSV = document.getElementById("dlCsv"),
        EMAIL = document.getElementById("emailFav"),
        PAGER_TOP = document.getElementById("pager"),
        PAGER_BOTTOM = document.getElementById("pager-bottom"),
        QSUG = document.getElementById("qSuggest");

  let DATA=[], page=1;

  // æ”¶è—
  const favKey = 'bg_favs';
  const favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
  function saveFavs(){ localStorage.setItem(favKey, JSON.stringify([...favs])); }
  function idOf(x){ return x.id || String(x.bgg_id || (x.name_zh||x.name_en)); }

  // é¡åˆ¥ / æ©Ÿåˆ¶ä¸­æ–‡
  function getCatsZh(x){
    if (Array.isArray(x.categories_zh) && x.categories_zh.length) return x.categories_zh.slice(0,10);
    const en = Array.isArray(x.categories) ? x.categories : [];
    return en.map(s => CAT_MAP[s] || s).slice(0,10);
  }
  function getMechsZh(x){
    if (Array.isArray(x.mechanics_zh) && x.mechanics_zh.length) return x.mechanics_zh.slice();
    const en = Array.isArray(x.mechanics) ? x.mechanics : [];
    const normalize = s => (s || "").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
    return [...new Set(en.map(s => MECH_MAP[normalize(s)] || normalize(s)))];
  }

  // åƒ¹æ ¼
  function priceCandidates(x, includeUsed=true){
    const out=[]; if (x.price_twd!=null && x.price_twd!=="") out.push(Number(x.price_twd));
    if (includeUsed && x.used_price_twd!=null && x.used_price_twd!=="") out.push(Number(x.used_price_twd));
    return out;
  }
  function minPrice(x, includeUsed=true){
    const c=priceCandidates(x, includeUsed);
    return c.length? Math.min(...c) : Number.POSITIVE_INFINITY;
  }

  // ===== é‡è¤‡åˆä½µå·¥å…·ï¼ˆåƒ…é¡¯ç¤ºç”¨ï¼Œä¸æ”¹åŸè³‡æ–™ï¼‰=====
  function normalizeImgUrl(s){
    s = String(s||'').toLowerCase();
    s = s.replace(/^https?:\/\/[^/]+/, ''); // å»æ‰ç¶²åŸŸ
    s = s.replace(/[?#].*$/, '');           // å»æ‰ query/fragment
    return s;
  }
  function dupKey(x){
    return [
      x.bgg_id || '',
      (x.name_zh || x.name_en || '').trim().toLowerCase(),
      normalizeImgUrl(x.image || x.image_url || x.thumb_url || '')
    ].join('|');
  }
  // é¸å‡ºç¾¤çµ„è£¡ã€Œè¼ƒä½³ã€çš„ä¸€å¼µï¼ˆæœ‰ override > æœ‰æ–°å“åƒ¹ > è¼ƒä¾¿å®œ > åº«å­˜é«˜ï¼‰
  function isBetter(a,b){
    const ao = !!a.image_override, bo = !!b.image_override;
    if (ao !== bo) return ao;
    const ap = a.price_twd ?? Infinity, bp = b.price_twd ?? Infinity;
    if (ap !== bp) return ap < bp;
    const as = a.stock ?? -1, bs = b.stock ?? -1;
    if (as !== bs) return as > bs;
    return false;
  }
  function dedupList(list){
    const pick = new Map();
    const counts = new Map();
    for (const x of list){
      const k = dupKey(x);
      const cur = pick.get(k);
      if (!cur || isBetter(x, cur)) pick.set(k, x);
      counts.set(k, (counts.get(k)||0)+1);
    }
    const out = [];
    for (const [k, x] of pick.entries()){
      const clone = {...x};
      clone._variant_count = counts.get(k)||1;
      out.push(clone);
    }
    return out;
  }

  // åŒ¯å‡º
  function downloadCSV(rows){
    const headers = ["name_zh","name_en","categories_zh","mechanics_zh","price_twd","used_price_twd","stock","bgg_url"];
    const lines = [headers.join(",")];
    rows.forEach(x=>{
      const vals = [
        (x.name_zh||"").replace(/,/g,"ï¼Œ"),
        (x.name_en||"").replace(/,/g,"ï¼Œ"),
        (getCatsZh(x).join("/")).replace(/,/g,"ï¼Œ"),
        (getMechsZh(x).join("/")).replace(/,/g,"ï¼Œ"),
        x.price_twd??"", x.used_price_twd??"", x.stock??"", (x.link_override||x.bgg_url_override||x.bgg_url||"")
      ];
      lines.push(vals.join(","));
    });
    const blob = new Blob(["\ufeff"+lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = "boardgames.csv"; a.click();
    URL.revokeObjectURL(a.href);
  }

  function emailFavList(rows){
    const body = rows.map((x,i)=>`${i+1}. ${x.name_zh||x.name_en||""}
${x.name_en?`EN: ${x.name_en}\n`:""}åˆ†é¡ï¼š${getCatsZh(x).join(" / ")}
æ©Ÿåˆ¶ï¼š${getMechsZh(x).join(" / ")}
åƒ¹æ ¼ï¼š${x.price_twd??"-"}ï½œäºŒæ‰‹ï¼š${x.used_price_twd??"-"}
é€£çµï¼š${x.link_override||x.bgg_url_override||x.bgg_url||""}\n`).join("\n");
    const mailto = `mailto:?subject=${encodeURIComponent("æ”¶è—æ¸…å–®")}&body=${encodeURIComponent(body)}`;
    location.href = mailto;
  }

  // åœ–ç‰‡ä¾†æº
  function imageSrcOf(x){
    const raw = x.image || x.image_url || x.thumb_url || '';
    const url = absUrl(raw);
    return url || 'https://via.placeholder.com/800?text=No+Image';
  }

  // ====== è¼‰å…¥è³‡æ–™ ======
  fetch(DATA_URL).then(r=>r.json()).then(d=>{
    DATA=d;
    buildOptions();
    const u = new URL(location.href);
    const catQ = u.searchParams.get('cat'), mechQ = u.searchParams.get('mech'), pageQ = parseInt(u.searchParams.get('page')||'1',10);
    if (catQ){ HOTC.checked=false; buildOptions(); ensureOption(CAT, catQ); CAT.value=catQ; }
    if (mechQ){ HOTM.checked=false; buildOptions(); ensureOption(MECH, mechQ); MECH.value=mechQ; }
    if (!Number.isNaN(pageQ) && pageQ>0) page = pageQ;
    render();
  }).catch(e=>{
    console.error('Load data failed:', e, DATA_URL);
    alert('ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼š' + DATA_URL);
  });

  function ensureOption(sel, text){
    if (![...sel.options].some(o=>o.value===text)){
      const o=document.createElement('option'); o.value=text; o.textContent=text; sel.appendChild(o);
    }
  }

  function buildOptions(){
    const cCounts=new Map();
    DATA.forEach(x=>getCatsZh(x).forEach(c=>cCounts.set(c,(cCounts.get(c)||0)+1)));
    CAT.innerHTML='<option value="">å…¨éƒ¨åˆ†é¡</option>';
    [...cCounts.entries()].filter(([n,cnt])=>!HOTC.checked || cnt>=MIN_CAT_COUNT)
      .sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'))
      .forEach(([n])=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; CAT.appendChild(o); });

    const mCounts=new Map();
    DATA.forEach(x=>getMechsZh(x).forEach(m=>mCounts.set(m,(mCounts.get(m)||0)+1)));
    MECH.innerHTML='<option value="">å…¨éƒ¨æ©Ÿåˆ¶</option>';
    [...mCounts.entries()].filter(([n,cnt])=>!HOTM.checked || cnt>=MIN_MECH_COUNT)
      .sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'))
      .forEach(([n])=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; MECH.appendChild(o); });
  }

  [Q,CAT,MECH,S,PMIN,PMAX,INCL,PAGE_SIZE].forEach(el=>el.addEventListener('input',()=>{page=1;render();}));
  [HOTC,HOTM].forEach(el=>el.addEventListener('change',()=>{ buildOptions(); page=1; render(); }));
  ONLYF.addEventListener('change', ()=>{ page=1; render(); });
  HIDED.addEventListener('change', ()=>{ page=1; render(); });
  PREV.addEventListener('click', ()=>{ if(page>1){page--; render(); scrollToTop();}});
  NEXT.addEventListener('click', ()=>{ const {pages}=filtered(); if(page<pages){page++; render(); scrollToTop();}});
  DLCSV.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); downloadCSV(pagedAll); });
  EMAIL.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); emailFavList(pagedAll); });

  function filtered(noPaging=false){
    let list = DATA.slice();
    const q = Q.value.trim().toLowerCase();
    if(q){
      list = list.filter(x=>{
        const blob = [x.name_zh||"", x.name_en||"", ...(x.aliases_zh||[]), ...(x.search_keywords||[])].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }
    const cSel = CAT.value, mSel = MECH.value;
    if(cSel) list = list.filter(x => getCatsZh(x).includes(cSel));
    if(mSel) list = list.filter(x => getMechsZh(x).includes(mSel));

    const includeUsed = INCL.checked;
    const pmin = Number(PMIN.value||0), pmax = Number(PMAX.value||0);
    if (pmin>0 || pmax>0){
      list = list.filter(x=>{
        const cand = priceCandidates(x, includeUsed);
        if (cand.length===0) return false;
        return cand.some(p => (pmin>0 ? p>=pmin : true) && (pmax>0 ? p<=pmax : true));
      });
    }
    if (ONLYF.checked) list = list.filter(x=>favs.has(idOf(x)));

    const includeUsedForSort = INCL.checked;
    switch (S.value){
      case "min_price_asc":  list.sort((a,b)=> minPrice(a, includeUsedForSort) - minPrice(b, includeUsedForSort)); break;
      case "min_price_desc": list.sort((a,b)=> minPrice(b, includeUsedForSort) - minPrice(a, includeUsedForSort)); break;
      case "price_asc":      list.sort((a,b)=>(a.price_twd??1e12)-(b.price_twd??1e12)); break;
      case "price_desc":     list.sort((a,b)=>(b.price_twd??-1)-(a.price_twd??-1)); break;
      case "used_asc":       list.sort((a,b)=>(a.used_price_twd??1e12)-(b.used_price_twd??1e12)); break;
      case "used_desc":      list.sort((a,b)=>(b.used_price_twd??-1)-(a.used_price_twd??-1)); break;
      case "weight_asc":     list.sort((a,b)=>(a.weight??1e12)-(b.weight??1e12)); break;
      case "weight_desc":    list.sort((a,b)=>(b.weight??-1)-(a.weight??-1)); break;
    }

    if (HIDED.checked){
      list = dedupList(list);
    }

    const total=list.length;
    const ps = Number(PAGE_SIZE.value||40);
    const pages = Math.max(1, Math.ceil(total/ps));
    const start = (page-1)*ps, end = start+ps;
    const pageRows = noPaging ? list : list.slice(start,end);

    return {total, pages, pageRows, pagedAll:list};
  }

  function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

  function toggleFav(id){
    if (favs.has(id)) favs.delete(id); else favs.add(id);
    saveFavs(); render();
  }

  // æ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨ï¼ˆä¸Š/ä¸‹å…©è™•ï¼‰
  function renderPagerInto(el, pages){
    const MAX_LINKS = 9;
    el.innerHTML = '';
    const addBtn = (label, target, disabled=false, active=false)=>{
      const b=document.createElement('button');
      b.className='page-btn'+(active?' active':'' );
      b.textContent=label;
      b.disabled=disabled;
      b.onclick=()=>{ if(!disabled){ page=target; render(); scrollToTop(); } };
      el.appendChild(b);
    };
    addBtn('Â« é¦–', 1, page===1);
    addBtn('â€¹ ä¸Š', Math.max(1,page-1), page===1);

    let start = Math.max(1, page - Math.floor(MAX_LINKS/2));
    let end   = Math.min(pages, start + MAX_LINKS - 1);
    start     = Math.max(1, end - MAX_LINKS + 1);

    for(let i=start;i<=end;i++){
      addBtn(String(i), i, false, i===page);
    }
    addBtn('ä¸‹ â€º', Math.min(pages,page+1), page===pages);
    addBtn('æœ« Â»', pages, page===pages);
  }

  function render(){
    const {total, pages, pageRows} = filtered();
    const allFavCount = favs.size;

    STATS.textContent = `ç¸½æ•¸ï¼š${DATA.length}ï½œç›®å‰é¡¯ç¤ºï¼š${total}ï½œæ”¶è—ï¼š${allFavCount}`;
    PAGE_INFO.textContent = `ç¬¬ ${Math.min(page,pages)}/${pages} é `;
    PREV.disabled = (page<=1);
    NEXT.disabled = (page>=pages);

    // åŒæ­¥å…©å€‹åˆ†é åˆ—
    renderPagerInto(PAGER_TOP, pages);
    renderPagerInto(PAGER_BOTTOM, pages);

    G.innerHTML = pageRows.map(x=>{
      const cz = getCatsZh(x);
      const mz = getMechsZh(x);
      const imgSrc = imageSrcOf(x);
      const id = idOf(x);
      const fav = favs.has(id);
      const chosenCat = CAT.value, chosenMech = MECH.value;
      const link = x.link_override || x.bgg_url_override || x.bgg_url || '#';

      return `
      <div class="card">
        <button class="fav-btn ${fav?'active':''}" title="${fav?'å–æ¶ˆæ”¶è—':'åŠ å…¥æ”¶è—'}" data-id="${id}" aria-label="favorite">
          <span class="star">${fav?'â­':'â˜†'}</span>
        </button>

        <img class="poster" loading="lazy" src="${imgSrc}"
             alt="${x.name_zh||x.name_en||''}"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/800?text=No+Image'">

        <h3 style="margin:.5rem 0 0">${x.name_zh||x.name_en||''}</h3>
        ${x.name_en?`<div class="muted">${x.name_en}</div>`:''}

        <div class="chips" aria-label="categories">
          ${cz.map(t=>`<a href="#" class="chip cat" data-cat="${t}">${t===chosenCat?`<b>${t}</b>`:t}</a>`).join('')}
        </div>
        <div class="chips" aria-label="mechanics">
          ${mz.map(t=>`<a href="#" class="chip mech ${t===chosenMech?'active':''}" data-mech="${t}">${t}</a>`).join('')}
        </div>

        <div class="price">
          ${x.price_msrp_twd?`<small>æ–°å“åƒè€ƒåƒ¹ï¼ˆæœªæŠ˜ï¼‰$${x.price_msrp_twd}</small><br>`:''}
          ${x.price_twd?`$${x.price_twd}`:''}
          ${x.used_price_twd?` ï½œäºŒæ‰‹ $${x.used_price_twd}`:''}
        </div>
        ${x._variant_count>1 ? `<div class="muted" style="margin-top:2px"><small>è®Šé«”ï¼š${x._variant_count}</small></div>` : ''}
        ${x.price_note?`<div class="muted" style="margin-top:4px">${x.price_note}</div>`:''}
        ${x.used_note?`<div class="muted" style="margin-top:2px">${x.used_note}</div>`:''}
        ${x.stock?`<div><small>åº«å­˜ï¼š${x.stock}</small></div>`:''}

        <div style="margin-top:6px">
          <a href="${link}" target="_blank" rel="nofollow noopener">BGG</a>
        </div>
      </div>`;
    }).join('');

    // æ”¶è—ï¼chip ç¯©é¸
    G.querySelectorAll('.fav-btn').forEach(btn=>{
      btn.onclick = (e)=>{ e.preventDefault(); toggleFav(btn.dataset.id); };
    });
    G.querySelectorAll('.chip.cat').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault();
        const v=a.dataset.cat;
        if (HOTC.checked){ HOTC.checked=false; buildOptions(); }
        ensureOption(CAT, v); CAT.value=v; page=1; render();
        const url = new URL(location.href); url.searchParams.set('cat', v); url.searchParams.set('page','1');
        history.replaceState(null,"",url);
        scrollToTop();
      };
    });
    G.querySelectorAll('.chip.mech').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault();
        const v=a.dataset.mech;
        if (HOTM.checked){ HOTM.checked=false; buildOptions(); }
        ensureOption(MECH, v); MECH.value=v; page=1; render();
        const url = new URL(location.href); url.searchParams.set('mech', v); url.searchParams.set('page','1');
        history.replaceState(null,"",url);
        scrollToTop();
      };
    });

    // åŒæ­¥ URL çš„ page åƒæ•¸
    const url = new URL(location.href);
    url.searchParams.set('page', String(page));
    history.replaceState(null,"",url);
  }

  /* =========================
     ğŸ” æ™ºæ…§å»ºè­°ï¼ˆæ¨¡ç³Šï¼‹åŒç¾©è©ï¼‰
     ========================= */
  const ALIAS_DICT = {
    "çŸ®äººé‡‘ç¤¦": ["çŸ®äººç¤¦å‘","saboteur"],
    "å‡±äººé‡‘ç¤¦": ["çŸ®äººç¤¦å‘","saboteur"],
    "å¡å¦": ["å¡å¦å³¶","å¡å¦æ‹“è’è€…","settlers of catan","catan"],
    "ç¥¨è»Š": ["è»Šç¥¨ä¹‹æ—…","ticket to ride"],
    "ç’€ç’¨å¯¶çŸ³": ["å¯¶çŸ³é™£","splendor"],
    "å¤§éŒ": ["å¤§éŒæˆ°","scythe"],
    "è¾²å®¶æ¨‚": ["è¾²å ´ä¸»","agricola"]
  };
  function normalizeText(s){
    return String(s||"").toLowerCase().replace(/\s+|[ã€€]/g,"")
      .replace(/[ï¼š:Â·â€¢ï¼.]/g,"").replace(/æ¡Œ[éŠæ¸¸]/g,"").replace(/\(.*?\)|\[.*?\]/g,"");
  }
  function bigrams(s){ const n=[]; for(let i=0;i<s.length-1;i++) n.push(s.slice(i,i+2)); return n; }
  function jaccard(a,b){ const A=new Set(a),B=new Set(b); const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size||1; return inter/uni; }
  function levenshtein(a,b){
    a=normalizeText(a); b=normalizeText(b);
    const m=a.length,n=b.length; if(!m) return n; if(!n) return m;
    const dp=Array(n+1); for(let j=0;j<=n;j++) dp[j]=j;
    for(let i=1;i<=m;i++){
      let prev=dp[0]; dp[0]=i;
      for(let j=1;j<=n;j++){
        const tmp=dp[j];
        dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev + (a[i-1]===b[j-1]?0:1));
        prev=tmp;
      }
    }
    return dp[n];
  }
  function fuzzyScore(q, label){
    const nq=normalizeText(q), nl=normalizeText(label);
    if(!nq || !nl) return 0;
    const lev=levenshtein(nq,nl);
    const levNorm = 1 - (lev/Math.max(nq.length, nl.length));
    const jac=jaccard(bigrams(nq), bigrams(nl));
    return 0.6*levNorm + 0.4*jac;
  }
  function labelsOf(x){
    const arr=[]; if(x.name_zh) arr.push(x.name_zh); if(x.name_en) arr.push(x.name_en);
    if(Array.isArray(x.aliases_zh)) arr.push(...x.aliases_zh);
    return [...new Set(arr.filter(Boolean))];
  }
  function expandedQueries(q){
    const base=[q];
    const alias = ALIAS_DICT[q] || ALIAS_DICT[normalizeText(q)] || [];
    return [...new Set([...base, ...alias])];
  }
  function topMatchesForQuery(q, limit=8){
    const qs=expandedQueries(q);
    const scored = DATA.map(x=>{
      let best=0, bestLabel="";
      const labels=labelsOf(x);
      for(const qq of qs){
        for(const lb of labels){
          const s=fuzzyScore(qq, lb);
          if(s>best){ best=s; bestLabel=lb; }
        }
      }
      return {x, score:best, label:bestLabel};
    }).filter(o=>o.score>=0.35)
      .sort((a,b)=>b.score-a.score)
      .slice(0, limit);
    return scored;
  }

  function positionSuggest(){
    const r = Q.getBoundingClientRect();
    QSUG.style.left = (r.left + window.scrollX) + 'px';
    QSUG.style.top  = (r.bottom + window.scrollY + 4) + 'px';
  }
  function drawQSuggest(){
    const q = Q.value.trim();
    if(!q){ QSUG.classList.add('hidden'); QSUG.innerHTML=''; return; }
    const matches = topMatchesForQuery(q, 7);

    // åµæ¸¬è¼¸å…¥ä¸­çš„æ©Ÿåˆ¶/åˆ†é¡é—œéµå­— â†’ å¿«æ·å¥—ç”¨
    const nz = normalizeText(q);
    const allMechs = new Set(); DATA.forEach(x=>getMechsZh(x).forEach(m=>allMechs.add(m)));
    const allCats  = new Set(); DATA.forEach(x=>getCatsZh(x).forEach(c=>allCats.add(c)));
    const hitMechs = [...allMechs].filter(m=>nz.includes(normalizeText(m))).slice(0,5);
    const hitCats  = [...allCats].filter(c=>nz.includes(normalizeText(c))).slice(0,5);

    const items = matches.map(o=>`
      <a href="#" data-id="${idOf(o.x)}">
        <div>${o.x.name_zh||o.x.name_en||''}</div>
        <div class="meta">${(o.x.name_en||'')}${o.x.name_en?' Â· ':''}${getMechsZh(o.x).slice(0,3).join(' / ')}</div>
      </a>`).join('');

    const ext = `
      <div class="ext">
        <a href="https://www.google.com/search?q=${encodeURIComponent(q+' æ¡ŒéŠ')}" target="_blank" rel="noopener">Googleã€Œ${q} æ¡ŒéŠã€</a>
        <a href="https://boardgamegeek.com/boardgame/search?query=${encodeURIComponent(q)}" target="_blank" rel="noopener">BGGã€Œ${q}ã€</a>
        ${hitMechs.length||hitCats.length ? `<span class="muted">ï½œåµæ¸¬åˆ°é—œéµå­— â†’</span>`:''}
        ${hitMechs.map(m=>`<a href="#" data-kind="m" data-val="${m}">å¥—ç”¨æ©Ÿåˆ¶ï¼š${m}</a>`).join('')}
        ${hitCats.map(c=>`<a href="#" data-kind="c" data-val="${c}">å¥—ç”¨åˆ†é¡ï¼š${c}</a>`).join('')}
      </div>`;

    QSUG.innerHTML = items + ext;
    positionSuggest();
    QSUG.classList.remove('hidden');

    // é»å»ºè­° â†’ å°‡æœå°‹æ¡†å¡«å…¥è©²åå­—ï¼Œä¸¦æ¸²æŸ“
    QSUG.querySelectorAll('a[data-id]').forEach(a=>{
      a.onclick = (e)=>{ e.preventDefault();
        const id=a.getAttribute('data-id');
        const x = DATA.find(g=>idOf(g)===id);
        if(x){
          Q.value = x.name_zh || x.name_en || '';
          page=1; render(); QSUG.classList.add('hidden');
        }
      };
    });
    // ä¸€éµå¥—ç”¨æ©Ÿåˆ¶/åˆ†é¡ â†’ è¨­å®šä¸‹æ‹‰ & æ¸²æŸ“
    QSUG.querySelectorAll('a[data-kind]').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault();
        const kind=a.getAttribute('data-kind'), val=a.getAttribute('data-val');
        if(kind==='m'){ ensureOption(MECH, val); MECH.value=val; }
        if(kind==='c'){ ensureOption(CAT,  val); CAT.value=val;  }
        page=1; render(); QSUG.classList.add('hidden');
      };
    });
  }
  Q.addEventListener('input', ()=>{ drawQSuggest(); });
  window.addEventListener('resize', ()=>{ if(!QSUG.classList.contains('hidden')) positionSuggest(); });
  document.addEventListener('click', (e)=>{
    if(!QSUG.contains(e.target) && e.target!==Q) QSUG.classList.add('hidden');
  });
</script>
</body>
</html>
