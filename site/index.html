<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Board Game Guide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa;
      --chip-bg:#f8fafc; --chip-active:#eef2ff; --chip-active-b:#c7d2fe;
    }
    body{font:16px/1.5 system-ui;margin:20px;background:var(--bg);color:#222}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{position:relative;border:1px solid var(--border);padding:14px;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}

    /* 方形圖片框（完整呈現、不裁切） */
    .poster-box{width:100%;aspect-ratio:1/1;background:#f3f4f6;border-radius:8px;overflow:hidden;position:relative}
    .poster{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#fff}

    .price{font-weight:700;margin-top:6px}
    .price small{font-weight:400;color:var(--muted)}
    input,select,label,button{font:inherit}
    input,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:var(--chip-bg);color:inherit;text-decoration:none;cursor:pointer;user-select:none}
    .chip.active{background:var(--chip-active);border-color:var(--chip-active-b)}
    .muted{color:var(--muted)}
    .checkbox{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}

    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:8px;align-items:center}

    /* 分頁器 */
    .pager{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .page-btn{min-width:34px;text-align:center;border:1px solid var(--border);background:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}
    .page-btn[disabled]{opacity:.5;cursor:default}
    .page-btn.active{font-weight:700;border-color:#a5b4fc;background:#eef2ff}
    .ellipsis{padding:0 4px;color:var(--muted)}
    .goto{display:flex;gap:6px;align-items:center}

    /* 收藏鈕 */
    .fav-btn{
      position:absolute;top:10px;right:10px;
      width:40px;height:40px;display:flex;align-items:center;justify-content:center;
      background:#fff;border:1px solid var(--border);border-radius:999px;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
      cursor:pointer;
    }
    .fav-btn .star{font-size:22px;line-height:1}
    .fav-btn:hover{ transform:scale(1.06); box-shadow:0 4px 14px rgba(0,0,0,.08) }
    .fav-btn.active{ background:#fff7cc; border-color:#facc15 }
  </style>
</head>
<body>

<form class="filters" autocomplete="off" onsubmit="return false">
  <input id="q" name="q_no_autofill"
         placeholder="搜尋：中文名 / EN / 關鍵字" style="min-width:220px"
         autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

  <select id="catSel"><option value="">全部分類</option></select>
  <select id="mechSel"><option value="">全部機制</option></select>

  <input id="pmin" name="pmin_no_autofill" type="number" placeholder="最低價（含二手）"
         autocomplete="off" inputmode="numeric" spellcheck="false">
  <input id="pmax" name="pmax_no_autofill" type="number" placeholder="最高價（含二手）"
         autocomplete="off" inputmode="numeric" spellcheck="false">

  <!-- 預設全部不勾 -->
  <label class="checkbox"><input type="checkbox" id="inclUsed"> 含二手價</label>
  <label class="checkbox"><input type="checkbox" id="hotCat"> 熱門分類（≥10）</label>
  <label class="checkbox"><input type="checkbox" id="hotMech"> 熱門機制（≥10）</label>

  <select id="sort">
    <option value="">排序</option>
    <optgroup label="最低價格（含二手）">
      <option value="min_price_asc">低 → 高</option>
      <option value="min_price_desc">高 → 低</option>
    </optgroup>
    <optgroup label="售價（新品）">
      <option value="price_asc">低 → 高</option>
      <option value="price_desc">高 → 低</option>
    </optgroup>
    <optgroup label="二手價">
      <option value="used_asc">低 → 高</option>
      <option value="used_desc">高 → 低</option>
    </optgroup>
    <optgroup label="策略強度（Weight）">
      <option value="weight_asc">低 → 高</option>
      <option value="weight_desc">高 → 低</option>
    </optgroup>
  </select>
</form>

<div class="bar" id="barTop">
  <span id="stats">總數：0｜目前顯示：0｜收藏：0</span>
  <div class="row">每頁
    <select id="pageSize"><option>15</option><option>20</option><option>25</option><option selected>40</option></select> 筆
  </div>
  <div class="pager" id="pagerTop"></div>
  <div class="goto">到第 <input id="gotoInputTop" type="number" min="1" style="width:80px"> 頁 <button class="btn" id="gotoBtnTop">前往</button></div>
  <label class="checkbox"><input type="checkbox" id="onlyFav"> 只看收藏</label>
  <button id="dlCsv" class="btn">下載 CSV</button>
  <button id="emailFav" class="btn">Email 收藏清單</button>
</div>

<div id="grid" class="grid"></div>

<!-- 底部分頁列 -->
<div class="bar" id="barBottom">
  <div class="pager" id="pagerBottom"></div>
  <div class="goto">到第 <input id="gotoInputBottom" type="number" min="1" style="width:80px"> 頁 <button class="btn" id="gotoBtnBottom">前往</button></div>
</div>

<script>
  document.getElementById('q').setAttribute('name','q_'+Math.random().toString(36).slice(2));

  // ====== 備援映射（後端 *_zh 優先；這只是 fallback）======
  const CAT_MAP = {/* 省略：用你現有那段 CAT_MAP */};
  const MECH_MAP = {
    "Action Points":"行動點","Area Majority / Influence":"區域控制","Area Movement":"區域移動",
    "Auction / Bidding":"競標","Bag Building":"布袋構築","Campaign / Battle Card Driven":"劇本／戰役卡驅動",
    "Card Drafting":"選牌","Card Play Conflict Resolution":"出牌解衝突","Cooperative Game":"合作",
    "Contracts":"合約","Deck Construction":"牌庫構築","Dice Rolling":"擲骰","End Game Bonuses":"終局加分",
    "Grid Movement":"格子移動","Hand Management":"手牌管理","Hidden Movement":"隱藏移動",
    "Line Drawing":"連線","Loans":"借貸","Memory":"記憶","Modular Board":"模組化地圖",
    "Movement Points":"移動點","Network and Route Building":"路網建設","Negotiation":"談判",
    "Open Drafting":"公開選牌","Ownership":"所有權","Pattern Recognition":"圖形辨識",
    "Pick-up and Deliver":"取貨運送","Press Your Luck":"押注碰運氣","Rock-Paper-Scissors":"猜拳",
    "Role Playing":"角色扮演","Scenario / Mission / Campaign Game":"劇本／任務／戰役",
    "Set Collection":"收集套組","Simultaneous Action Selection":"同時選擇行動",
    "Solo / Solitaire Game":"單人","Square Grid":"方格","Take That":"互害",
    "Tile Placement":"板塊擺放","Trading":"交易","Trick-taking":"吃墩","Turn Order: Claim Action":"搶先手",
    "Variable Phase Order":"可變階段順序","Variable Player Powers":"角色能力","Variable Set-up":"可變設置",
    "Worker Placement":"工人放置","Worker Placement with Dice Workers":"骰子工人",
    // 別名補捉
    "Deck, Bag, and Pool Building":"卡／袋／池構築",
    "Deck, Bag and Pool Building":"卡／袋／池構築",
    "Worker Placement, Different Worker Types":"多工種工人放置",
    "Different Worker Types":"不同工種工人"
  };

  // ====== 工具 ======
  const MIN_CAT_COUNT  = 10;
  const MIN_MECH_COUNT = 10;
  const prefix = location.pathname.includes('/site/') ? '../' : '';
  const DATA_URL = prefix + 'data/games_full.json?ts=' + Date.now();

  const G = document.getElementById("grid"),
        Q = document.getElementById("q"),
        CAT = document.getElementById("catSel"),
        MECH = document.getElementById("mechSel"),
        S = document.getElementById("sort"),
        PMIN = document.getElementById("pmin"),
        PMAX = document.getElementById("pmax"),
        INCL = document.getElementById("inclUsed"),
        HOTC = document.getElementById("hotCat"),
        HOTM = document.getElementById("hotMech"),
        ONLYF = document.getElementById("onlyFav"),
        STATS = document.getElementById("stats"),
        PAGE_SIZE = document.getElementById("pageSize"),
        DLCSV = document.getElementById("dlCsv"),
        EMAIL = document.getElementById("emailFav"),
        PAGER_TOP = document.getElementById("pagerTop"),
        PAGER_BOT = document.getElementById("pagerBottom"),
        GOTO_TOP_IN = document.getElementById("gotoInputTop"),
        GOTO_TOP_BTN= document.getElementById("gotoBtnTop"),
        GOTO_BOT_IN = document.getElementById("gotoInputBottom"),
        GOTO_BOT_BTN= document.getElementById("gotoBtnBottom");

  let DATA=[], page=1;

  // 收藏儲存
  const favKey = 'bg_favs';
  const favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
  function saveFavs(){ localStorage.setItem(favKey, JSON.stringify([...favs])); }
  function idOf(x){ return x.id || String(x.bgg_id || (x.name_zh||x.name_en)); }

  // 類別 / 機制中文
  function getCatsZh(x){
    if (Array.isArray(x.categories_zh) && x.categories_zh.length) return x.categories_zh.slice(0,10);
    const en = Array.isArray(x.categories) ? x.categories : [];
    return en.map(s => CAT_MAP[s] || s).slice(0,10);
  }
  function getMechsZh(x){
    if (Array.isArray(x.mechanics_zh) && x.mechanics_zh.length) return x.mechanics_zh.slice();
    const en = Array.isArray(x.mechanics) ? x.mechanics : [];
    const norm = s => (s||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
    return [...new Set(en.map(s => MECH_MAP[norm(s)] || norm(s)))];
  }

  // 價格
  function priceCandidates(x, includeUsed=true){
    const out=[]; if (x.price_twd!=null && x.price_twd!=="") out.push(Number(x.price_twd));
    if (includeUsed && x.used_price_twd!=null && x.used_price_twd!=="") out.push(Number(x.used_price_twd));
    return out;
  }
  function minPrice(x, includeUsed=true){
    const c=priceCandidates(x, includeUsed);
    return c.length? Math.min(...c) : Number.POSITIVE_INFINITY;
  }

  // 匯出
  function downloadCSV(rows){
    const headers = ["name_zh","name_en","categories_zh","mechanics_zh","price_twd","used_price_twd","stock","bgg_url"];
    const lines = [headers.join(",")];
    rows.forEach(x=>{
      const vals = [
        (x.name_zh||"").replace(/,/g,"，"),
        (x.name_en||"").replace(/,/g,"，"),
        (getCatsZh(x).join("/")).replace(/,/g,"，"),
        (getMechsZh(x).join("/")).replace(/,/g,"，"),
        x.price_twd??"", x.used_price_twd??"", x.stock??"", x.bgg_url||""
      ];
      lines.push(vals.join(","));
    });
    const blob = new Blob(["\ufeff"+lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "boardgames.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function emailFavList(rows){
    const body = rows.map((x,i)=>`${i+1}. ${x.name_zh||x.name_en||""}
${x.name_en?`EN: ${x.name_en}\n`:""}分類：${getCatsZh(x).join(" / ")}
機制：${getMechsZh(x).join(" / ")}
價格：${x.price_twd??"-"}｜二手：${x.used_price_twd??"-"}
連結：${x.external_url || x.bgg_url || ""}\n`).join("\n");
    const mailto = `mailto:?subject=${encodeURIComponent("收藏清單")}&body=${encodeURIComponent(body)}`;
    location.href = mailto;
  }

  // ====== 載入資料 ======
  fetch(DATA_URL).then(r=>r.json()).then(d=>{
    DATA=d;
    buildOptions();
    // URL 預設
    const u = new URL(location.href);
    const catQ = u.searchParams.get('cat'), mechQ = u.searchParams.get('mech');
    if (catQ){ HOTC.checked=false; buildOptions(); ensureOption(CAT, catQ); CAT.value=catQ; }
    if (mechQ){ HOTM.checked=false; buildOptions(); ensureOption(MECH, mechQ); MECH.value=mechQ; }
    render();
  });

  function ensureOption(sel, text){
    if (![...sel.options].some(o=>o.value===text)){
      const o=document.createElement('option'); o.value=text; o.textContent=text; sel.appendChild(o);
    }
  }

  function buildOptions(){
    // 分類
    const cCounts=new Map();
    DATA.forEach(x=>getCatsZh(x).forEach(c=>cCounts.set(c,(cCounts.get(c)||0)+1)));
    CAT.innerHTML='<option value="">全部分類</option>';
    [...cCounts.entries()]
      .filter(([n,cnt])=>!HOTC.checked || cnt>=MIN_CAT_COUNT)
      .sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'))
      .forEach(([n])=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; CAT.appendChild(o); });

    // 機制
    const mCounts=new Map();
    DATA.forEach(x=>getMechsZh(x).forEach(m=>mCounts.set(m,(mCounts.get(m)||0)+1)));
    MECH.innerHTML='<option value="">全部機制</option>';
    [...mCounts.entries()]
      .filter(([n,cnt])=>!HOTM.checked || cnt>=MIN_MECH_COUNT)
      .sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'))
      .forEach(([n])=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; MECH.appendChild(o); });
  }

  // 分頁：產生頁碼列（含省略號）
  function renderPager(el, pages, cur){
    const mkBtn = (label, pageNum, disabled=false, active=false)=>{
      const b=document.createElement('button');
      b.className='page-btn'+(active?' active':'');
      b.textContent=label;
      if(disabled){ b.disabled=true; }
      else{ b.addEventListener('click', ()=>{ page=pageNum; render(); window.scrollTo({top:0,behavior:'smooth'});}); }
      return b;
    };
    const addEll = ()=>{ const s=document.createElement('span'); s.className='ellipsis'; s.textContent='…'; el.appendChild(s); };

    el.innerHTML='';
    el.appendChild(mkBtn('‹ 上一頁', Math.max(1,cur-1), cur<=1, false));

    const windowSize = 2; // 目前頁左右各 2
    const show = new Set([1, pages, cur]);
    for(let i=cur-windowSize;i<=cur+windowSize;i++){ if(i>=1 && i<=pages) show.add(i); }
    show.add(2); show.add(pages-1);

    const arr = [...show].sort((a,b)=>a-b);
    for (let i=0;i<arr.length;i++){
      const p = arr[i];
      if (i>0 && arr[i-1]!==p-1) addEll();
      el.appendChild(mkBtn(String(p), p, false, p===cur));
    }

    el.appendChild(mkBtn('下一頁 ›', Math.min(pages,cur+1), cur>=pages, false));
  }

  function hookGoto(inputEl, btnEl, pages){
    btnEl.onclick = ()=>{
      const v = Number(inputEl.value||0);
      if (!v) return;
      const tgt = Math.min(Math.max(1,v), pages);
      page = tgt; render(); window.scrollTo({top:0,behavior:'smooth'});
    }
  }

  [Q,CAT,MECH,S,PMIN,PMAX,INCL,PAGE_SIZE].forEach(el=>el.addEventListener('input',()=>{page=1;render();}));
  [HOTC,HOTM].forEach(el=>el.addEventListener('change',()=>{ buildOptions(); page=1; render(); }));
  ONLYF.addEventListener('change', ()=>{ page=1; render(); });
  DLCSV.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); downloadCSV(pagedAll); });
  EMAIL.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); emailFavList(pagedAll); });

  // 取得篩選後資料（CSV/Email 會用到不分頁）
  function filtered(noPaging=false){
    let list = DATA.slice();

    // 關鍵字
    const q = Q.value.trim().toLowerCase();
    if(q){
      list = list.filter(x=>{
        const blob = [
          x.name_zh||"", x.name_en||"", ...(x.aliases_zh||[]), ...(x.search_keywords||[])
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    // 分類 & 機制（中文）
    const cSel = CAT.value, mSel = MECH.value;
    if(cSel) list = list.filter(x => getCatsZh(x).includes(cSel));
    if(mSel) list = list.filter(x => getMechsZh(x).includes(mSel));

    // 價格
    const includeUsed = INCL.checked;
    const pmin = Number(PMIN.value||0), pmax = Number(PMAX.value||0);
    if (pmin>0 || pmax>0){
      list = list.filter(x=>{
        const cand = priceCandidates(x, includeUsed);
        if (cand.length===0) return false;
        return cand.some(p => (pmin>0 ? p>=pmin : true) && (pmax>0 ? p<=pmax : true));
      });
    }

    // 只看收藏
    if (ONLYF.checked) list = list.filter(x=>favs.has(idOf(x)));

    // 排序（升/降序）
    const sortKey = S.value;
    const cmpNum = (a,b) => (a??1e12) - (b??1e12);
    const cmpNumDesc = (a,b) => (b??-1e12) - (a??-1e12);

    if (sortKey === "min_price_asc")  list.sort((a,b)=> cmpNum( minPrice(a, includeUsed), minPrice(b, includeUsed) ));
    if (sortKey === "min_price_desc") list.sort((a,b)=> cmpNumDesc( minPrice(a, includeUsed), minPrice(b, includeUsed) ));
    if (sortKey === "price_asc")      list.sort((a,b)=> cmpNum(a.price_twd, b.price_twd));
    if (sortKey === "price_desc")     list.sort((a,b)=> cmpNumDesc(a.price_twd, b.price_twd));
    if (sortKey === "used_asc")       list.sort((a,b)=> cmpNum(a.used_price_twd, b.used_price_twd));
    if (sortKey === "used_desc")      list.sort((a,b)=> cmpNumDesc(a.used_price_twd, b.used_price_twd));
    if (sortKey === "weight_asc")     list.sort((a,b)=> cmpNum(a.weight, b.weight));
    if (sortKey === "weight_desc")    list.sort((a,b)=> cmpNumDesc(a.weight, b.weight));

    const total=list.length;
    const ps = Number(PAGE_SIZE.value||40);
    const pages = Math.max(1, Math.ceil(total/ps));
    const start = (page-1)*ps, end = start+ps;
    const pageRows = noPaging ? list : list.slice(start,end);

    return {total, pages, pageRows, pagedAll:list};
  }

  function toggleFav(id){
    if (favs.has(id)) favs.delete(id); else favs.add(id);
    saveFavs(); render();
  }

  function buildImgSrc(x){
    const base = (x.image||'').startsWith('http') ? x.image : (prefix + (x.image||''));
    const key = x.image_version_used || x.image_version_id || x.updated_at || x.bgg_id || '';
    if (!base) return '';
    return base + (base.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(key);
  }

  function render(){
    const {total, pages, pageRows} = filtered();
    STATS.textContent = `總數：${DATA.length}｜目前顯示：${total}｜收藏：${favs.size}`;

    // 分頁器（上/下）
    renderPager(PAGER_TOP, pages, page);
    renderPager(PAGER_BOT, pages, page);
    hookGoto(GOTO_TOP_IN, GOTO_TOP_BTN, pages);
    hookGoto(GOTO_BOT_IN, GOTO_BOT_BTN, pages);

    G.innerHTML = pageRows.map(x=>{
      const cz = getCatsZh(x);
      const mz = getMechsZh(x);
      const imgSrc = buildImgSrc(x) || 'https://via.placeholder.com/800x800?text=No+Image';
      const id = idOf(x);
      const fav = favs.has(id);
      const chosenCat = CAT.value, chosenMech = MECH.value;
      const href = x.external_url || x.bgg_url || '#';
      const linkText = x.external_url ? '介紹' : 'BGG';

      return `
      <div class="card">
        <button class="fav-btn ${fav?'active':''}" title="${fav?'取消收藏':'加入收藏'}" data-id="${id}" aria-label="favorite">
          <span class="star">${fav?'⭐':'☆'}</span>
        </button>

        <span class="poster-box">
          <img class="poster" loading="lazy" src="${imgSrc}" alt="${x.name_zh||x.name_en||''}">
        </span>

        <h3 style="margin:.5rem 0 0">${x.name_zh||x.name_en||''}</h3>
        ${x.name_en?`<div class="muted">${x.name_en}</div>`:''}

        <div class="chips" aria-label="categories">
          ${cz.map(t=>`<a href="#" class="chip cat" data-cat="${t}">${t===chosenCat?`<b>${t}</b>`:t}</a>`).join('')}
        </div>

        <div class="chips" aria-label="mechanics">
          ${mz.map(t=>`<a href="#" class="chip mech ${t===chosenMech?'active':''}" data-mech="${t}">${t}</a>`).join('')}
        </div>

        <div class="price">
          ${x.price_msrp_twd?`<small>新品參考價（未折）$${x.price_msrp_twd}</small><br>`:''}
          ${x.price_twd?`$${x.price_twd}`:''}
          ${x.used_price_twd?` ｜二手 $${x.used_price_twd}`:''}
        </div>
        ${x.price_note?`<div class="muted" style="margin-top:4px">${x.price_note}</div>`:''}
        ${x.used_note?`<div class="muted" style="margin-top:2px">${x.used_note}</div>`:''}
        ${x.stock?`<div><small>庫存：${x.stock}</small></div>`:''}

        <div style="margin-top:6px">
          <a href="${href}" target="_blank" rel="nofollow noopener">${linkText}</a>
        </div>
      </div>`;
    }).join('');

    // 事件代理
    G.querySelectorAll('.fav-btn').forEach(btn=>{
      btn.onclick = (e)=>{ e.preventDefault(); toggleFav(btn.dataset.id); };
    });
    G.querySelectorAll('.chip.cat').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault();
        const v=a.dataset.cat;
        if (HOTC.checked){ HOTC.checked=false; buildOptions(); }
        ensureOption(CAT, v); CAT.value=v; page=1; render();
        history.replaceState(null,"",location.pathname+"?cat="+encodeURIComponent(v));
        window.scrollTo({top:0,behavior:'smooth'});
      };
    });
    G.querySelectorAll('.chip.mech').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault();
        const v=a.dataset.mech;
        if (HOTM.checked){ HOTM.checked=false; buildOptions(); }
        ensureOption(MECH, v); MECH.value=v; page=1; render();
        history.replaceState(null,"",location.pathname+"?mech="+encodeURIComponent(v));
        window.scrollTo({top:0,behavior:'smooth'});
      };
    });
  }
</script>
</body>
</html>
