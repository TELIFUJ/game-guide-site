<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Board Game Guide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font:16px/1.5 system-ui;margin:20px;background:#fafafa;color:#222}
    .filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{border:1px solid #e5e7eb;padding:14px;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card img{width:100%;height:auto;object-fit:contain;background:#f3f4f6;border-radius:8px}
    .row{display:flex;gap:8px;align-items:center}
    .price{font-weight:700;margin-top:6px}
    .price small{font-weight:400;color:#6b7280}
    input,select,label{font:inherit}
    input,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f8fafc}
    .muted{color:#6b7280}
    .checkbox{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
  </style>
</head>
<body>

<form class="filters" autocomplete="off" onsubmit="return false">
  <input id="q" name="q_no_autofill"
         placeholder="搜尋：中文名 / EN / 關鍵字" style="min-width:220px"
         autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

  <select id="cat"><option value="">全部分類</option></select>

  <input id="pmin" name="pmin_no_autofill" type="number" placeholder="最低價（含二手）"
         autocomplete="off" inputmode="numeric" spellcheck="false">
  <input id="pmax" name="pmax_no_autofill" type="number" placeholder="最高價（含二手）"
         autocomplete="off" inputmode="numeric" spellcheck="false">

  <label class="checkbox"><input type="checkbox" id="inclUsed" checked> 含二手價</label>

  <select id="sort">
    <option value="">排序</option>
    <option value="min_price">最低價格（含二手）</option>
    <option value="price">售價（僅新品，低→高）</option>
    <option value="used">二手價（低→高）</option>
    <option value="weight">策略強度（低→高）</option>
  </select>
</form>

<div id="grid" class="grid"></div>

<script>
  // 避免瀏覽器沿用舊自動填入
  document.getElementById('q').setAttribute('name','q_'+Math.random().toString(36).slice(2));

  // 英→中備援映射
  const CAT_MAP = {
    "Economic":"經濟","Trains":"鐵道","Transportation":"交通",
    "Adventure":"冒險","Fantasy":"奇幻","Fighting":"戰鬥","Miniatures":"微縮模型",
    "City Building":"城市建設","Renaissance":"文藝復興","Ancient":"古代",
    "Card Game":"卡牌","Civilization":"文明","Family Game":"家庭","Party Game":"派對",
    "Strategy":"策略","Abstract Strategy":"抽象策略","Science Fiction":"科幻",
    "Thematic":"主題","Negotiation":"談判","Bluffing":"唬人","Deduction":"推理",
    "Wargame":"戰棋","Children's Game":"兒童"
  };

  // 取中文分類：優先 categories_zh，否則映射英文；最多 10 個
  function getCatsZh(x){
    if (Array.isArray(x.categories_zh) && x.categories_zh.length)
      return x.categories_zh.slice(0,10);
    const en = Array.isArray(x.categories) ? x.categories : [];
    return en.map(s => CAT_MAP[s] || s).slice(0,10);
  }

  // 取價格候選（含/不含二手）
  function priceCandidates(x, includeUsed=true){
    const out=[];
    if (x.price_twd!=null && x.price_twd!=="") out.push(Number(x.price_twd));
    if (includeUsed && x.used_price_twd!=null && x.used_price_twd!=="") out.push(Number(x.used_price_twd));
    return out;
  }
  function minPrice(x, includeUsed=true){
    const c=priceCandidates(x, includeUsed);
    return c.length? Math.min(...c) : Number.POSITIVE_INFINITY;
  }

  let DATA=[];
  const G = document.getElementById("grid"),
        Q = document.getElementById("q"),
        C = document.getElementById("cat"),
        S = document.getElementById("sort"),
        PMIN = document.getElementById("pmin"),
        PMAX = document.getElementById("pmax"),
        INCL = document.getElementById("inclUsed");

  // 依所在路徑決定資料路徑
  const prefix = location.pathname.includes('/site/') ? '../' : '';
  const DATA_URL = prefix + 'data/games_full.json?ts=' + Date.now();

  fetch(DATA_URL).then(r=>r.json()).then(d=>{ DATA=d; init(); });

  function init(){
    // 建立中文分類下拉
    const allCats = new Set();
    DATA.forEach(x => getCatsZh(x).forEach(c => allCats.add(c)));
    [...allCats].sort().forEach(c=>{
      const o=document.createElement('option');
      o.value=c; o.textContent=c; C.appendChild(o);
    });

    render();
    [Q,C,S,PMIN,PMAX,INCL].forEach(el=>el.addEventListener('input',render));
  }

  function render(){
    let list = DATA.slice();

    // 關鍵字
    const q = Q.value.trim().toLowerCase();
    if(q){
      list = list.filter(x=>{
        const blob = [
          x.name_zh||"", x.name_en||"",
          ...(x.aliases_zh||[]), ...(x.search_keywords||[])
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    // 分類（中文）
    const chosen = C.value;
    if(chosen){
      list = list.filter(x => getCatsZh(x).includes(chosen));
    }

    // 價格區間（含二手勾選控制）
    const includeUsed = INCL.checked;
    const pmin = Number(PMIN.value||0), pmax = Number(PMAX.value||0);
    if (pmin>0 || pmax>0){
      list = list.filter(x=>{
        const cand = priceCandidates(x, includeUsed);
        if (cand.length===0) return false;
        return cand.some(p => (pmin>0 ? p>=pmin : true) && (pmax>0 ? p<=pmax : true));
      });
    }

    // 排序
    if (S.value==="min_price") list.sort((a,b)=> minPrice(a, INCL.checked) - minPrice(b, INCL.checked));
    if (S.value==="price")     list.sort((a,b)=>(a.price_twd??1e12)-(b.price_twd??1e12));
    if (S.value==="used")      list.sort((a,b)=>(a.used_price_twd??1e12)-(b.used_price_twd??1e12));
    if (S.value==="weight")    list.sort((a,b)=>(a.weight??1e12)-(b.weight??1e12));

    // 卡片
    G.innerHTML = list.map(x => {
      const cz = getCatsZh(x);
      const imgSrc = (x.image||'').startsWith('http') ? x.image : (prefix+(x.image||''));
      return `
        <div class="card">
          <img loading="lazy" src="${imgSrc}"
               alt="${x.name_zh||x.name_en||''}"
               onerror="this.src='https://via.placeholder.com/560x300?text=No+Image'">
          <h3 style="margin:.5rem 0 0">${x.name_zh||x.name_en||''}</h3>
          ${x.name_en?`<div class="muted">${x.name_en}</div>`:''}

          <div class="chips">${cz.map(t=>`<span class="chip">${t}</span>`).join('')}</div>

          <div class="price">
            ${x.price_msrp_twd?`<small>新品參考價（未折）$${x.price_msrp_twd}</small><br>`:''}
            ${x.price_twd?`$${x.price_twd}`:''}
            ${x.used_price_twd?` ｜二手 $${x.used_price_twd}`:''}
          </div>
          ${x.price_note?`<div class="muted" style="margin-top:4px">${x.price_note}</div>`:''}
          ${x.used_note?`<div class="muted" style="margin-top:2px">${x.used_note}</div>`:''}

          <div style="margin-top:6px">
            <a href="${x.bgg_url||'#'}" target="_blank" rel="nofollow noopener">BGG</a>
          </div>
        </div>`;
    }).join('');
  }
</script>
</body>
</html>
