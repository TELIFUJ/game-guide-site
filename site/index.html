<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Board Game Guide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa;
      --chip-bg:#f8fafc; --chip-active:#eef2ff; --chip-active-b:#c7d2fe;
    }
    body{font:16px/1.5 system-ui;margin:20px;background:var(--bg);color:#222}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{position:relative;border:1px solid var(--border);padding:14px;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04); outline:none; cursor:pointer}
    .card:focus-visible{box-shadow:0 0 0 3px #c7d2fe}
    .poster{width:100%;aspect-ratio:1/1;object-fit:contain;background:#f3f4f6;border-radius:8px;display:block}
    .price{font-weight:700;margin-top:6px}
    .price small{font-weight:400;color:var(--muted)}
    input,select,label,button{font:inherit}
    input,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:var(--chip-bg);color:inherit;text-decoration:none;cursor:pointer;user-select:none}
    .chip.active{background:var(--chip-active);border-color:var(--chip-active-b)}
    .muted{color:var(--muted)}
    .checkbox{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .fav-btn{position:absolute;top:10px;right:10px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border);border-radius:999px;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;cursor:pointer}
    .fav-btn .star{font-size:22px;line-height:1}
    .fav-btn:hover{ transform:scale(1.06); box-shadow:0 4px 14px rgba(0,0,0,.08) }
    .fav-btn.active{ background:#fff7cc; border-color:#facc15 }
    .pagination{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:10px 0}
    .page-btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .page-btn.active{background:#eef2ff;border-color:#c7d2fe}
    .page-btn:disabled{opacity:.5;cursor:not-allowed}

    /* Focus + recommendations */
    #focus{margin:16px 0 10px; display:none}
    .focus-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .focus-title{font-weight:700}
    .rec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .reason{margin-top:6px;color:var(--muted);font-size:12px}
    .clear-link{margin-left:auto;color:#2563eb;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:6px 10px;cursor:pointer}

    /* rating / rank badges */
    .badge{display:inline-block;font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:#f3f4f6;margin-right:6px}
    .badge.rank{background:#eef2ff;border-color:#c7d2fe}
    .rating{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:6px 0}
    .rating .score{font-weight:800}

    /* Auto-complete */
    .ac-wrap{position:relative;display:inline-block}
    .ac-list{position:absolute;left:0;top:100%;z-index:1000;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-top:6px;max-height:320px;overflow:auto;min-width:260px;width:100%}
    .ac-item{padding:8px 10px;cursor:pointer;display:flex;gap:8px;align-items:center}
    .ac-item:hover{background:#f5f7ff}
    .ac-sub{font-size:12px;color:var(--muted)}

    /* éš¨æ©Ÿé è¦½ï¼šåº•éƒ¨é¢æ¿ï¼ˆdialogï¼‰ */
    .modal{position:fixed;inset:0;display:none;z-index:1000;background:rgba(0,0,0,.35)}
    .modal[open]{display:block}
    .sheet{
      position:absolute;left:0;right:0;bottom:0;max-height:80vh;
      background:#fff;border-radius:16px 16px 0 0;
      box-shadow:0 -10px 30px rgba(0,0,0,.15);
      padding:12px;overflow:auto;outline:none;
    }
    .sheet-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .sheet-title{font-weight:700}
    .sheet-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
    .sheet .chip{display:flex;align-items:center;gap:6px}
    .sheet .chip input{accent-color:#4f46e5}
    .mech-section-title{font-weight:700;font-size:14px;grid-column:1 / -1;}

    /* è¡Œå‹•ï¼šé ‚éƒ¨åƒ…æœå°‹ã€åº•éƒ¨å·¥å…·åˆ— */
    #activeChips{overflow:auto;white-space:nowrap}
    .mbar{display:none}
    @media (max-width:640px){
      .filters{
        position:sticky; top:0; z-index:50; background:var(--bg);
        padding:10px 0 6px; gap:8px; border-bottom:1px solid var(--border)
      }
      #catSel,#mechSel,#pmin,#pmax,#inclUsed,#sort,#pageSize,#prev,#next,#dlCsv,#emailFav{display:none!important}
      .filters .ac-wrap{flex:1 1 100%; width:100%}
      .mbar{
        position:sticky; bottom:0; left:0; right:0;
        display:flex; gap:8px; align-items:center; justify-content:space-between;
        padding:8px; background:#fff; border-top:1px solid var(--border);
        z-index:60; box-shadow:0 -2px 10px rgba(0,0,0,.05);
        padding-bottom: calc(8px + env(safe-area-inset-bottom))
      }
      .mbar .btn,.mbar select{flex:1 1 25%}
    }
  </style>
</head>
<body>

<form class="filters" autocomplete="off" onsubmit="return false" aria-label="ç¯©é¸åˆ—">
  <div class="ac-wrap" style="min-width:280px;flex:1" aria-label="æœå°‹">
    <input id="q" name="q_no_autofill"
           placeholder="æœå°‹ï¼šä¸­æ–‡å / EN / é—œéµå­—ï¼ˆæ”¯æ´æ¨¡ç³Šï¼‰" style="min-width:280px;width:100%"
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-label="æœå°‹è¼¸å…¥">
    <div id="ac" class="ac-list" style="display:none"></div>
  </div>
  <button id="clearQ" class="btn" type="button" aria-label="æ¸…é™¤æœå°‹">âœ• æ¸…é™¤</button>
  <button id="resetAll" class="btn" type="button" aria-label="é‡ç½®ç¯©é¸">é‡ç½®ç¯©é¸</button>

  <select id="catSel" aria-label="åˆ†é¡"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
  <select id="mechSel" aria-label="æ©Ÿåˆ¶"><option value="">å…¨éƒ¨æ©Ÿåˆ¶</option></select>

  <input id="pmin" name="pmin_no_autofill" type="number" placeholder="æœ€ä½åƒ¹ï¼ˆå«äºŒæ‰‹ï¼‰" inputmode="numeric" aria-label="æœ€ä½åƒ¹ï¼ˆå«äºŒæ‰‹ï¼‰">
  <input id="pmax" name="pmax_no_autofill" type="number" placeholder="æœ€é«˜åƒ¹ï¼ˆå«äºŒæ‰‹ï¼‰" inputmode="numeric" aria-label="æœ€é«˜åƒ¹ï¼ˆå«äºŒæ‰‹ï¼‰">

  <label class="checkbox" for="inclUsed"><input type="checkbox" id="inclUsed"> å«äºŒæ‰‹åƒ¹</label>

  <select id="sort" aria-label="æ’åº">
    <option value="">æ’åº</option>
    <option value="rating_bayes_desc">è©•åˆ†ï¼ˆGeekï¼‰é«˜â†’ä½</option>
    <option value="rating_avg_desc">è©•åˆ†ï¼ˆå¹³å‡ï¼‰é«˜â†’ä½</option>
    <option value="min_price_asc">æœ€ä½åƒ¹æ ¼ï¼ˆå«äºŒæ‰‹ï¼‰ä½â†’é«˜</option>
    <option value="min_price_desc">æœ€ä½åƒ¹æ ¼ï¼ˆå«äºŒæ‰‹ï¼‰é«˜â†’ä½</option>
    <option value="price_asc">å”®åƒ¹ï¼ˆæ–°å“ï¼‰ä½â†’é«˜</option>
    <option value="price_desc">å”®åƒ¹ï¼ˆæ–°å“ï¼‰é«˜â†’ä½</option>
    <option value="weight_asc">ç­–ç•¥å¼·åº¦ ä½â†’é«˜</option>
    <option value="weight_desc">ç­–ç•¥å¼·åº¦ é«˜â†’ä½</option>
  </select>
</form>

<div id="activeChips" class="chips" aria-label="å·²é¸æ¢ä»¶"></div>

<div class="bar" role="toolbar" aria-label="å·¥å…·åˆ—">
  <span id="stats" aria-live="polite">ç¸½æ•¸ï¼š0ï½œç›®å‰é¡¯ç¤ºï¼š0ï½œæ”¶è—ï¼š0</span>

  <div class="row">
    æ¯é 
    <select id="pageSize" aria-label="æ¯é ç­†æ•¸">
      <option>15</option><option>20</option><option>25</option><option selected>40</option>
    </select> ç­†
  </div>

  <div class="row" aria-label="åˆ†é æ§åˆ¶">
    <button id="prev" class="btn" aria-label="ä¸Šä¸€é ">â€¹ ä¸Šä¸€é </button>
    <span id="pageInfo">ç¬¬ 1/1 é </span>
    <button id="next" class="btn" aria-label="ä¸‹ä¸€é ">ä¸‹ä¸€é  â€º</button>
  </div>

  <label class="checkbox"><input type="checkbox" id="onlyFav"> åªçœ‹æ”¶è—</label>
  <label class="checkbox"><input type="checkbox" id="onlyDup"> åªçœ‹é‡è¤‡</label>
  <label class="checkbox"><input type="checkbox" id="hideDup" checked> éš±è—é‡è¤‡ï¼ˆè‡ªå‹•åˆä½µï¼‰</label>

  <button id="openRandom" class="btn" type="button">éš¨æ©Ÿé è¦½ / å¤šé¸æ©Ÿåˆ¶</button>
  <button id="dlCsv" class="btn">ä¸‹è¼‰ CSV</button>
  <button id="emailFav" class="btn">Email æ”¶è—æ¸…å–®</button>
</div>

<div id="focus">
  <div class="focus-head">
    <div class="focus-title">ğŸ” å·²é¸ï¼š<span id="focus-name"></span></div>
    <button id="clearFocus" class="clear-link" type="button">æ¸…é™¤é è¦½</button>
  </div>
  <div id="focus-card" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px"></div>
  <div style="margin:10px 0 6px;font-weight:700">ä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡</div>
  <div id="rec" class="rec-grid"></div>
</div>

<div id="pager" class="pagination" aria-label="pagination"></div>

<div id="empty" class="card" style="display:none;padding:14px">
  <h3 style="margin:0 0 6px">ç›®å‰ç„¡è³‡æ–™</h3>
  <div class="muted">å¯èƒ½åŸå› ï¼šè³‡æ–™å°šæœªç”¢ç”Ÿã€ç¶²è·¯å•é¡Œã€æˆ– API é™æµï¼ˆBGG 401/403/429ï¼‰ã€‚</div>
  <div class="row" style="margin-top:10px">
    <button id="retryLoad" class="btn" type="button">é‡æ–°è¼‰å…¥</button>
    <button id="loadLocal" class="btn" type="button">è¼‰å…¥æœ¬æ©Ÿ JSON</button>
  </div>
  <input id="localFile" type="file" accept="application/json" style="display:none">
</div>

<div id="grid" class="grid" aria-live="polite"></div>

<div id="pager-bottom" class="pagination" aria-label="pagination"></div>

<div id="mbar" class="mbar" aria-label="è¡Œå‹•å·¥å…·åˆ—">
  <button id="mRandom" class="btn" type="button">éš¨æ©Ÿ</button>
  <button id="mFilter" class="btn" type="button">å¤šé¸æ©Ÿåˆ¶</button>
  <select id="mSort" aria-label="æ’åº">
    <option value="">æ’åº</option>
    <option value="rating_bayes_desc">è©•åˆ†ï¼ˆGeekï¼‰é«˜â†’ä½</option>
    <option value="rating_avg_desc">è©•åˆ†ï¼ˆå¹³å‡ï¼‰é«˜â†’ä½</option>
    <option value="min_price_asc">æœ€ä½åƒ¹æ ¼ï¼ˆå«äºŒæ‰‹ï¼‰ä½â†’é«˜</option>
    <option value="min_price_desc">æœ€ä½åƒ¹æ ¼ï¼ˆå«äºŒæ‰‹ï¼‰é«˜â†’ä½</option>
    <option value="price_asc">å”®åƒ¹ï¼ˆæ–°å“ï¼‰ä½â†’é«˜</option>
    <option value="price_desc">å”®åƒ¹ï¼ˆæ–°å“ï¼‰é«˜â†’ä½</option>
    <option value="weight_asc">ç­–ç•¥å¼·åº¦ ä½â†’é«˜</option>
    <option value="weight_desc">ç­–ç•¥å¼·åº¦ é«˜â†’ä½</option>
  </select>
  <button id="mClear" class="btn" type="button">é‡ç½®</button>
</div>

<dialog id="randModal" class="modal" aria-hidden="true">
  <div class="sheet" tabindex="-1">
    <div class="sheet-head">
      <div class="sheet-title">éš¨æ©Ÿé è¦½ / å¤šé¸æ©Ÿåˆ¶</div>
      <button id="randClose" class="btn" type="button">é—œé–‰</button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <input id="mechSearch" type="search" placeholder="æœå°‹æ©Ÿåˆ¶..." style="flex:1">
      <button id="randClear" class="btn" type="button">æ¸…é™¤æ©Ÿåˆ¶</button>
      <button id="randPick" class="btn" type="button">é‡æ–°éš¨æ©Ÿ</button>
      <button id="randApply" class="btn" type="button">å¥—ç”¨æ¢ä»¶</button>
    </div>
    <div id="mechMulti" class="sheet-grid" aria-label="å¤šé¸æ©Ÿåˆ¶"></div>
    <div style="margin-top:12px">
      <div class="sheet-title" style="margin-bottom:4px">éš¨æ©Ÿé è¦½çµæœ</div>
      <div id="randGrid" class="sheet-grid"></div>
    </div>
  </div>
</dialog>

<script>
  // é˜²æ­¢ç€è¦½å™¨è‡ªå‹•å¡«ï¼šname å‹•æ…‹åŒ–
  document.getElementById('q').setAttribute('name','q_'+Math.random().toString(36).slice(2));

  // â€”â€” Base / è·¯å¾‘å®¹éŒ¯ï¼šåŒæ™‚æ”¯æ´ /repo/ èˆ‡ /repo/site/ï¼Œä¸”å˜—è©¦ /data èˆ‡ /site/data â€”â€” //
  const BASE = (location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, ''));
  const REPO_ROOT = (()=>{ const parts = location.pathname.split('/').filter(Boolean); return parts.length ? ('/' + parts[0] + '/') : '/'; })();
  function absUrl(p){ if(!p) return ''; if(/^https?:\/\//i.test(p)) return p; return (BASE + String(p).replace(/^\/+/, '')); }
  const urlParam = new URL(location.href).searchParams.get('data');
  const DATA_CANDIDATES = [ urlParam ? absUrl(urlParam) : null, absUrl('data/games.json'), REPO_ROOT + 'site/data/games.json', REPO_ROOT + 'data/games.json' ].filter(Boolean);

  // â€”â€” ENâ†’ZH æ˜ å°„ï¼ˆå¸¸è¦‹é …ï¼›å…¶é¤˜ç”± CSV æ­£è¦åŒ–ç”¢ç”Ÿï¼‰ â€”â€” //
  const CAT_MAP = { "Abstract Strategy":"æŠ½è±¡ç­–ç•¥","Action / Dexterity":"å‹•ä½œï¼æ•æ·","Adventure":"å†’éšª","Animals":"å‹•ç‰©","Card Game":"å¡ç‰Œ","Children's Game":"å…’ç«¥","City Building":"åŸå¸‚å»ºè¨­","Civilization":"æ–‡æ˜","Deduction":"æ¨ç†","Dice":"éª°å­","Economic":"ç¶“æ¿Ÿ","Educational":"æ•™è‚²","Fantasy":"å¥‡å¹»","Horror":"ææ€–","Party Game":"æ´¾å°","Puzzle":"ç›Šæ™ºï¼æ‹¼åœ–","Racing":"ç«¶é€Ÿ","Science Fiction":"ç§‘å¹»","Sports":"é‹å‹•","Wargame":"æˆ°æ£‹","Word Game":"å­—è©" };
  const MECH_MAP = {
    "Action Points":"è¡Œå‹•é»","Area Majority / Influence":"å€åŸŸæ§åˆ¶","Area Movement":"å€åŸŸç§»å‹•","Auction / Bidding":"ç«¶æ¨™",
    "Bag Building":"å¸ƒè¢‹æ§‹ç¯‰","Card Drafting":"é¸ç‰Œ","Cooperative Game":"åˆä½œ","Deck Construction":"ç‰Œåº«æ§‹ç¯‰","Dice Rolling":"æ“²éª°",
    "End Game Bonuses":"çµ‚å±€åŠ åˆ†","Grid Movement":"æ ¼å­ç§»å‹•","Hand Management":"æ‰‹ç‰Œç®¡ç†","Hidden Movement":"éš±è—ç§»å‹•",
    "Modular Board":"æ¨¡çµ„åŒ–åœ°åœ–","Network and Route Building":"è·¯ç¶²å»ºè¨­","Negotiation":"è«‡åˆ¤","Open Drafting":"å…¬é–‹é¸ç‰Œ",
    "Pick-up and Deliver":"å–è²¨é‹é€","Press Your Luck":"ç¢°é‹æ°£","Set Collection":"æ”¶é›†å¥—çµ„","Simultaneous Action Selection":"åŒæ™‚é¸æ“‡è¡Œå‹•",
    "Tile Placement":"æ¿å¡Šæ“ºæ”¾","Trading":"äº¤æ˜“","Trick-taking":"åƒå¢©","Variable Player Powers":"è§’è‰²èƒ½åŠ›",
    "Worker Placement":"å·¥äººæ”¾ç½®","Worker Placement with Dice Workers":"éª°å­å·¥äºº",
    "Deck, Bag, and Pool Building":"å¡ï¼è¢‹ï¼æ± æ§‹ç¯‰","Different Worker Types":"ä¸åŒå·¥ç¨®å·¥äºº","Worker Placement, Different Worker Types":"å¤šå·¥ç¨®å·¥äººæ”¾ç½®"
  };

  // â€”â€” DOM â€”â€” //
  const G = document.getElementById("grid"),
        Q = document.getElementById("q"),
        AC = document.getElementById("ac"),
        CAT = document.getElementById("catSel"),
        MECH = document.getElementById("mechSel"),
        S = document.getElementById("sort"),
        PMIN = document.getElementById("pmin"),
        PMAX = document.getElementById("pmax"),
        INCL = document.getElementById("inclUsed"),
        ONLYF = document.getElementById("onlyFav"),
        ONLY_DUP = document.getElementById("onlyDup"),
        HIDED = document.getElementById("hideDup"),
        STATS = document.getElementById("stats"),
        PAGE_SIZE = document.getElementById("pageSize"),
        PREV = document.getElementById("prev"),
        NEXT = document.getElementById("next"),
        PAGE_INFO = document.getElementById("pageInfo"),
        DLCSV = document.getElementById("dlCsv"),
        EMAIL = document.getElementById("emailFav"),
        PAGER_TOP = document.getElementById("pager"),
        PAGER_BOTTOM = document.getElementById("pager-bottom"),
        FOCUS = document.getElementById("focus"),
        FOCUS_NAME = document.getElementById("focus-name"),
        FOCUS_CARD = document.getElementById("focus-card"),
        REC = document.getElementById("rec"),
        CLEAR_FOCUS = document.getElementById("clearFocus"),
        ACTIVE_CHIPS = document.getElementById("activeChips"),
        EMPTY = document.getElementById("empty"),
        RETRY_BTN = document.getElementById("retryLoad"),
        LOADLOCAL_BTN = document.getElementById("loadLocal"),
        LOCAL_FILE = document.getElementById("localFile");

  const MBAR = document.getElementById('mbar');
  const MSORT = document.getElementById('mSort');
  const MFILTER = document.getElementById('mFilter');
  const MRANDOM = document.getElementById('mRandom');
  const MCLEAR  = document.getElementById('mClear');

  const RAND = document.getElementById('randModal');
  const RAND_CLOSE = document.getElementById('randClose');
  const RAND_APPLY = document.getElementById('randApply');
  const RAND_CLEAR = document.getElementById('randClear');
  const RAND_PICK  = document.getElementById('randPick');
  const RAND_GRID  = document.getElementById('randGrid');
  const RAND_MECHS = document.getElementById('mechMulti');
  const OPEN_RANDOM = document.getElementById('openRandom');
  const MECH_SEARCH = document.getElementById('mechSearch');

  // â€”â€” State â€”â€” //
  let DATA=[], page=1;
  const favKey = `bg_favs_${location.pathname.split('/')[1] || 'root'}`;
  const favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
  function saveFavs(){ localStorage.setItem(favKey, JSON.stringify([...favs])); }
  function idOf(x){ return x.id || String(x.bgg_id || (x.name_zh||x.name_en)); }

  // â€”â€” åŒç¾©éµå·¥å…· â€”â€” //
  const arr = v => Array.isArray(v) ? v : (v==null ? [] : [v]);
  const num = v => (v==null||v==="") ? null : Number(v);
  function usersRated(x){ return num(x.users_rated ?? x.usersrated); }
  function ratingAvg(x){ return (typeof x.rating_avg === 'number') ? x.rating_avg : (typeof x.rating === 'number' ? x.rating : null); }
  function ratingBayes(x){ return (typeof x.rating_bayes === 'number') ? x.rating_bayes : null; }

  // ä¸­æ–‡åå­˜åœ¨å„ªå…ˆ
  const CJK_RE = /[\u4E00-\u9FFF\u3400-\u4DBF]/;
  function hasZhName(x){ const s = (x.name_zh||'') + ' ' + (x.name_en||''); return CJK_RE.test(s); }

  // åˆ†é¡/æ©Ÿåˆ¶ï¼ˆæ”¯æ´ mechanisms / mechanicsï¼‰
  function getCatsZh(x){
    const en = Array.isArray(x.categories) ? x.categories : [];
    return en.map(s => CAT_MAP[s] || s);
  }
  function getMechsEnRaw(x){
    const m1 = Array.isArray(x.mechanisms) ? x.mechanisms : [];
    const m2 = Array.isArray(x.mechanics)  ? x.mechanics  : [];
    return m1.length ? m1 : m2;
  }
  function getMechsZh(x){
    if (Array.isArray(x.mechanics_zh) && x.mechanics_zh.length) return x.mechanics_zh.slice();
    const en = getMechsEnRaw(x);
    const normalize = s => (String(s||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim());
    return [...new Set(en.map(s => { const n = normalize(s); return MECH_MAP[n] || n; }))];
  }

  // åƒ¹æ ¼ / æ’åºè¼”åŠ©
  function priceCandidates(x, includeUsed=true){
    const out=[]; if (x.price_twd!=null && x.price_twd!=="") out.push(Number(x.price_twd));
    if (includeUsed && x.used_price_twd!=null && x.used_price_twd!=="") out.push(Number(x.used_price_twd));
    return out;
  }
  function minPrice(x, includeUsed=true){
    const c=priceCandidates(x, includeUsed);
    return c.length? Math.min(...c) : Number.POSITIVE_INFINITY;
  }

  // è©•åˆ†å¾½ç« 
  function ratingBadgeHtml(x){
    const va = ratingAvg(x), vb = ratingBayes(x), ur = usersRated(x);
    const a = (va!=null) ? `<span class="badge"><b class="score">${va.toFixed(1)}</b>/10</span>` : '';
    const b = (vb!=null) ? `<span class="badge">Geek ${vb.toFixed(1)}</span>` : '';
    const u = (ur!=null) ? `<span class="badge">${ur} è©•</span>` : '';
    return a + b + u;
  }

  // å½±åƒä¾†æºï¼šæœ¬åœ°å„ªå…ˆ â†’ image_local â†’ image_url/thumbnail â†’ æœ€å¾Œ placeholder
  function imgCandidates(x){
    const cand = [];
    if (x.image_override) cand.push(x.image_override);
    if (x.image && !/^https?:/i.test(x.image)) cand.push(x.image);
    if (x.image_local) cand.push(x.image_local);
    if (x.image_url) cand.push(x.image_url);
    if (x.thumb_url) cand.push(x.thumb_url);
    if (x.image && /^https?:/i.test(x.image)) cand.push(x.image);
    return cand.filter(Boolean).map(absUrl);
  }
  function imgFallback(el){
    const list = (el.dataset.srcs||'').split('|').filter(Boolean);
    const cur = el.getAttribute('src');
    const idx = list.indexOf(cur);
    const next = list[idx+1];
    if (next){ el.src = next; }
    else { el.onerror=null; el.src='https://via.placeholder.com/800?text=No+Image'; }
  }

  // ç‹€æ…‹ + é¸å–®å»ºç½®
  let MECH_MULTI = new Set();
  function ensureOption(sel, text){
    if (![...sel.options].some(o=>o.value===text)){
      const o=document.createElement('option'); o.value=text; o.textContent=text; sel.appendChild(o);
    }
  }
  function buildOptions(){
    // åˆ†é¡
    const cCounts=new Map();
    DATA.forEach(x=>getCatsZh(x).forEach(c=>cCounts.set(c,(cCounts.get(c)||0)+1)));
    const catVal = CAT.value;
    CAT.innerHTML='<option value="">å…¨éƒ¨åˆ†é¡</option>';
    [...cCounts.entries()].sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'))
      .forEach(([n,cnt])=>{ const o=document.createElement('option'); o.value=n; o.textContent=`${n} (${cnt})`; CAT.appendChild(o); });
    if (catVal && ![...CAT.options].some(o=>o.value===catVal)){ const o=document.createElement('option'); o.value=catVal; o.textContent=`${catVal} (0)`; CAT.appendChild(o); }
    CAT.value = catVal;

    // æ©Ÿåˆ¶
    const mCounts=new Map();
    DATA.forEach(x=>getMechsZh(x).forEach(m=>mCounts.set(m,(mCounts.get(m)||0)+1)));
    const mechVal = MECH.value;
    MECH.innerHTML='<option value="">å…¨éƒ¨æ©Ÿåˆ¶</option>';
    [...mCounts.entries()].sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'))
      .forEach(([n,cnt])=>{ const o=document.createElement('option'); o.value=n; o.textContent=`${n} (${cnt})`; MECH.appendChild(o); });
    if (mechVal && ![...MECH.options].some(o=>o.value===mechVal)){ const o=document.createElement('option'); o.value=mechVal; o.textContent=`${mechVal} (0)`; MECH.appendChild(o); }
    MECH.value = mechVal;
  }

  function clearMultiSelect(){
    MECH_MULTI = new Set();
    if (RAND_MECHS) RAND_MECHS.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
    if (RAND_GRID) RAND_GRID.innerHTML='';
  }

  // åŸºç¤éæ¿¾
  function filteredBase({ignoreCat=false, ignoreMech=false}={}){
    let list = DATA.slice();
    const q = Q.value.trim().toLowerCase();
    if(q){
      list = list.filter(x=>{
        const blob = [x.name_zh||"", x.name_en||"", ...(x.aliases_zh||[]), ...arr(x.search_keywords)].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }
    if(!ignoreCat && CAT.value){ list = list.filter(x => getCatsZh(x).includes(CAT.value)); }
    if(!ignoreMech && MECH.value){ list = list.filter(x => getMechsZh(x).includes(MECH.value)); }
    if (MECH_MULTI.size){ list = list.filter(x=> getMechsZh(x).some(m=>MECH_MULTI.has(m))); }

    const includeUsed = INCL.checked;
    const pmin = Number(PMIN.value||0), pmax = Number(PMAX.value||0);
    if (pmin>0 || pmax>0){
      list = list.filter(x=>{
        const cand = priceCandidates(x, includeUsed);
        if (cand.length===0) return false;
        return cand.some(p => (pmin? p>=pmin : true) && (pmax? p<=pmax : true));
      });
    }
    if (ONLYF.checked){ list = list.filter(x=>favs.has(idOf(x))); }

    if (HIDED.checked){ list = dedupList(list); }
    if (ONLY_DUP.checked){ if (!HIDED.checked) list = dedupList(list); list = list.filter(x => x._variant_count > 1); }
    return list;
  }

  function normalizeImgUrl(s){ s = String(s||'').toLowerCase(); s = s.replace(/^https?:\/\/[^/]+/, ''); s = s.replace(/[?#].*$/, ''); return s; }
  function dupKey(x){
    return [ x.bgg_id || '', (x.name_zh || x.name_en || '').trim().toLowerCase(), normalizeImgUrl(x.image_override || x.image || x.image_url || x.thumb_url || '') ].join('|');
  }
  function isBetter(a,b){
    const ao = !!a.image_override, bo = !!b.image_override;
    if (ao !== bo) return ao;
    const ap = a.price_twd ?? Infinity, bp = b.price_twd ?? Infinity;
    if (ap !== bp) return ap < bp;
    const as = a.stock ?? -1, bs = b.stock ?? -1;
    if (as !== bs) return as > bs;
    return false;
  }
  function dedupList(list){
    const pick = new Map();
    const counts = new Map();
    for (const x of list){
      const k = dupKey(x);
      const cur = pick.get(k);
      if (!cur || isBetter(x, cur)) pick.set(k, x);
      counts.set(k, (counts.get(k)||0)+1);
    }
    const out = [];
    for (const [k, x] of pick.entries()){
      const clone = {...x};
      clone._variant_count = counts.get(k)||1;
      out.push(clone);
    }
    return out;
  }

  // æ’åº
  function compareWithChinesePriority(a,b, secondaryCmp){
    const z = (hasZhName(b) - hasZhName(a));
    if (z) return z;
    const s = secondaryCmp(a,b); if (s) return s;
    const r1 = (ratingBayes(b)??-1) - (ratingBayes(a)??-1); if (r1) return r1;
    const r2 = (ratingAvg(b)??-1)  - (ratingAvg(a)??-1);  if (r2) return r2;
    const r3 = (a.rank_overall??1e9) - (b.rank_overall??1e9); if (r3) return r3;
    return String((a.name_zh||a.name_en||'')).localeCompare((b.name_zh||b.name_en||''), 'zh-Hant');
  }
  function filtered(noPaging=false){
    let list = filteredBase();
    const includeUsedForSort = INCL.checked;
    const cmpMap = {
      "min_price_asc":  (a,b)=> minPrice(a, includeUsedForSort) - minPrice(b, includeUsedForSort),
      "min_price_desc": (a,b)=> minPrice(b, includeUsedForSort) - minPrice(a, includeUsedForSort),
      "price_asc":      (a,b)=> (a.price_twd??1e12) - (b.price_twd??1e12),
      "price_desc":     (a,b)=> (b.price_twd??-1)    - (a.price_twd??-1),
      "used_asc":       (a,b)=> (a.used_price_twd??1e12) - (b.used_price_twd??1e12),
      "used_desc":      (a,b)=> (b.used_price_twd??-1)    - (a.used_price_twd??-1),
      "weight_asc":     (a,b)=> (a.weight??1e12) - (b.weight??1e12),
      "weight_desc":    (a,b)=> (b.weight??-1)    - (a.weight??-1),
      "rating_avg_desc":(a,b)=> (ratingAvg(b) ?? -1) - (ratingAvg(a) ?? -1),
      "rating_bayes_desc":(a,b)=> (ratingBayes(b) ?? -1) - (ratingBayes(a) ?? -1),
      "":               (a,b)=> 0
    };
    const sec = cmpMap[S.value || ""];
    list.sort((a,b)=>compareWithChinesePriority(a,b, sec));

    const total=list.length;
    const ps = Number(PAGE_SIZE.value||40);
    const pages = Math.max(1, Math.ceil(total/ps));
    const start = (page-1)*ps, end = start+ps;
    const pageRows = noPaging ? list : list.slice(start,end);
    return {total, pages, pageRows, pagedAll:list};
  }

  // å¡ç‰‡æ¸²æŸ“
  function playersText(x){
    const p = Array.isArray(x.players)? x.players : [];
    if (p[0] && p[1]) return `${p[0]}â€“${p[1]}äºº`;
    return '';
  }
  function timeText(x){
    const a = x.min_playtime ?? x.minplaytime;
    const b = x.max_playtime ?? x.maxplaytime;
    if (a && b) return `${a}â€“${b}åˆ†`;
    if (a) return `${a}åˆ†`;
    if (b) return `${b}åˆ†`;
    return '';
  }
  function cardHtml(x){
    const cz = getCatsZh(x);
    const mz = getMechsZh(x);
    const id = idOf(x);
    const fav = favs.has(id);
    const chosenCat = CAT.value, chosenMech = MECH.value;
    const link = x.link_override || x.bgg_url_override || x.bgg_url || '#';
    const rank = x.rank_overall;
    const ppl = playersText(x);
    const tminmax = timeText(x);
    const srcs = imgCandidates(x);
    const first = srcs[0] || 'https://via.placeholder.com/800?text=No+Image';

    return `
      <div class="card" data-id="${id}">
        <button class="fav-btn ${fav?'active':''}" title="${fav?'å–æ¶ˆæ”¶è—':'åŠ å…¥æ”¶è—'}" data-id="${id}" aria-label="favorite" type="button">
          <span class="star">${fav?'â­':'â˜†'}</span>
        </button>

        <img class="poster" loading="lazy" src="${first}" data-srcs="${srcs.join('|')}"
             alt="${x.name_zh||x.name_en||''}" onerror="imgFallback(this)">

        <h3 style="margin:.5rem 0 0">${x.name_zh||x.name_en||''}</h3>
        ${x.name_en?`<div class="muted">${x.name_en}</div>`:''}

        <div class="rating">
          ${ratingBadgeHtml(x)}
          ${rank? `<span class="badge rank">RANK #${rank}</span>`:''}
          ${x.weight? `<span class="badge">ç­–ç•¥å¼·åº¦ ${Number(x.weight).toFixed(2)}</span>`:''}
          ${ppl? `<span class="badge">${ppl}</span>`:''}
          ${tminmax? `<span class="badge">${tminmax}</span>`:''}
        </div>

        <div class="chips" aria-label="categories">
          ${cz.slice(0,10).map(t=>`<a href="#" class="chip cat" data-cat="${t}">${t===chosenCat?`<b>${t}</b>`:t}</a>`).join('')}
        </div>
        <div class="chips" aria-label="mechanics">
          ${mz.map(t=>`<a href="#" class="chip mech ${t===chosenMech?'active':''}" data-mech="${t}">${t}</a>`).join('')}
        </div>

        <div class="price">
          ${x.price_msrp_twd?`<small>æ–°å“åƒè€ƒåƒ¹ï¼ˆæœªæŠ˜ï¼‰$${x.price_msrp_twd}</small><br>`:''}
          ${x.price_twd?`$${x.price_twd}`:''}
          ${x.used_price_twd?` ï½œäºŒæ‰‹ $${x.used_price_twd}`:''}
        </div>
        ${x._variant_count>1 ? `<div class="muted" style="margin-top:2px"><small>è®Šé«”ï¼š${x._variant_count}</small></div>` : ''}
        ${x.price_note?`<div class="muted" style="margin-top:4px">${x.price_note}</div>`:''}
        ${x.used_note?`<div class="muted" style="margin-top:2px">${x.used_note}</div>`:''}

        <div style="margin-top:6px">
          <a href="${link}" target="_blank" rel="nofollow noopener">BGG</a>
        </div>
      </div>`;
  }

  function renderPagerInto(el, pages){
    const MAX_LINKS = 9;
    el.innerHTML = '';
    const addBtn = (label, target, disabled=false, active=false)=>{
      const b=document.createElement('button');
      b.className='page-btn'+(active?' active':'' );
      b.textContent=label;
      b.disabled=disabled;
      b.onclick=()=>{ if(!disabled){ page=target; render(); window.scrollTo({top:0,behavior:'smooth'}); } };
      el.appendChild(b);
    };
    addBtn('Â« é¦–', 1, page===1);
    addBtn('â€¹ ä¸Š', Math.max(1,page-1), page===1);
    let start = Math.max(1, page - Math.floor(MAX_LINKS/2));
    let end   = Math.min(pages, start + MAX_LINKS - 1);
    start     = Math.max(1, end - MAX_LINKS + 1);
    for(let i=start;i<=end;i++){ addBtn(String(i), i, false, i===page); }
    addBtn('ä¸‹ â€º', Math.min(pages,page+1), page===pages);
    addBtn('æœ« Â»', pages, page===pages);
  }

  function renderActiveChips(){
    const chips = [];
    if (CAT.value){
      chips.push({k:'cat',text:`åˆ†é¡ï¼š${CAT.value}`,onClear:()=>{CAT.value=''; buildOptions(); render();}});
    }
    if (MECH.value){
      chips.push({k:'mech',text:`æ©Ÿåˆ¶ï¼š${MECH.value}`,onClear:()=>{MECH.value=''; buildOptions(); render();}});
    }
    if (MECH_MULTI && MECH_MULTI.size){
      const list = [...MECH_MULTI];
      const previewList = list.slice(0,3).join('ï¼');
      const more = (list.length > 3) ? `â€¦+${list.length-3}` : '';
      chips.push({k:'multi',text:`å¤šæ©Ÿåˆ¶ï¼š${previewList}${more}`,onClear:()=>{ clearMultiSelect(); render(); }});
    }
    if (INCL.checked){ chips.push({k:'used',text:'å«äºŒæ‰‹åƒ¹',onClear:()=>{INCL.checked=false; render();}}); }
    if (PMIN.value || PMAX.value){ chips.push({k:'price',text:`åƒ¹æ ¼${PMIN.value||''}â€“${PMAX.value||''}`,onClear:()=>{PMIN.value=''; PMAX.value=''; render();}}); }
    if (ONLY_DUP.checked){ chips.push({k:'duponly',text:'åªçœ‹é‡è¤‡',onClear:()=>{ONLY_DUP.checked=false; render();}}); }

    ACTIVE_CHIPS.innerHTML = chips.map(c=>`<a href="#" class="chip" data-k="${c.k}" role="button">${c.text} Ã—</a>`).join('');
    ACTIVE_CHIPS.querySelectorAll('.chip').forEach(el=>{
      el.addEventListener('click',(e)=>{ e.preventDefault(); const k=el.dataset.k; const item=chips.find(x=>x.k===k); if(item) item.onClear(); });
    });
  }

  function render(){
    const {total, pages, pageRows} = filtered();
    STATS.textContent = `ç¸½æ•¸ï¼š${DATA.length}ï½œç›®å‰é¡¯ç¤ºï¼š${total}ï½œæ”¶è—ï¼š${favs.size}`;
    PAGE_INFO.textContent = `ç¬¬ ${page}/${pages} é `;
    renderPagerInto(PAGER_TOP, pages);
    renderPagerInto(PAGER_BOTTOM, pages);
    renderActiveChips();
    G.innerHTML = pageRows.map(cardHtml).join('');

    // ç¶å®šå¡ç‰‡äº’å‹•
    G.querySelectorAll('.fav-btn').forEach(btn=>{
      btn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); const id=btn.dataset.id; if (favs.has(id)) favs.delete(id); else favs.add(id); saveFavs(); render(); };
    });
    G.querySelectorAll('.chip.cat').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); const v=a.dataset.cat; ensureOption(CAT,v); CAT.value=v; page=1; buildOptions(); render(); };
    });
    G.querySelectorAll('.chip.mech').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); const v=a.dataset.mech; ensureOption(MECH,v); MECH.value=v; page=1; buildOptions(); render(); };
    });
    G.querySelectorAll('.card').forEach(c=>{
      c.addEventListener('click',(e)=>{
        if (e.target.closest('.fav-btn') || e.target.closest('.chip') || e.target.closest('a')) return;
        const id = c.dataset.id;
        const item = DATA.find(x=>idOf(x)===id);
        if(item){ showFocus(item); window.scrollTo({top:0,behavior:'smooth'}); }
      });
    });
  }

  function showFocus(seed){
    FOCUS_NAME.textContent = seed.name_zh || seed.name_en || '';
    FOCUS_CARD.innerHTML = cardHtml(seed);
    const sims = similarFor(seed, 5);
    const cards = sims.map(o=>{
      const x=o.x;
      const reasonBits=[];
      if(o.commonM.length) reasonBits.push(`å…±é€šæ©Ÿåˆ¶ï¼š${o.commonM.slice(0,3).join("ã€")}`);
      if(o.commonC.length) reasonBits.push(`å…±é€šåˆ†é¡ï¼š${o.commonC.slice(0,3).join("ã€")}`);
      const reason = reasonBits.length? `<div class="reason">${reasonBits.join("ã€€")}</div>` : '';
      return `<div>${cardHtml(x)}${reason}</div>`;
    }).join('');
    REC.innerHTML = cards;
    FOCUS.style.display='block';

    // Focus å€äº’å‹•
    FOCUS.querySelectorAll('.fav-btn').forEach(btn=>{
      btn.onclick = (e)=>{ e.preventDefault(); const id=btn.dataset.id; if (favs.has(id)) favs.delete(id); else favs.add(id); saveFavs(); render(); showFocus(seed); };
    });
    FOCUS.querySelectorAll('.chip.cat').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); const v=a.dataset.cat; ensureOption(CAT, v); CAT.value=v; page=1; buildOptions(); render(); };
    });
    FOCUS.querySelectorAll('.chip.mech').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); const v=a.dataset.mech; ensureOption(MECH, v); MECH.value=v; page=1; buildOptions(); render(); };
    });
    FOCUS.querySelectorAll('#rec .card').forEach(c=>{
      c.addEventListener('click',(e)=>{
        if (e.target.closest('.fav-btn') || e.target.closest('.chip') || e.target.closest('a')) return;
        const id = c.dataset.id;
        const item = DATA.find(x=>idOf(x)===id);
        if(item){ showFocus(item); }
      });
    });
  }
  function clearFocus(resetQuery=true){
    if(resetQuery){ Q.value=''; }
    FOCUS.style.display='none';
    FOCUS_CARD.innerHTML=''; REC.innerHTML='';
    render();
  }

  function jaccard(aArr,bArr){ const A = new Set(aArr), B = new Set(bArr); if(!A.size && !B.size) return 0; let inter=0; for(const x of A) if(B.has(x)) inter++; return inter / (A.size + B.size - inter); }
  function common(aArr,bArr){ const A=new Set(aArr); return bArr.filter(x=>A.has(x)); }
  function similarFor(seed, k=5){
    const seedM = getMechsZh(seed), seedC = getCatsZh(seed);
    const scored = DATA
      .filter(x=> idOf(x)!==idOf(seed))
      .map(x=>{
        const m = getMechsZh(x), c = getCatsZh(x);
        const s = 0.6*jaccard(seedM,m) + 0.4*jaccard(seedC,c);
        return {x, s, commonM: common(seedM,m), commonC: common(seedC,c)};
      })
      .filter(o=>o.s>0)
      .sort((a,b)=> b.s - a.s);
    if(scored.length===0){
      const q = seed.name_zh || seed.name_en || '';
      const byName = DATA
        .filter(x=>idOf(x)!==idOf(seed))
        .map(x=>({x, s:(()=>{ // åç¨±ç›¸ä¼¼åº¦
          const n=(q||'').toLowerCase(); const m=((x.name_zh||x.name_en||'')||'').toLowerCase();
          const a=[...n]; const b=[...m]; const d=Array.from({length:a.length+1},()=>Array(b.length+1).fill(0));
          for(let i=1;i<=a.length;i++){ for(let j=1;j<=b.length;j++){ d[i][j]=(a[i-1]===b[j-1])?d[i-1][j-1]+1:Math.max(d[i-1][j],d[i][j-1]); } }
          const lcs=d[a.length][b.length]; const s=lcs/Math.max(1,Math.max(a.length,b.length)); return s;
        })(), commonM:[], commonC:[]})))
        .sort((a,b)=>b.s-a.s);
      return byName.slice(0,k);
    }
    return scored.slice(0,k);
  }

  // éš¨æ©Ÿé¢æ¿
  function buildMechMultiSheet(){
    if (!RAND_MECHS) return;
    const counts = new Map();
    DATA.forEach(x=>getMechsZh(x).forEach(m=>counts.set(m,(counts.get(m)||0)+1)));
    const items = [...counts.entries()].sort((a,b)=> b[1]-a[1]);
    const hot = items.slice(0,20);
    const rest = items.slice(20).sort((a,b)=> a[0].localeCompare(b[0],'zh-Hant'));
    function chipRow(m,c){
      const checked = MECH_MULTI.has(m) ? 'checked' : '';
      return `<label class="chip" style="cursor:pointer;"><input type="checkbox" value="${m}" ${checked}> ${m} <span class="muted">(${c})</span></label>`;
    }
    RAND_MECHS.innerHTML = `
      <div class="mech-section-title">ç†±é–€æ©Ÿåˆ¶ï¼ˆå‰20ï¼‰</div>
      ${hot.map(([m,c])=>chipRow(m,c)).join('')}
      <div class="mech-section-title" style="margin-top:8px">å…¨éƒ¨æ©Ÿåˆ¶</div>
      ${rest.map(([m,c])=>chipRow(m,c)).join('')}
    `;
    RAND_MECHS.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change',()=>{ if(cb.checked) MECH_MULTI.add(cb.value); else MECH_MULTI.delete(cb.value); });
    });
  }
  function openRandom(autoPick=true, resetMulti=false){
    if (resetMulti) clearMultiSelect();
    buildMechMultiSheet();
    RAND.setAttribute('open','');
    RAND.setAttribute('aria-hidden','false');
    const sheetEl = RAND.querySelector('.sheet'); if (sheetEl) sheetEl.focus({preventScroll:true});
    if (autoPick) randomPick();
  }
  function closeRandom(){ RAND.removeAttribute('open'); RAND.setAttribute('aria-hidden','true'); if (RAND_GRID) RAND_GRID.innerHTML=''; }
  function randomPick(){
    const pool = filteredBase({ignoreMech:true});
    if (!pool.length){
      RAND_GRID.innerHTML = '<div class="muted" style="padding:12px;font-size:14px;">ç›®å‰çš„ç¯©é¸æ¢ä»¶å¤ªåš´æ ¼ï¼Œæ²’æœ‰å¯æŠ½çš„éŠæˆ²ã€‚è«‹å…ˆæ¸…é™¤æ¢ä»¶ã€‚</div>';
      return;
    }
    const n = Math.min(12, pool.length);
    const picks = [];
    const used = new Set();
    while(picks.length<n){ const i = Math.floor(Math.random()*pool.length); if(!used.has(i)){ used.add(i); picks.push(pool[i]); } }
    RAND_GRID.innerHTML = picks.map(cardHtml).join('');
    RAND_GRID.querySelectorAll('.fav-btn').forEach(btn=>{
      btn.onclick = (e)=>{ e.preventDefault(); const id=btn.dataset.id; if (favs.has(id)) favs.delete(id); else favs.add(id); saveFavs(); render(); };
    });
    if (picks.length){ showFocus(picks[0]); }
  }

  // äº‹ä»¶ç¶å®š
  document.getElementById('clearQ').addEventListener('click', ()=>{ Q.value=""; page=1; buildOptions(); render(); hideAC(); });
  document.getElementById('resetAll').addEventListener('click', ()=>{ restoreInitial(); });
  [Q,CAT,MECH,S,PMIN,PMAX,INCL,PAGE_SIZE].forEach(el=>{
    el.addEventListener('input',()=>{ page=1; buildOptions(); render(); hideAC(); });
  });
  ONLYF.addEventListener('change', ()=>{ page=1; buildOptions(); render(); });
  ONLY_DUP.addEventListener('change', ()=>{ page=1; buildOptions(); render(); });
  HIDED.addEventListener('change', ()=>{ page=1; buildOptions(); render(); });
  PREV.addEventListener('click', ()=>{ if(page>1){page--; render(); window.scrollTo({top:0,behavior:'smooth'});} });
  NEXT.addEventListener('click', ()=>{ const {pages}=filtered(); if(page<pages){page++; render(); window.scrollTo({top:0,behavior:'smooth'});} });
  DLCSV.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); downloadCSV(pagedAll); });
  EMAIL.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); emailFavList(pagedAll); });
  CLEAR_FOCUS.addEventListener('click', ()=>{ clearFocus(); });

  if (MSORT) MSORT.addEventListener('change', ()=>{ S.value = MSORT.value; page=1; render(); });
  S.addEventListener('change', ()=>{ if (MSORT) MSORT.value = S.value; });
  if (MCLEAR) MCLEAR.addEventListener('click', restoreInitial);
  if (MRANDOM) MRANDOM.addEventListener('click', ()=>{ openRandom(true,true); });
  if (MFILTER) MFILTER.addEventListener('click', ()=>{ openRandom(false,false); });
  if (OPEN_RANDOM) OPEN_RANDOM.addEventListener('click', ()=>{ openRandom(true,true); });

  function hideAC(){ AC.style.display='none'; AC.innerHTML=''; }
  function showAC(items){
    if(!items.length){ hideAC(); return; }
    AC.innerHTML = items.slice(0,8).map(it=>{
      const sub = it.name_en ? `<span class="ac-sub">EN: ${it.name_en}</span>` : '';
      return `<div class="ac-item" data-id="${idOf(it)}" role="option" tabindex="0"><div><div>${it.name_zh || it.name_en || ''}</div>${sub}</div></div>`;
    }).join('');
    AC.style.display='block';
    AC.querySelectorAll('.ac-item').forEach(el=>{
      el.onclick = ()=>{ const item = DATA.find(x=>idOf(x)===el.dataset.id); if(item){ Q.value = item.name_zh || item.name_en || ''; hideAC(); page=1; buildOptions(); render(); showFocus(item); window.scrollTo({top:0,behavior:'smooth'}); } };
      el.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); el.click(); }});
    });
  }
  function debounce(fn, ms){ let t=null; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms);} }
  function nameScore(q, x){
    const fields = [ x.name_zh||'', x.name_en||'', ...(x.aliases_zh||[]), ...arr(x.search_keywords).map(String) ];
    const qn = (q||'').toLowerCase().replace(/[^\p{L}\p{N}]+/gu,'');
    let best=0; for(const f of fields){ const fn=(f||'').toLowerCase().replace(/[^\p{L}\p{N}]+/gu,''); if(!fn) continue;
      // ç²—ç•¥ç›¸ä¼¼åº¦
      let s=0; if(fn.includes(qn)) s+=3; if(qn.includes(fn) && fn.length>0) s+=2; best=Math.max(best,s);
    }
    return best;
  }
  const debouncedAC = debounce((q)=>{
    if(!q){ hideAC(); return; }
    const ranked = DATA.map(x=>[x,nameScore(q,x)]).filter(([x,s])=>s>0.15).sort((a,b)=>b[1]-a[1]).map(([x])=>x);
    showAC(ranked);
  }, 160);
  Q.addEventListener('input', ()=>{
    const q = Q.value.trim();
    if(!q){ hideAC(); clearFocus(false); buildOptions(); render(); return; }
    page=1; buildOptions(); render();
    debouncedAC(q);
  });
  document.addEventListener('click', (e)=>{ if(!AC.contains(e.target) && e.target!==Q) hideAC(); });

  // åˆå§‹åŒ–
  function restoreInitial(){
    Q.value=""; CAT.value=""; MECH.value="";
    PMIN.value=""; PMAX.value=""; INCL.checked=false;
    S.value=""; if (MSORT) MSORT.value=""; ONLYF.checked=false; ONLY_DUP.checked=false; HIDED.checked=true; PAGE_SIZE.value="40";
    clearFocus(); clearMultiSelect();
    buildOptions(); page=1; render(); hideAC();
  }
  async function loadFirstAvailable(urls){
    for (const u of urls){
      try{ const r = await fetch(u, {cache:'no-cache'}); if(!r.ok) continue; const d = await r.json(); if (Array.isArray(d)) return d; }
      catch(e){}
    }
    throw new Error('All data sources failed');
  }
  (async ()=>{
    try{
      DATA = await loadFirstAvailable(DATA_CANDIDATES);
      buildOptions();
      const u = new URL(location.href);
      const catQ = u.searchParams.get('cat'), mechQ = u.searchParams.get('mech'), pageQ = parseInt(u.searchParams.get('page')||'1',10);
      if (catQ){ ensureOption(CAT, catQ); CAT.value=catQ; }
      if (mechQ){ ensureOption(MECH, mechQ); MECH.value=mechQ; }
      if (!Number.isNaN(pageQ) && pageQ>0) page = pageQ;
      EMPTY.style.display = (Array.isArray(DATA) && DATA.length) ? 'none' : 'block';
      render();
      buildMechMultiSheet();
    }catch(e){
      console.error('Load data failed:', e);
      EMPTY.style.display = 'block';
      alert('ç„¡æ³•è¼‰å…¥è³‡æ–™ä¾†æºï¼ˆä¸»æª”èˆ‡å‚™æ´çš†å¤±æ•—ï¼‰');
    }
  })();

  // é‡æ–°è¼‰å…¥ï¼æœ¬æ©Ÿ JSON
  RETRY_BTN.addEventListener('click', ()=>location.reload());
  LOADLOCAL_BTN.addEventListener('click', ()=>LOCAL_FILE.click());
  LOCAL_FILE.addEventListener('change', async (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text(); const json = JSON.parse(text);
      if(!Array.isArray(json)){ alert('æœ¬æ©Ÿæª”æ ¼å¼éŒ¯èª¤ï¼ˆéœ€ç‚ºé™£åˆ—ï¼‰'); return; }
      DATA = json; page = 1; EMPTY.style.display = 'none'; buildOptions(); render(); buildMechMultiSheet(); window.scrollTo({top:0,behavior:'smooth'});
    }catch(e){ console.error(e); alert('è®€å–æœ¬æ©Ÿ JSON å¤±æ•—'); }
  });
</script>
</body>
</html>
