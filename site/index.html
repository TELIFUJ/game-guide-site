<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Board Game Guide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa;
      --chip-bg:#f8fafc; --chip-active:#eef2ff; --chip-active-b:#c7d2fe;
      --overlay: rgba(0,0,0,.45);
    }
    body{font:16px/1.5 system-ui;margin:20px;background:var(--bg);color:#222}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{position:relative;border:1px solid var(--border);padding:14px;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .poster{width:100%;aspect-ratio:1/1;object-fit:contain;background:#f3f4f6;border-radius:8px;display:block}
    .price{font-weight:700;margin-top:6px}
    .price small{font-weight:400;color:var(--muted)}
    input,select,label,button{font:inherit}
    input,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:var(--chip-bg);color:inherit;text-decoration:none;cursor:pointer;user-select:none}
    .chip.active{background:var(--chip-active);border-color:var(--chip-active-b)}
    .muted{color:var(--muted)}
    .checkbox{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:8px;align-items:center}
    .fav-btn{position:absolute;top:10px;right:10px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border);border-radius:999px;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;cursor:pointer}
    .fav-btn .star{font-size:22px;line-height:1}
    .fav-btn:hover{ transform:scale(1.06); box-shadow:0 4px 14px rgba(0,0,0,.08) }
    .fav-btn.active{ background:#fff7cc; border-color:#facc15 }
    .pagination{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:10px 0}
    .page-btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .page-btn.active{background:#eef2ff;border-color:#c7d2fe}
    .page-btn:disabled{opacity:.5;cursor:not-allowed}

    /* Focus + recommendations */
    #focus{margin:16px 0 10px}
    .focus-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .focus-title{font-weight:700}
    .rec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .reason{margin-top:6px;color:var(--muted);font-size:12px}
    .clear-link{margin-left:auto;color:#2563eb;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:6px 10px;cursor:pointer}

    /* rating / rank badges */
    .badge{display:inline-block;font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:#f3f4f6;margin-right:6px}
    .badge.rank{background:#eef2ff;border-color:#c7d2fe}
    .rating{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:6px 0}
    .rating .score{font-weight:800}

    /* Auto-complete (ARIA + keyboard) */
    .ac-wrap{position:relative;display:inline-block}
    .ac-list{position:absolute;left:0;top:100%;z-index:1000;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-top:6px;max-height:320px;overflow:auto;min-width:260px;width:100%}
    .ac-item{padding:8px 10px;cursor:pointer;display:flex;gap:8px;align-items:center}
    .ac-item:hover,.ac-item.active{background:#f5f7ff}
    .ac-sub{font-size:12px;color:var(--muted)}

    /* Modal (隨機預覽 / 機制多選) */
    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:var(--overlay);z-index:2000}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:960px;max-height:88vh;overflow:auto;background:#fff;border-radius:16px 16px 0 0;padding:14px;border:1px solid var(--border)}
    .sheet h3{margin:0 0 8px 0}
    .sheet .chips{margin:8px 0 12px}
    .sheet .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sheet .hint{font-size:12px;color:var(--muted)}

    /* 可及性：只有螢幕閱讀器可見 */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* 行動端優化 */
    @media (max-width: 640px){
      .filters{position:sticky;top:0;background:var(--bg);padding-bottom:6px;z-index:50}
      .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
      input,select{font-size:16px} /* iOS 放大問題 */
      .sheet{border-radius:16px 16px 0 0}
    }
  </style>
</head>
<body>

<div id="live" class="sr-only" aria-live="polite"></div>

<form class="filters" autocomplete="off" onsubmit="return false">
  <div class="ac-wrap">
    <input id="q" name="q_no_autofill"
           placeholder="搜尋：中文名 / EN / 關鍵字（支援模糊）" style="min-width:280px"
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
           role="combobox" aria-autocomplete="list" aria-expanded="false" aria-controls="ac">
    <div id="ac" class="ac-list" role="listbox" style="display:none"></div>
  </div>
  <button id="clearQ" class="btn" type="button">✕ 清除</button>
  <button id="resetAll" class="btn" type="button">重置篩選</button>

  <select id="catSel" aria-label="分類"><option value="">全部分類</option></select>
  <select id="mechSel" aria-label="機制"><option value="">全部機制</option></select>

  <input id="pmin" name="pmin_no_autofill" type="number" placeholder="最低價（含二手）"
         autocomplete="off" inputmode="numeric" spellcheck="false">
  <input id="pmax" name="pmax_no_autofill" type="number" placeholder="最高價（含二手）"
         autocomplete="off" inputmode="numeric" spellcheck="false">

  <label class="checkbox"><input type="checkbox" id="inclUsed"> 含二手價</label>

  <select id="sort" aria-label="排序">
    <option value="">排序</option>
    <option value="min_price_asc">最低價格（含二手）低→高</option>
    <option value="min_price_desc">最低價格（含二手）高→低</option>
    <option value="price_asc">售價（新品）低→高</option>
    <option value="price_desc">售價（新品）高→低</option>
    <option value="used_asc">二手價 低→高</option>
    <option value="used_desc">二手價 高→低</option>
    <option value="weight_asc">策略強度 低→高</option>
    <option value="weight_desc">策略強度 高→低</option>
    <option value="rating_avg_desc">評分（平均）高→低</option>
    <option value="rating_bayes_desc">評分（Geek）高→低</option>
  </select>
</form>

<div class="bar">
  <span id="stats">總數：0｜目前顯示：0｜收藏：0</span>
  <div class="row">
    每頁
    <select id="pageSize">
      <option>15</option><option>20</option><option>25</option><option selected>40</option>
    </select> 筆
  </div>
  <div class="row">
    <button id="prev" class="btn" type="button">‹ 上一頁</button>
    <span id="pageInfo">第 1/1 頁</span>
    <button id="next" class="btn" type="button">下一頁 ›</button>
  </div>
  <label class="checkbox"><input type="checkbox" id="onlyFav"> 只看收藏</label>
  <label class="checkbox"><input type="checkbox" id="hideDup" checked> 隱藏重複（自動合併）</label>
  <button id="dlCsv" class="btn" type="button">下載 CSV</button>
  <button id="emailFav" class="btn" type="button">Email 收藏清單</button>
  <button id="randomBtn" class="btn" type="button">🎲 隨機預覽</button>
  <span id="multiInfo" class="badge" style="display:none"></span>
  <button id="clearMulti" class="btn" type="button" style="display:none">清除多機制</button>
</div>

<!-- 智慧推薦焦點區 -->
<div id="focus" style="display:none">
  <div class="focus-head">
    <div class="focus-title">🔎 已選：<span id="focus-name"></span></div>
    <button id="clearFocus" class="clear-link" type="button">清除預覽</button>
  </div>
  <div id="focus-card" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px"></div>
  <div style="margin:10px 0 6px;font-weight:700">你可能也會喜歡</div>
  <div id="rec" class="rec-grid"></div>
</div>

<!-- 上方數字分頁 -->
<div id="pager" class="pagination" aria-label="pagination"></div>

<div id="grid" class="grid"></div>

<!-- 底部分頁 -->
<div id="pager-bottom" class="pagination" aria-label="pagination"></div>

<!-- 隨機預覽 / 機制多選面板 -->
<div id="randomModal" class="modal" aria-modal="true" role="dialog" aria-labelledby="randomTitle" aria-hidden="true">
  <div class="sheet">
    <h3 id="randomTitle">機制探索</h3>
    <div class="hint">勾選多個機制（OR 條件）；若勾很多也會自動僅用「實際有出現」的機制來推薦。</div>
    <div id="mechPool" class="chips" role="group" aria-label="全部機制"></div>
    <div class="actions">
      <button id="applyMech" class="btn" type="button">套用多機制</button>
      <button id="randomPick" class="btn" type="button">隨機呈現</button>
      <button id="closeRandom" class="btn" type="button">關閉</button>
      <span id="mechCounts" class="hint"></span>
    </div>
  </div>
</div>

<script>
  // 1) 避免瀏覽器沿用舊自動填入
  document.getElementById('q').setAttribute('name','q_'+Math.random().toString(36).slice(2));

  // 2) 路徑基準
  const PATH_SEGS = location.pathname.split('/').filter(Boolean);
  const REPO = PATH_SEGS.length ? PATH_SEGS[0] : '';
  const BASE = (location.hostname.endsWith('github.io') && REPO)
    ? `/${REPO}/` : (location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, ''));

  function absUrl(p){ if(!p) return ''; if(/^https?:\/\//i.test(p)) return p; return BASE + String(p).replace(/^\/+/, ''); }

  // 3) 常量與元素
  const CAT_MAP = {/* 省略：與你原本相同，為了篇幅可直接沿用 */};
  const MECH_MAP = {/* 同上，沿用你原本的對照表 */};

  const G = document.getElementById("grid"),
        Q = document.getElementById("q"),
        AC = document.getElementById("ac"),
        CAT = document.getElementById("catSel"),
        MECH = document.getElementById("mechSel"),
        S = document.getElementById("sort"),
        PMIN = document.getElementById("pmin"),
        PMAX = document.getElementById("pmax"),
        INCL = document.getElementById("inclUsed"),
        ONLYF = document.getElementById("onlyFav"),
        HIDED = document.getElementById("hideDup"),
        STATS = document.getElementById("stats"),
        PAGE_SIZE = document.getElementById("pageSize"),
        PREV = document.getElementById("prev"),
        NEXT = document.getElementById("next"),
        PAGE_INFO = document.getElementById("pageInfo"),
        DLCSV = document.getElementById("dlCsv"),
        EMAIL = document.getElementById("emailFav"),
        PAGER_TOP = document.getElementById("pager"),
        PAGER_BOTTOM = document.getElementById("pager-bottom"),
        FOCUS = document.getElementById("focus"),
        FOCUS_NAME = document.getElementById("focus-name"),
        FOCUS_CARD = document.getElementById("focus-card"),
        REC = document.getElementById("rec"),
        CLEAR_FOCUS = document.getElementById("clearFocus"),
        RANDOM_BTN = document.getElementById("randomBtn"),
        RANDOM_MODAL = document.getElementById("randomModal"),
        MECH_POOL = document.getElementById("mechPool"),
        APPLY_MECH = document.getElementById("applyMech"),
        RANDOM_PICK = document.getElementById("randomPick"),
        CLOSE_RANDOM = document.getElementById("closeRandom"),
        MECH_COUNTS = document.getElementById("mechCounts"),
        MULTI_INFO = document.getElementById("multiInfo"),
        CLEAR_MULTI = document.getElementById("clearMulti"),
        LIVE = document.getElementById("live");

  let DATA=[], page=1;

  // 4) 收藏
  const favKey = `bg_favs_${location.pathname.split('/')[1] || 'root'}`;
  const favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
  function saveFavs(){ localStorage.setItem(favKey, JSON.stringify([...favs])); }
  function idOf(x){ return x.id || String(x.bgg_id || (x.name_zh||x.name_en)); }

  // 5) 中文優先
  const RE_ZH = /[\u4E00-\u9FFF]/;
  function isZhPreferred(x){
    const nz = x.name_zh || '';
    const ne = x.name_en || '';
    const blob = `${nz} ${ne} ${(x.alias_zh||'')} ${(x.category_zh||'')} ${Array.isArray(x.tags)?x.tags.join(' '):''}`.toLowerCase();
    return RE_ZH.test(nz) || RE_ZH.test(ne) || /chinese\s*ed(i|t)ion|中文版|繁體|簡體|简体/.test(blob);
  }

  // 6) 類別 / 機制中文
  const CAT_MAP_FALL = {...CAT_MAP};
  const MECH_MAP_FALL = {...MECH_MAP};
  function getCatsZh(x){
    if (Array.isArray(x.categories_zh) && x.categories_zh.length) return x.categories_zh.slice(0,10);
    const en = Array.isArray(x.categories) ? x.categories : [];
    return en.map(s => CAT_MAP_FALL[s] || s).slice(0,10);
  }
  function getMechsZh(x){
    if (Array.isArray(x.mechanics_zh) && x.mechanics_zh.length) return x.mechanics_zh.slice();
    const en = Array.isArray(x.mechanics) ? x.mechanics : [];
    const normalize = s => (s || "").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
    return [...new Set(en.map(s => MECH_MAP_FALL[normalize(s)] || normalize(s)))];
  }

  // 7) 價格
  function priceCandidates(x, includeUsed=true){
    const out=[]; if (x.price_twd!=null && x.price_twd!=="") out.push(Number(x.price_twd));
    if (includeUsed && x.used_price_twd!=null && x.used_price_twd!=="") out.push(Number(x.used_price_twd));
    return out;
  }
  function minPrice(x, includeUsed=true){
    const c=priceCandidates(x, includeUsed);
    return c.length? Math.min(...c) : Number.POSITIVE_INFINITY;
  }

  // 8) 評分
  function getRatingAvg(x){ return (typeof x.rating_avg === 'number') ? x.rating_avg : null; }
  function getRatingBayes(x){ return (typeof x.rating_bayes === 'number') ? x.rating_bayes : null; }
  function ratingBadgeHtml(x){
    const va = getRatingAvg(x), vb = getRatingBayes(x);
    if (va != null) return `<span class="badge"><b class="score">${va.toFixed(1)}</b>/10</span>`;
    if (vb != null) return `<span class="badge"><b class="score">${vb.toFixed(1)}</b>/10</span>`;
    return '';
  }

  // 9) 重複合併（顯示用）
  function normalizeImgUrl(s){ s = String(s||'').toLowerCase(); s = s.replace(/^https?:\/\/[^/]+/, ''); s = s.replace(/[?#].*$/, ''); return s; }
  function dupKey(x){ return [x.bgg_id || '', (x.name_zh || x.name_en || '').trim().toLowerCase(), normalizeImgUrl(x.image || x.image_url || x.thumb_url || '')].join('|'); }
  function isBetter(a,b){
    const ao = !!a.image_override, bo = !!b.image_override;
    if (ao !== bo) return ao;
    const ap = a.price_twd ?? Infinity, bp = b.price_twd ?? Infinity;
    if (ap !== bp) return ap < bp;
    const as = a.stock ?? -1, bs = b.stock ?? -1;
    if (as !== bs) return as > bs;
    return false;
  }
  function dedupList(list){
    const pick = new Map(), counts = new Map();
    for (const x of list){
      const k = dupKey(x); const cur = pick.get(k);
      if (!cur || isBetter(x, cur)) pick.set(k, x);
      counts.set(k, (counts.get(k)||0)+1);
    }
    const out = [];
    for (const [k, x] of pick.entries()){
      const clone = {...x}; clone._variant_count = counts.get(k)||1; out.push(clone);
    }
    return out;
  }

  // 10) 匯出 / Email
  function downloadCSV(rows){
    const headers = ["name_zh","name_en","categories_zh","mechanics_zh","price_twd","used_price_twd","stock","bgg_url"];
    const lines = [headers.join(",")];
    rows.forEach(x=>{
      const vals = [
        (x.name_zh||"").replace(/,/g,"，"),
        (x.name_en||"").replace(/,/g," "),
        (getCatsZh(x).join("/")).replace(/,/g,"／"),
        (getMechsZh(x).join("/")).replace(/,/g,"／"),
        x.price_twd??"", x.used_price_twd??"", x.stock??"", (x.link_override||x.bgg_url_override||x.bgg_url||"")
      ];
      lines.push(vals.join(","));
    });
    const blob = new Blob(["\ufeff"+lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = "boardgames.csv"; a.click();
    URL.revokeObjectURL(a.href);
  }
  function emailFavList(rows){
    const body = rows.map((x,i)=>`${i+1}. ${x.name_zh||x.name_en||""}
${x.name_en?`EN: ${x.name_en}\n`:""}分類：${getCatsZh(x).join(" / ")}
機制：${getMechsZh(x).join(" / ")}
價格：${x.price_twd??"-"}｜二手：${x.used_price_twd??"-"}
連結：${x.link_override||x.bgg_url_override||x.bgg_url||""}\n`).join("\n");
    const mailto = `mailto:?subject=${encodeURIComponent("收藏清單")}&body=${encodeURIComponent(body)}`;
    location.href = mailto;
  }

  // 11) 圖片來源
  function imageSrcOf(x){
    const raw = x.image || x.image_url || x.thumb_url || '';
    const url = absUrl(raw);
    return url || 'https://via.placeholder.com/800?text=No+Image';
  }

  // 12) 初始快照（不動收藏）
  function serializeUI(){
    return { q: Q.value, cat: CAT.value, mech: MECH.value, sort: S.value,
      pmin: PMIN.value, pmax: PMAX.value, incl: INCL.checked,
      onlyf: ONLYF.checked, hided: HIDED.checked, pagesize: PAGE_SIZE.value
    };
  }
  function applyUI(st){
    Q.value = st.q; CAT.value = st.cat; MECH.value = st.mech; S.value = st.sort;
    PMIN.value = st.pmin; PMAX.value = st.pmax; INCL.checked = st.incl;
    ONLYF.checked = st.onlyf; HIDED.checked = st.hided; PAGE_SIZE.value = st.pagesize;
    buildOptions(); page = 1; render();
  }
  let INITIAL_UI = null;
  function restoreInitial(){
    if (INITIAL_UI) applyUI(INITIAL_UI);
    clearFocus(false); clearMultiSelect(); clearRandomMode();
    scrollToTop();
  }

  // 13) 資料載入（快取修復：不再附 ?ts；可讀 manifest）
  async function loadData(){
    let url = absUrl('data/games_full.json');
    try{
      const m = await fetch(absUrl('data/manifest.json'), {cache:'no-cache'}).then(r=>r.ok?r.json():null);
      if (m && m.games_full) url = absUrl(m.games_full);
    }catch(e){}
    const resp = await fetch(url, {cache:'force-cache'});
    if(!resp.ok) throw new Error('Load data failed ' + url);
    return await resp.json();
  }

  loadData().then(d=>{
    DATA=d;
    buildOptions();
    const u = new URL(location.href);
    const catQ = u.searchParams.get('cat'), mechQ = u.searchParams.get('mech'), pageQ = parseInt(u.searchParams.get('page')||'1',10);
    if (catQ){ ensureOption(CAT, catQ); CAT.value=catQ; }
    if (mechQ){ ensureOption(MECH, mechQ); MECH.value=mechQ; }
    if (!Number.isNaN(pageQ) && pageQ>0) page = pageQ;
    render();
    if (!INITIAL_UI) INITIAL_UI = serializeUI();
  }).catch(e=>{
    console.error(e); alert('無法載入資料。');
  });

  function ensureOption(sel, text){
    if (![...sel.options].some(o=>o.value===text)){
      const o=document.createElement('option'); o.value=text; o.textContent=text; sel.appendChild(o);
    }
  }

  // 14) 多機制（OR）選取與隨機模式
  const MECH_MULTI = new Set();
  let RANDOM_LIST = null;

  function buildMechPool(){
    const counts = new Map();
    DATA.forEach(x=>getMechsZh(x).forEach(m=>counts.set(m,(counts.get(m)||0)+1)));
    const all = [...counts.entries()].sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'));
    MECH_POOL.innerHTML = all.map(([m,c])=>
      `<a href="#" class="chip ${MECH_MULTI.has(m)?'active':''}" data-mech="${m}" role="checkbox" aria-checked="${MECH_MULTI.has(m)}">${m} (${c})</a>`
    ).join('');
    MECH_POOL.querySelectorAll('.chip').forEach(a=>{
      a.addEventListener('click',(e)=>{
        e.preventDefault();
        const m=a.dataset.mech;
        if (MECH_MULTI.has(m)) MECH_MULTI.delete(m); else MECH_MULTI.add(m);
        a.classList.toggle('active'); a.setAttribute('aria-checked', a.classList.contains('active'));
        updateMechCountsHint(counts);
      });
    });
    updateMechCountsHint(counts);
  }

  function updateMechCountsHint(counts){
    const sel = [...MECH_MULTI];
    const available = sel.filter(m=>counts.has(m));
    MECH_COUNTS.textContent = sel.length
      ? `已選 ${sel.length}，其中實際可用 ${available.length} 種`
      : `未選擇機制，可直接「隨機呈現」`;
  }

  function openRandom(){ RANDOM_MODAL.classList.add('open'); RANDOM_MODAL.setAttribute('aria-hidden','false'); buildMechPool(); }
  function closeRandom(){ RANDOM_MODAL.classList.remove('open'); RANDOM_MODAL.setAttribute('aria-hidden','true'); }

  function applyMultiSelect(){
    // 若選了很多，也只以「實際出現」的機制做 OR 過濾
    const allMechs = new Set();
    DATA.forEach(x=>getMechsZh(x).forEach(m=>allMechs.add(m)));
    for (const m of [...MECH_MULTI]) if (!allMechs.has(m)) MECH_MULTI.delete(m);
    RANDOM_LIST = null; // 退出隨機模式
    page = 1; closeRandom(); render();
    MULTI_INFO.style.display='inline-block';
    MULTI_INFO.textContent = `多機制：${MECH_MULTI.size} 項`;
    CLEAR_MULTI.style.display='inline-block';
    LIVE.textContent = `已套用多機制，共 ${MECH_MULTI.size} 項`;
  }
  function clearMultiSelect(){
    MECH_MULTI.clear(); MULTI_INFO.style.display='none'; CLEAR_MULTI.style.display='none';
  }
  function randomPick(){
    clearMultiSelect();
    RANDOM_LIST = shuffle(DATA.slice()); // 亂數全排，分頁顯示
    page = 1; closeRandom(); render();
    LIVE.textContent = `已啟用隨機呈現`;
  }
  function clearRandomMode(){ RANDOM_LIST = null; }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }

  // 15) 選項構建（已移除熱門開關）
  function filteredBase({ignoreCat=false, ignoreMech=false}={}){
    let list = RANDOM_LIST ? RANDOM_LIST.slice() : DATA.slice(); // 隨機模式優先

    const q = Q.value.trim().toLowerCase();
    if(q){
      list = list.filter(x=>{
        const blob = [x.name_zh||"", x.name_en||"", ...(x.aliases_zh||[]), ...(x.search_keywords||[])].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    if(!ignoreCat){
      const cSel = CAT.value;
      if(cSel) list = list.filter(x => getCatsZh(x).includes(cSel));
    }
    if(!ignoreMech){
      // 多機制（OR）優先於單一下拉
      if (MECH_MULTI.size>0){
        list = list.filter(x=>{
          const mz = getMechsZh(x);
          return mz.some(t => MECH_MULTI.has(t));
        });
      } else {
        const mSel = MECH.value;
        if(mSel) list = list.filter(x => getMechsZh(x).includes(mSel));
      }
    }

    const includeUsed = INCL.checked;
    const pmin = Number(PMIN.value||0), pmax = Number(PMAX.value||0);
    if (pmin>0 || pmax>0){
      list = list.filter(x=>{
        const cand = priceCandidates(x, includeUsed);
        if (cand.length===0) return false;
        return cand.some(p => (pmin? p>=pmin : true) && (pmax? p<=pmax : true));
      });
    }
    if (ONLYF.checked) list = list.filter(x=>favs.has(idOf(x)));
    if (HIDED.checked) list = dedupList(list);
    return list;
  }

  function buildOptions(){
    // 類別
    const listForCat = filteredBase({ignoreCat:true});
    const cCounts=new Map();
    listForCat.forEach(x=>getCatsZh(x).forEach(c=>cCounts.set(c,(cCounts.get(c)||0)+1)));
    const catVal = CAT.value;
    CAT.innerHTML='<option value="">全部分類</option>';
    [...cCounts.entries()].sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant')).forEach(([n,cnt])=>{
      const o=document.createElement('option'); o.value=n; o.textContent=`${n} (${cnt})`; CAT.appendChild(o);
    });
    if (catVal && ![...CAT.options].some(o=>o.value===catVal)){
      const o=document.createElement('option'); o.value=catVal; o.textContent=`${catVal} (0)`; CAT.appendChild(o);
    }
    CAT.value = catVal;

    // 機制
    const listForMech = filteredBase({ignoreMech:true});
    const mCounts=new Map();
    listForMech.forEach(x=>getMechsZh(x).forEach(m=>mCounts.set(m,(mCounts.get(m)||0)+1)));
    const mechVal = MECH.value;
    MECH.innerHTML='<option value="">全部機制</option>';
    [...mCounts.entries()].sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant')).forEach(([n,cnt])=>{
      const o=document.createElement('option'); o.value=n; o.textContent=`${n} (${cnt})`; MECH.appendChild(o);
    });
    if (mechVal && ![...MECH.options].some(o=>o.value===mechVal)){
      const o=document.createElement('option'); o.value=mechVal; o.textContent=`${mechVal} (0)`; MECH.appendChild(o);
    }
    MECH.value = mechVal;
  }

  // 16) 清除與重置 → 回初始
  document.getElementById('clearQ').addEventListener('click', restoreInitial);
  document.getElementById('resetAll').addEventListener('click', restoreInitial);

  // 17) 事件
  [Q,CAT,MECH,S,PMIN,PMAX,INCL,PAGE_SIZE].forEach(el=>el.addEventListener('input',()=>{page=1; buildOptions(); render(); hideAC();}));
  ONLYF.addEventListener('change', ()=>{ page=1; buildOptions(); render(); });
  HIDED.addEventListener('change', ()=>{ page=1; buildOptions(); render(); });
  PREV.addEventListener('click', ()=>{ if(page>1){page--; render(); scrollToTop();}});
  NEXT.addEventListener('click', ()=>{ const {pages}=filtered(); if(page<pages){page++; render(); scrollToTop();}});
  DLCSV.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); downloadCSV(pagedAll); });
  EMAIL.addEventListener('click', ()=>{ const {pagedAll} = filtered(true); emailFavList(pagedAll); });
  CLEAR_FOCUS.addEventListener('click', restoreInitial);

  RANDOM_BTN.addEventListener('click', openRandom);
  CLOSE_RANDOM.addEventListener('click', closeRandom);
  APPLY_MECH.addEventListener('click', applyMultiSelect);
  RANDOM_PICK.addEventListener('click', randomPick);
  CLEAR_MULTI.addEventListener('click', ()=>{ clearMultiSelect(); page=1; render(); });

  // 18) 排序與中文優先、以及多機制加權
  function filtered(noPaging=false){
    let list = filteredBase();
    const includeUsedForSort = INCL.checked;

    switch (S.value){
      case "min_price_asc":  list.sort((a,b)=> minPrice(a, includeUsedForSort) - minPrice(b, includeUsedForSort)); break;
      case "min_price_desc": list.sort((a,b)=> minPrice(b, includeUsedForSort) - minPrice(a, includeUsedForSort)); break;
      case "price_asc":      list.sort((a,b)=>(a.price_twd??1e12)-(b.price_twd??1e12)); break;
      case "price_desc":     list.sort((a,b)=>(b.price_twd??-1)-(a.price_twd??-1)); break;
      case "used_asc":       list.sort((a,b)=>(a.used_price_twd??1e12)-(b.used_price_twd??1e12)); break;
      case "used_desc":      list.sort((a,b)=>(b.used_price_twd??-1)-(a.used_price_twd??-1)); break;
      case "weight_asc":     list.sort((a,b)=>(a.weight??1e12)-(b.weight??1e12)); break;
      case "weight_desc":    list.sort((a,b)=>(b.weight??-1)-(a.weight??-1)); break;
      case "rating_avg_desc": list.sort((a,b)=> (getRatingAvg(b) ?? -1) - (getRatingAvg(a) ?? -1)); break;
      case "rating_bayes_desc": list.sort((a,b)=> (getRatingBayes(b) ?? -1) - (getRatingBayes(a) ?? -1)); break;
    }

    // 多機制：重合度 → Geek(Bayes) → 平均分
    if (MECH_MULTI.size>0){
      const overlap = (x)=> getMechsZh(x).reduce((acc,t)=> acc + (MECH_MULTI.has(t)?1:0), 0);
      list.sort((a,b)=> (overlap(b)-overlap(a)) ||
                         ((getRatingBayes(b) ?? -1) - (getRatingBayes(a) ?? -1)) ||
                         ((getRatingAvg(b) ?? -1) - (getRatingAvg(a) ?? -1)));
    }

    // 中文優先（穩定分區）
    {
      const zh = list.filter(isZhPreferred);
      const non = list.filter(x => !isZhPreferred(x));
      list = zh.concat(non);
    }

    const total=list.length;
    const ps = Number(PAGE_SIZE.value||40);
    const pages = Math.max(1, Math.ceil(total/ps));
    const start = (page-1)*ps, end = start+ps;
    const pageRows = noPaging ? list : list.slice(start,end);
    return {total, pages, pageRows, pagedAll:list};
  }

  function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

  function toggleFav(id){ if (favs.has(id)) favs.delete(id); else favs.add(id); saveFavs(); render(); }

  function renderPagerInto(el, pages){
    const MAX_LINKS = 9;
    el.innerHTML = '';
    const addBtn = (label, target, disabled=false, active=false)=>{
      const b=document.createElement('button');
      b.className='page-btn'+(active?' active':'');
      b.textContent=label;
      b.disabled=disabled;
      b.type='button';
      b.onclick=()=>{ if(!disabled){ page=target; render(); scrollToTop(); } };
      el.appendChild(b);
    };
    addBtn('« 首', 1, page===1);
    addBtn('‹ 上', Math.max(1,page-1), page===1);
    let start = Math.max(1, page - Math.floor(MAX_LINKS/2));
    let end   = Math.min(pages, start + MAX_LINKS - 1);
    start     = Math.max(1, end - MAX_LINKS + 1);
    for(let i=start;i<=end;i++){ addBtn(String(i), i, false, i===page); }
    addBtn('下 ›', Math.min(pages,page+1), page===pages);
    addBtn('末 »', pages, page===pages);
  }

  function render(){
    const {total, pages, pageRows} = filtered();
    const allFavCount = favs.size;

    STATS.textContent = `總數：${DATA.length}｜目前顯示：${total}｜收藏：${allFavCount}`;
    PAGE_INFO.textContent = `第 ${Math.min(page,pages)}/${pages} 頁`;
    PREV.disabled = (page<=1);
    NEXT.disabled = (page>=pages);

    renderPagerInto(PAGER_TOP, pages);
    renderPagerInto(PAGER_BOTTOM, pages);

    G.innerHTML = pageRows.map(cardHtml).join('');

    // 收藏／chip 篩選
    G.querySelectorAll('.fav-btn').forEach(btn=>{
      btn.onclick = (e)=>{ e.preventDefault(); toggleFav(btn.dataset.id); };
    });
    G.querySelectorAll('.chip.cat').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault();
        const v=a.dataset.cat;
        ensureOption(CAT, v); CAT.value=v; page=1; buildOptions(); render();
        const url = new URL(location.href); url.searchParams.set('cat', v); url.searchParams.set('page','1');
        history.replaceState(null,"",url); scrollToTop();
      };
    });
    G.querySelectorAll('.chip.mech').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault();
        const v=a.dataset.mech;
        ensureOption(MECH, v); MECH.value=v; page=1; buildOptions(); render();
        const url = new URL(location.href); url.searchParams.set('mech', v); url.searchParams.set('page','1');
        history.replaceState(null,"",url); scrollToTop();
      };
    });

    // 焦點卡
    G.querySelectorAll('.card').forEach(c=>{
      c.addEventListener('click',(e)=>{
        if (e.target.closest('.fav-btn') || e.target.closest('.chip') || e.target.closest('a')) return;
        const id = c.dataset.id;
        const item = DATA.find(x=>idOf(x)===id);
        if(item){ showFocus(item); scrollToTop(); }
      });
    });

    // URL page
    const url = new URL(location.href);
    url.searchParams.set('page', String(page));
    history.replaceState(null,"",url);
  }

  function playersText(x){
    const p = Array.isArray(x.players)? x.players : [];
    if (p[0] && p[1]) return `${p[0]}–${p[1]}人`; return '';
  }

  function cardHtml(x){
    const cz = getCatsZh(x), mz = getMechsZh(x), imgSrc = imageSrcOf(x);
    const id = idOf(x); const fav = favs.has(id);
    const chosenCat = CAT.value, chosenMech = MECH.value;
    const link = x.link_override || x.bgg_url_override || x.bgg_url || '#';
    const rank = x.rank_overall; const ppl = playersText(x);

    return `
      <div class="card" data-id="${id}">
        <button class="fav-btn ${fav?'active':''}" title="${fav?'取消收藏':'加入收藏'}" data-id="${id}" aria-label="favorite" type="button">
          <span class="star">${fav?'⭐':'☆'}</span>
        </button>

        <img class="poster" loading="lazy" src="${imgSrc}"
             alt="${x.name_zh||x.name_en||''}"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/800?text=No+Image'">

        <h3 style="margin:.5rem 0 0">${x.name_zh||x.name_en||''}</h3>
        ${x.name_en?`<div class="muted">${x.name_en}</div>`:''}

        <div class="rating">
          ${ratingBadgeHtml(x)}
          ${rank? `<span class="badge rank">RANK #${rank}</span>`:''}
          ${x.weight? `<span class="badge">策略強度 ${Number(x.weight).toFixed(2)}</span>`:''}
          ${ppl? `<span class="badge">${ppl}</span>`:''}
        </div>

        <div class="chips" aria-label="categories">
          ${cz.map(t=>`<a href="#" class="chip cat" data-cat="${t}">${t===chosenCat?`<b>${t}</b>`:t}</a>`).join('')}
        </div>
        <div class="chips" aria-label="mechanics">
          ${mz.map(t=>`<a href="#" class="chip mech ${t===chosenMech?'active':''}" data-mech="${t}">${t}</a>`).join('')}
        </div>

        <div class="price">
          ${x.price_msrp_twd?`<small>新品參考價（未折）$${x.price_msrp_twd}</small><br>`:''}
          ${x.price_twd?`$${x.price_twd}`:''}
          ${x.used_price_twd?` ｜二手 $${x.used_price_twd}`:''}
        </div>
        ${x._variant_count>1 ? `<div class="muted" style="margin-top:2px"><small>變體：${x._variant_count}</small></div>` : ''}
        ${x.price_note?`<div class="muted" style="margin-top:4px">${x.price_note}</div>`:''}
        ${x.used_note?`<div class="muted" style="margin-top:2px">${x.used_note}</div>`:''}
        ${x.stock?`<div><small>庫存：${x.stock}</small></div>`:''}

        <div style="margin-top:6px">
          <a href="${link}" target="_blank" rel="nofollow noopener">BGG</a>
        </div>
      </div>`;
  }

  // 19) Auto-complete（ARIA + keyboard）
  let acActive = -1;
  function hideAC(){ AC.style.display='none'; AC.innerHTML=''; Q.setAttribute('aria-expanded','false'); acActive=-1; Q.removeAttribute('aria-activedescendant'); }
  function showAC(items){
    if(!items.length){ hideAC(); return; }
    AC.innerHTML = items.slice(0,8).map((it,i)=>{
      const id = `acopt-${i}`;
      const sub = it.name_en ? `<span class="ac-sub">EN: ${it.name_en}</span>` : '';
      return `<div class="ac-item" id="${id}" role="option" data-id="${idOf(it)}">
        <div><div>${it.name_zh || it.name_en || ''}</div>${sub}</div>
      </div>`;
    }).join('');
    AC.style.display='block'; Q.setAttribute('aria-expanded','true');
    AC.querySelectorAll('.ac-item').forEach(el=>{
      el.onclick = ()=>{
        const item = DATA.find(x=>idOf(x)===el.dataset.id);
        if(item){
          Q.value = item.name_zh || item.name_en || '';
          hideAC(); page=1; buildOptions(); render(); showFocus(item); scrollToTop();
        }
      };
    });
  }
  function setActive(idx){
    const items=[...AC.querySelectorAll('.ac-item')];
    items.forEach((el,i)=>{ el.classList.toggle('active', i===idx); });
    if (idx>=0 && items[idx]){ Q.setAttribute('aria-activedescendant', items[idx].id); items[idx].scrollIntoView({block:'nearest'}); }
  }
  Q.addEventListener('keydown', (e)=>{
    if(AC.style.display!=='block') return;
    const items=[...AC.querySelectorAll('.ac-item')];
    if(e.key==='ArrowDown'){ e.preventDefault(); acActive = Math.min(items.length-1, acActive+1); setActive(acActive); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); acActive = Math.max(0, acActive-1); setActive(acActive); }
    else if(e.key==='Enter'){ e.preventDefault(); if(acActive>=0){ items[acActive].click(); } }
    else if(e.key==='Escape'){ e.preventDefault(); hideAC(); }
  });

  function normText(s){ return (s||'').toLowerCase().replace(/桌遊|桌由|board ?game|bgg/g,'').replace(/[^\p{L}\p{N}]+/gu,''); }
  function bigrams(s){ const arr=[...s]; const out=new Set(); for(let i=0;i<arr.length-1;i++) out.add(arr[i]+arr[i+1]); return out; }
  function jaccardSet(a,b){ if(!a.size && !b.size) return 0; let inter=0; for(const x of a) if(b.has(x)) inter++; return inter / (a.size + b.size - inter); }
  function lcsLen(a,b){ const m=a.length, n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
    for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ dp[i][j] = a[i-1]===b[j-1] ? dp[i-1][j-1]+1 : Math.max(dp[i-1][j], dp[i][j-1]); } } return dp[m][n]; }
  function nameScore(q, x){
    const fields = [x.name_zh||'', x.name_en||'', ...(x.aliases_zh||[]), ...((x.search_keywords||[]).map(s=>String(s)))];
    const qn = normText(q); let best=0;
    for(const f of fields){ const fn = normText(f); if(!fn) continue; let s=0;
      if(fn.includes(qn)) s += 3; if(qn.includes(fn) && fn.length>0) s += 2;
      const j = jaccardSet(bigrams(fn), bigrams(qn)); s += 2*j;
      const l = lcsLen(fn, qn); s += (l / Math.max(1, Math.max(fn.length, qn.length))) * 2;
      if(s>best) best=s;
    } return best;
  }
  Q.addEventListener('input', ()=>{
    const q = Q.value.trim();
    if(!q){ hideAC(); clearFocus(false); buildOptions(); render(); return; }
    const ranked = DATA.map(x=>[x, nameScore(q, x)]).filter(([x,s])=>s>0.15).sort((a,b)=>b[1]-a[1]).map(([x])=>x);
    showAC(ranked);
  });
  document.addEventListener('click', (e)=>{ if(!AC.contains(e.target) && e.target!==Q) hideAC(); });

  // 20) 智慧推薦（沿用）
  function jaccard(aArr,bArr){ const A = new Set(aArr), B = new Set(bArr); if(!A.size && !B.size) return 0; let inter=0; for(const x of A) if(B.has(x)) inter++; return inter / (A.size + B.size - inter); }
  function common(aArr,bArr){ const A=new Set(aArr); return bArr.filter(x=>A.has(x)); }
  function similarFor(seed, k=5){
    const seedM = getMechsZh(seed), seedC = getCatsZh(seed);
    const scored = DATA.filter(x=> idOf(x)!==idOf(seed)).map(x=>{
      const m = getMechsZh(x), c = getCatsZh(x);
      const s = 0.6*jaccard(seedM,m) + 0.4*jaccard(seedC,c);
      return {x, s, commonM: common(seedM,m), commonC: common(seedC,c)};
    }).filter(o=>o.s>0).sort((a,b)=> b.s - a.s);
    if(scored.length===0){
      const q = seed.name_zh || seed.name_en || '';
      const byName = DATA.filter(x=>idOf(x)!==idOf(seed)).map(x=>({x, s:nameScore(q,x)/8, commonM:[], commonC:[]})).sort((a,b)=>b.s-a.s);
      return byName.slice(0,k);
    }
    return scored.slice(0,k);
  }

  function showFocus(seed){
    FOCUS_NAME.textContent = seed.name_zh || seed.name_en || '';
    FOCUS_CARD.innerHTML = cardHtml(seed);
    const sims = similarFor(seed, 5);
    const cards = sims.map(o=>{
      const x=o.x; const reasonBits=[];
      if(o.commonM.length) reasonBits.push(`共通機制：${o.commonM.slice(0,3).join("、")}`);
      if(o.commonC.length) reasonBits.push(`共通分類：${o.commonC.slice(0,3).join("、")}`);
      const reason = reasonBits.length? `<div class="reason">${reasonBits.join("　")}</div>` : '';
      return `<div>${cardHtml(x)}${reason}</div>`;
    }).join('');
    REC.innerHTML = cards;
    FOCUS.style.display='block';

    FOCUS.querySelectorAll('.fav-btn').forEach(btn=>{ btn.onclick = (e)=>{ e.preventDefault(); toggleFav(btn.dataset.id); }; });
    FOCUS.querySelectorAll('.chip.cat').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); const v=a.dataset.cat; ensureOption(CAT, v); CAT.value=v; page=1; buildOptions(); render(); scrollToTop(); };
    });
    FOCUS.querySelectorAll('.chip.mech').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); const v=a.dataset.mech; ensureOption(MECH, v); MECH.value=v; page=1; buildOptions(); render(); scrollToTop(); };
    });
    FOCUS.querySelectorAll('#rec .card').forEach(c=>{
      c.addEventListener('click',(e)=>{ if (e.target.closest('.fav-btn') || e.target.closest('.chip') || e.target.closest('a')) return;
        const id = c.dataset.id; const item = DATA.find(x=>idOf(x)===id); if(item){ showFocus(item); scrollToTop(); } });
    });
  }

  function clearFocus(resetQuery=true){
    if(resetQuery){ Q.value=''; }
    FOCUS.style.display='none'; FOCUS_CARD.innerHTML=''; REC.innerHTML='';
    render();
  }
</script>
</body>
</html>
