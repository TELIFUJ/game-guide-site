<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Board Game Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --chip-bg: #f3f4f6;
      --chip-selected-bg: #2563eb;
      --chip-selected-text: #ffffff;
      --danger: #b91c1c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
      background: rgba(245,245,247,0.95);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem 1rem;
    }
    .logo {
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-right: 1rem;
      white-space: nowrap;
    }
    .search-input {
      flex: 1 1 220px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #fff;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.3rem 0.8rem;
    }
    .search-input input {
      border: none;
      outline: none;
      width: 100%;
      font-size: 0.9rem;
      background: transparent;
    }
    .select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.35rem 0.8rem;
      background: #fff;
      font-size: 0.85rem;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .btn-primary {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }
    .btn-outline {
      border-color: var(--accent);
      color: var(--accent);
      background: #fff;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 1.5rem 2.5rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0,1fr) 280px;
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0,1fr);
      }
    }

    /* å·¦å´å…§å®¹ */
    section {
      margin-bottom: 1rem;
    }
    h2 {
      font-size: 1rem;
      margin: 0 0 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .section-note {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* éš¨æ©Ÿé è¦½ */
    .random-preview {
      background: var(--card-bg);
      border-radius: 1rem;
      border: 1px solid var(--border);
      padding: 0.75rem;
    }
    .random-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(150px,1fr));
      gap: 0.75rem;
    }

    /* å¡ç‰‡ */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap: 0.9rem;
    }
    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      border: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }
    .card:hover {
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      transform: translateY(-2px);
    }
    .card-img-wrapper {
      position: relative;
      padding-top: 70%;
      overflow: hidden;
      background: #e5e7eb;
    }
    .card-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .card-body {
      padding: 0.6rem 0.7rem 0.7rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.8rem;
    }
    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      line-height: 1.2;
    }
    .card-subtitle {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem 0.8rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .meta-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }
    .meta-tag strong {
      font-weight: 600;
      color: var(--text-main);
    }
    .price-stock {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      margin-top: 0.15rem;
    }
    .price {
      font-weight: 600;
      color: var(--accent);
    }
    .stock {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .stock-zero {
      color: var(--danger);
      font-weight: 600;
    }
    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.3rem;
    }
    .chip {
      border-radius: 999px;
      padding: 0.12rem 0.45rem;
      font-size: 0.68rem;
      background: var(--chip-bg);
      color: var(--text-muted);
      border: 1px solid transparent;
      cursor: pointer;
      white-space: nowrap;
    }
    .chip.selected {
      background: var(--chip-selected-bg);
      color: var(--chip-selected-text);
      border-color: var(--chip-selected-bg);
    }

    /* å³å´ç¯©é¸é¢æ¿ */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .panel {
      background: var(--card-bg);
      border-radius: 1rem;
      border: 1px solid var(--border);
      padding: 0.75rem;
      font-size: 0.8rem;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.35rem;
    }
    .panel-title {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .panel-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      max-height: 220px;
      overflow: auto;
    }
    .panel-chip {
      border-radius: 999px;
      padding: 0.13rem 0.55rem;
      font-size: 0.68rem;
      background: var(--chip-bg);
      color: var(--text-muted);
      border: 1px solid transparent;
      cursor: pointer;
      white-space: nowrap;
    }
    .panel-chip.selected {
      background: var(--chip-selected-bg);
      color: var(--chip-selected-text);
      border-color: var(--chip-selected-bg);
    }

    /* è©³ç´°å½ˆå‡ºå±¤ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      z-index: 50;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      background: var(--card-bg);
      border-radius: 1.1rem;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      border: 1px solid var(--border);
      padding: 0.9rem 1rem 1rem;
      display: grid;
      grid-template-columns: 280px minmax(0,1fr);
      gap: 0.9rem;
    }
    @media (max-width: 800px) {
      .modal {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .modal-img {
      width: 100%;
      border-radius: 0.8rem;
      border: 1px solid var(--border);
      max-height: 340px;
      object-fit: cover;
      background: #e5e7eb;
    }
    .modal-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
    }
    .modal-title-block {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 700;
    }
    .modal-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      padding: 0.1rem 0.2rem;
      color: var(--text-muted);
    }
    .modal-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .similar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
      gap: 0.6rem;
      margin-top: 0.3rem;
    }
    .similar-card {
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      overflow: hidden;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    .similar-img-wrapper {
      position: relative;
      padding-top: 60%;
      overflow: hidden;
      background: #e5e7eb;
    }
    .similar-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .similar-body {
      padding: 0.35rem 0.45rem 0.45rem;
      font-size: 0.72rem;
      display: flex;
      flex-direction: column;
      gap: 0.18rem;
    }
    .similar-title {
      font-size: 0.78rem;
      font-weight: 600;
    }
    .similar-subtitle {
      font-size: 0.68rem;
      color: var(--text-muted);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.05rem 0.35rem;
      border-radius: 999px;
      font-size: 0.66rem;
      background: var(--accent-soft);
      color: var(--accent);
      margin-left: 0.3rem;
    }

    /* å·¥å…·åˆ—ç‹€æ…‹ */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 0.4rem 0 0.5rem;
    }
    .status-left, .status-right {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      flex-wrap: wrap;
    }
    .active-filter-pill {
      border-radius: 999px;
      padding: 0.1rem 0.45rem;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .link {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.78rem;
    }
    .link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="logo">Board Game Guide</div>
      <div class="search-input">
        <span style="font-size:0.8rem;">ğŸ”</span>
        <input id="searchInput" type="text" placeholder="æœå°‹éŠæˆ²åç¨±ï¼ˆä¸­ï¼è‹±ï¼‰â€¦">
      </div>
      <select id="sortSelect" class="select">
        <option value="name_zh">æ’åºï¼šä¸­æ–‡åç¨±</option>
        <option value="rating_bayes_desc">æ’åºï¼šBayes è©•åˆ†ï¼ˆé«˜â†’ä½ï¼‰</option>
        <option value="rating_avg_desc">æ’åºï¼šå¹³å‡è©•åˆ†ï¼ˆé«˜â†’ä½ï¼‰</option>
        <option value="users_rated_desc">æ’åºï¼šè©•åˆ†äººæ•¸ï¼ˆå¤šâ†’å°‘ï¼‰</option>
        <option value="weight_asc">æ’åºï¼šé‡é‡ï¼ˆè¼•â†’é‡ï¼‰</option>
        <option value="weight_desc">æ’åºï¼šé‡é‡ï¼ˆé‡â†’è¼•ï¼‰</option>
        <option value="price_asc">æ’åºï¼šåƒ¹æ ¼ï¼ˆä½â†’é«˜ï¼‰</option>
        <option value="price_desc">æ’åºï¼šåƒ¹æ ¼ï¼ˆé«˜â†’ä½ï¼‰</option>
      </select>
      <button id="clearFiltersBtn" class="btn">æ¸…é™¤ç¯©é¸</button>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- å·¦å´å…§å®¹ -->
      <div>
        <section>
          <h2>
            <span>éš¨æ©Ÿé è¦½</span>
            <button id="refreshRandomBtn" class="btn-outline btn" type="button">æ›ä¸€æ‰¹</button>
          </h2>
          <div class="random-preview">
            <div id="randomContainer" class="random-grid"></div>
          </div>
        </section>

        <section>
          <h2>
            <span>æ‰€æœ‰éŠæˆ²</span>
            <span class="section-note" id="totalCountLabel"></span>
          </h2>
          <div class="status-bar">
            <div class="status-left">
              <span id="resultCountText"></span>
              <div id="activeFiltersContainer"></div>
            </div>
            <div class="status-right">
              <span id="mechanismFilterSummary"></span>
            </div>
          </div>
          <div id="cardsContainer" class="cards-grid"></div>
        </section>
      </div>

      <!-- å³å´ç¯©é¸é¢æ¿ -->
      <aside class="sidebar">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">åˆ†é¡ï¼ˆä¸­æ–‡ï¼‰</div>
          </div>
          <div id="categoryPanel" class="panel-chips"></div>
        </div>
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">æ©Ÿåˆ¶ï¼ˆä¸­æ–‡ï¼‰</div>
          </div>
          <div id="mechanismPanel" class="panel-chips"></div>
        </div>
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">èªªæ˜</div>
          </div>
          <p style="margin:0 0 0.25rem;font-size:0.75rem;color:var(--text-muted);">
            ï¼é»å¡ç‰‡å¯æŸ¥çœ‹è©³ç´°è³‡è¨Šèˆ‡ã€Œä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡ã€ã€‚<br>
            ï¼é»åˆ†é¡ï¼æ©Ÿåˆ¶ chips å¯ç›´æ¥å¥—ç”¨ç¯©é¸ã€‚<br>
            ï¼æ¨è–¦å€å¡Šæœƒä¸€æ¬¡é¡¯ç¤ºç´„ 5â€“8 æ¬¾é¡ä¼¼éŠæˆ²ï¼Œä¸¦é™„åƒ¹æ ¼èˆ‡åº«å­˜ã€‚
          </p>
        </div>
      </aside>
    </div>
  </main>

  <!-- è©³ç´°å½ˆå‡ºå±¤ -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div>
        <img id="modalImage" class="modal-img" alt="">
      </div>
      <div>
        <div class="modal-header-row">
          <div class="modal-title-block">
            <div id="modalTitle" class="modal-title"></div>
            <div id="modalSubtitle" class="modal-subtitle"></div>
          </div>
          <button id="modalCloseBtn" class="modal-close" type="button">âœ•</button>
        </div>

        <div class="meta-row" id="modalMetaRow" style="margin-top:0.5rem;"></div>

        <div id="modalPriceStock" class="price-stock" style="margin-top:0.35rem;"></div>

        <div>
          <div class="modal-section-title">åˆ†é¡</div>
          <div id="modalCategories" class="chips-row"></div>
        </div>

        <div>
          <div class="modal-section-title">æ©Ÿåˆ¶</div>
          <div id="modalMechanisms" class="chips-row"></div>
        </div>

        <div style="margin-top:0.4rem;">
          <div class="modal-section-title">
            ä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡
            <span class="section-note" style="margin-left:0.25rem;">ï¼ˆç´„ 5â€“8 æ¬¾ï¼Œä¾æ©Ÿåˆ¶ï¼åˆ†é¡èˆ‡é‡é‡ç›¸è¿‘æ’åºï¼‰</span>
          </div>
          <div id="similarContainer" class="similar-grid"></div>
        </div>

        <div style="margin-top:0.5rem;font-size:0.72rem;">
          <a id="modalBggLink" class="link" href="#" target="_blank" rel="noopener noreferrer">å‰å¾€ BGG é é¢</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨åŸŸç‹€æ…‹
    let allGames = [];
    let filteredGames = [];
    let allCategories = new Map();  // nameZh -> count
    let allMechanisms = new Map();  // nameZh -> count
    let currentGame = null;

    const state = {
      searchText: "",
      sortKey: "name_zh",
      selectedCategories: new Set(),
      selectedMechanisms: new Set()
    };

    // DOM å¿«å–
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const cardsContainer = document.getElementById('cardsContainer');
    const randomContainer = document.getElementById('randomContainer');
    const refreshRandomBtn = document.getElementById('refreshRandomBtn');
    const totalCountLabel = document.getElementById('totalCountLabel');
    const resultCountText = document.getElementById('resultCountText');
    const activeFiltersContainer = document.getElementById('activeFiltersContainer');
    const mechanismFilterSummary = document.getElementById('mechanismFilterSummary');
    const categoryPanel = document.getElementById('categoryPanel');
    const mechanismPanel = document.getElementById('mechanismPanel');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const modalMetaRow = document.getElementById('modalMetaRow');
    const modalPriceStock = document.getElementById('modalPriceStock');
    const modalCategories = document.getElementById('modalCategories');
    const modalMechanisms = document.getElementById('modalMechanisms');
    const similarContainer = document.getElementById('similarContainer');
    const modalBggLink = document.getElementById('modalBggLink');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    // è¼‰å…¥æµç¨‹
    async function fetchWithFallback() {
      const paths = ['data/games.json', 'site/data/games.json'];
      let lastError = null;
      for (const p of paths) {
        try {
          const res = await fetch(p, { cache: 'no-store' });
          if (!res.ok) continue;
          const data = await res.json();
          return data;
        } catch (e) {
          lastError = e;
        }
      }
      console.error('è¼‰å…¥ games.json å¤±æ•—', lastError);
      alert('è®€å–éŠæˆ²è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ data/games.json / site/data/games.jsonã€‚');
      return [];
    }

    function normalizeGame(raw) {
      const categoriesZh = Array.isArray(raw.categories_zh) ? raw.categories_zh : [];
      const mechanismsZh = Array.isArray(raw.mechanisms_zh || raw.mechanics_zh)
        ? (raw.mechanisms_zh || raw.mechanics_zh)
        : [];
      const categoriesRaw = Array.isArray(raw.categories) ? raw.categories : [];
      const mechanismsRaw = Array.isArray(raw.mechanisms || raw.mechanics)
        ? (raw.mechanisms || raw.mechanics)
        : [];

      const categories = categoriesZh.length > 0 ? categoriesZh : categoriesRaw;
      const mechanisms = mechanismsZh.length > 0 ? mechanismsZh : mechanismsRaw;

      const game = {
        id: raw.id || String(raw.bgg_id || ''),
        nameZh: raw.name_zh || raw.name || '',
        nameEn: raw.name_en || raw.name || '',
        year: raw.year || null,
        minPlayers: raw.min_players ?? raw.minplayers ?? null,
        maxPlayers: raw.max_players ?? raw.maxplayers ?? null,
        minPlaytime: raw.min_playtime ?? raw.minplaytime ?? null,
        maxPlaytime: raw.max_playtime ?? raw.maxplaytime ?? null,
        ratingBayes: raw.rating_bayes ?? null,
        ratingAvg: raw.rating_avg ?? raw.rating ?? null,
        usersRated: raw.users_rated ?? raw.usersrated ?? null,
        weight: raw.weight_avg ?? raw.weight ?? null,
        mechanismCount: raw.mechanism_count ?? (Array.isArray(mechanismsRaw) ? mechanismsRaw.length : null),
        price: raw.used_price_twd ?? null,
        stock: raw.stock ?? null,
        image: raw.image || raw.thumbnail || '',
        bggUrl: raw.bgg_url || (raw.bgg_id ? `https://boardgamegeek.com/boardgame/${raw.bgg_id}` : null),
        categories,
        categoriesRaw,
        mechanisms,
        mechanismsRaw,
        source: raw.source || ''
      };
      return game;
    }

    function buildTaxonomyMaps() {
      allCategories = new Map();
      allMechanisms = new Map();
      for (const g of allGames) {
        for (const c of g.categories || []) {
          if (!c) continue;
          allCategories.set(c, (allCategories.get(c) || 0) + 1);
        }
        for (const m of g.mechanisms || []) {
          if (!m) continue;
          allMechanisms.set(m, (allMechanisms.get(m) || 0) + 1);
        }
      }
    }

    function initPanels() {
      // åˆ†é¡é¢æ¿
      categoryPanel.innerHTML = '';
      const sortedCats = Array.from(allCategories.entries())
        .sort((a, b) => b[1] - a[1]);
      for (const [name, count] of sortedCats) {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'panel-chip';
        chip.textContent = `${name} (${count})`;
        chip.dataset.value = name;
        chip.dataset.type = 'category';
        chip.addEventListener('click', () => {
          toggleFilterChip('category', name);
        });
        categoryPanel.appendChild(chip);
      }

      // æ©Ÿåˆ¶é¢æ¿
      mechanismPanel.innerHTML = '';
      const sortedMechs = Array.from(allMechanisms.entries())
        .sort((a, b) => b[1] - a[1]);
      for (const [name, count] of sortedMechs) {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'panel-chip';
        chip.textContent = `${name} (${count})`;
        chip.dataset.value = name;
        chip.dataset.type = 'mechanism';
        chip.addEventListener('click', () => {
          toggleFilterChip('mechanism', name);
        });
        mechanismPanel.appendChild(chip);
      }
    }

    function toggleFilterChip(kind, value) {
      if (kind === 'category') {
        if (state.selectedCategories.has(value)) {
          state.selectedCategories.delete(value);
        } else {
          state.selectedCategories.add(value);
        }
      } else if (kind === 'mechanism') {
        if (state.selectedMechanisms.has(value)) {
          state.selectedMechanisms.delete(value);
        } else {
          state.selectedMechanisms.add(value);
        }
      }
      applyFiltersAndRender();
      syncPanelChipSelection();
    }

    function syncPanelChipSelection() {
      for (const el of categoryPanel.querySelectorAll('.panel-chip')) {
        const value = el.dataset.value;
        el.classList.toggle('selected', state.selectedCategories.has(value));
      }
      for (const el of mechanismPanel.querySelectorAll('.panel-chip')) {
        const value = el.dataset.value;
        el.classList.toggle('selected', state.selectedMechanisms.has(value));
      }
    }

    function applyFiltersAndRender() {
      const search = state.searchText.trim().toLowerCase();
      const cats = state.selectedCategories;
      const mechs = state.selectedMechanisms;

      filteredGames = allGames.filter(g => {
        // æœå°‹
        if (search) {
          const text = `${g.nameZh || ''} ${g.nameEn || ''}`.toLowerCase();
          if (!text.includes(search)) return false;
        }
        // åˆ†é¡ç¯©é¸ï¼ˆANDï¼šé¸äº† N å€‹ï¼Œå°±è¦å…¨éƒ¨åŒ…å«ï¼‰
        if (cats.size > 0) {
          const catSet = new Set(g.categories || []);
          for (const c of cats) {
            if (!catSet.has(c)) return false;
          }
        }
        // æ©Ÿåˆ¶ç¯©é¸
        if (mechs.size > 0) {
          const mechSet = new Set(g.mechanisms || []);
          for (const m of mechs) {
            if (!mechSet.has(m)) return false;
          }
        }
        return true;
      });

      // æ’åº
      sortGames(filteredGames, state.sortKey);

      // æ¸²æŸ“
      renderCards();
      renderStatus();
      renderRandomPreview(); // æ¯æ¬¡ç¯©é¸å¾Œéš¨æ©Ÿå€ä¹Ÿé †ä¾¿æ›´æ–°ä¸€æ‰¹
    }

    function sortGames(arr, key) {
      arr.sort((a, b) => {
        switch (key) {
          case 'rating_bayes_desc':
            return (b.ratingBayes ?? -999) - (a.ratingBayes ?? -999);
          case 'rating_avg_desc':
            return (b.ratingAvg ?? -999) - (a.ratingAvg ?? -999);
          case 'users_rated_desc':
            return (b.usersRated ?? -999) - (a.usersRated ?? -999);
          case 'weight_asc':
            return (a.weight ?? 999) - (b.weight ?? 999);
          case 'weight_desc':
            return (b.weight ?? -999) - (a.weight ?? -999);
          case 'price_asc':
            return (a.price ?? 9999999) - (b.price ?? 9999999);
          case 'price_desc':
            return (b.price ?? -9999999) - (a.price ?? -9999999);
          case 'name_zh':
          default: {
            const aName = (a.nameZh || a.nameEn || '').toString();
            const bName = (b.nameZh || b.nameEn || '').toString();
            return aName.localeCompare(bName, 'zh-Hant');
          }
        }
      });
    }

    function renderStatus() {
      totalCountLabel.textContent = `è³‡æ–™ç­†æ•¸ï¼š${allGames.length} ç­†`;
      resultCountText.textContent = `ç›®å‰é¡¯ç¤ºï¼š${filteredGames.length} ç­†`;

      activeFiltersContainer.innerHTML = '';
      if (state.selectedCategories.size > 0) {
        for (const c of state.selectedCategories) {
          const pill = document.createElement('span');
          pill.className = 'active-filter-pill';
          pill.textContent = `åˆ†é¡ï¼š${c}`;
          activeFiltersContainer.appendChild(pill);
        }
      }
      if (state.selectedMechanisms.size > 0) {
        for (const m of state.selectedMechanisms) {
          const pill = document.createElement('span');
          pill.className = 'active-filter-pill';
          pill.textContent = `æ©Ÿåˆ¶ï¼š${m}`;
          activeFiltersContainer.appendChild(pill);
        }
      }

      if (state.selectedMechanisms.size > 0) {
        mechanismFilterSummary.textContent =
          `å·²é¸æ©Ÿåˆ¶ï¼š${state.selectedMechanisms.size} ç¨®`;
      } else {
        mechanismFilterSummary.textContent = '';
      }
    }

    function renderCards() {
      cardsContainer.innerHTML = '';
      for (const g of filteredGames) {
        const card = document.createElement('article');
        card.className = 'card';
        card.addEventListener('click', () => openGameModal(g));

        const imgWrap = document.createElement('div');
        imgWrap.className = 'card-img-wrapper';
        const img = document.createElement('img');
        img.className = 'card-img';
        img.src = g.image || '';
        img.alt = g.nameZh || g.nameEn || '';
        imgWrap.appendChild(img);

        const body = document.createElement('div');
        body.className = 'card-body';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = g.nameZh || g.nameEn || '(æœªå‘½å)';
        body.appendChild(title);

        const subtitle = document.createElement('div');
        subtitle.className = 'card-subtitle';
        const en = g.nameEn ? g.nameEn : '';
        const year = g.year ? ` Â· ${g.year}` : '';
        subtitle.textContent = en + year;
        body.appendChild(subtitle);

        const metaRow = document.createElement('div');
        metaRow.className = 'meta-row';

        const playerTag = document.createElement('div');
        playerTag.className = 'meta-tag';
        playerTag.innerHTML = `<strong>äººæ•¸ï¼š</strong>${formatRange(g.minPlayers, g.maxPlayers, 'äºº')}`;
        metaRow.appendChild(playerTag);

        const timeTag = document.createElement('div');
        timeTag.className = 'meta-tag';
        timeTag.innerHTML = `<strong>æ™‚é–“ï¼š</strong>${formatRange(g.minPlaytime, g.maxPlaytime, 'åˆ†')}`;
        metaRow.appendChild(timeTag);

        const ratingTag = document.createElement('div');
        ratingTag.className = 'meta-tag';
        ratingTag.innerHTML =
          `<strong>è©•åˆ†ï¼š</strong>${formatNumber(g.ratingBayes)} / ${formatNumber(g.ratingAvg)}ï¼ˆ${g.usersRated ?? '-'} äººï¼‰`;
        metaRow.appendChild(ratingTag);

        const weightTag = document.createElement('div');
        weightTag.className = 'meta-tag';
        weightTag.innerHTML = `<strong>é‡é‡ï¼š</strong>${formatNumber(g.weight)}`;
        metaRow.appendChild(weightTag);

        const mechTag = document.createElement('div');
        mechTag.className = 'meta-tag';
        const mc = g.mechanismCount ?? (Array.isArray(g.mechanisms) ? g.mechanisms.length : null);
        mechTag.innerHTML = `<strong>æ©Ÿåˆ¶æ•¸ï¼š</strong>${mc ?? '-'}`;
        metaRow.appendChild(mechTag);

        body.appendChild(metaRow);

        const priceStock = document.createElement('div');
        priceStock.className = 'price-stock';
        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = g.price != null ? `NT$ ${g.price}` : 'åƒ¹æ ¼æœªè¨­å®š';
        const stock = document.createElement('div');
        stock.className = 'stock';
        if (g.stock == null) {
          stock.textContent = '';
        } else if (g.stock <= 0) {
          stock.textContent = 'å”®å®Œ';
          stock.classList.add('stock-zero');
        } else {
          stock.textContent = `åº«å­˜ï¼š${g.stock}`;
        }
        priceStock.appendChild(price);
        priceStock.appendChild(stock);
        body.appendChild(priceStock);

        // chipsï¼šåˆ†é¡ + æ©Ÿåˆ¶ï¼ˆä¸­æ–‡ï¼‰
        const chipsRow = document.createElement('div');
        chipsRow.className = 'chips-row';

        (g.categories || []).forEach(c => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'chip';
          chip.textContent = c;
          chip.addEventListener('click', (ev) => {
            ev.stopPropagation();
            toggleFilterChip('category', c);
          });
          chipsRow.appendChild(chip);
        });

        (g.mechanisms || []).forEach(m => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'chip';
          chip.textContent = m;
          chip.addEventListener('click', (ev) => {
            ev.stopPropagation();
            toggleFilterChip('mechanism', m);
          });
          chipsRow.appendChild(chip);
        });

        body.appendChild(chipsRow);

        card.appendChild(imgWrap);
        card.appendChild(body);
        cardsContainer.appendChild(card);
      }
    }

    function renderRandomPreview() {
      randomContainer.innerHTML = '';
      const n = Math.min(4, allGames.length);
      const picks = pickRandomGames(allGames, n);

      for (const g of picks) {
        const card = document.createElement('article');
        card.className = 'card';
        card.addEventListener('click', () => openGameModal(g));

        const imgWrap = document.createElement('div');
        imgWrap.className = 'card-img-wrapper';
        const img = document.createElement('img');
        img.className = 'card-img';
        img.src = g.image || '';
        img.alt = g.nameZh || g.nameEn || '';
        imgWrap.appendChild(img);

        const body = document.createElement('div');
        body.className = 'card-body';
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = g.nameZh || g.nameEn || '(æœªå‘½å)';
        body.appendChild(title);

        const subtitle = document.createElement('div');
        subtitle.className = 'card-subtitle';
        const en = g.nameEn ? g.nameEn : '';
        const year = g.year ? ` Â· ${g.year}` : '';
        subtitle.textContent = en + year;
        body.appendChild(subtitle);

        const metaRow = document.createElement('div');
        metaRow.className = 'meta-row';
        const ratingTag = document.createElement('div');
        ratingTag.className = 'meta-tag';
        ratingTag.innerHTML =
          `<strong>è©•åˆ†ï¼š</strong>${formatNumber(g.ratingBayes)} / ${formatNumber(g.ratingAvg)}`;
        metaRow.appendChild(ratingTag);
        body.appendChild(metaRow);

        const priceStock = document.createElement('div');
        priceStock.className = 'price-stock';
        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = g.price != null ? `NT$ ${g.price}` : 'åƒ¹æ ¼æœªè¨­å®š';
        const stock = document.createElement('div');
        stock.className = 'stock';
        if (g.stock == null) {
          stock.textContent = '';
        } else if (g.stock <= 0) {
          stock.textContent = 'å”®å®Œ';
          stock.classList.add('stock-zero');
        } else {
          stock.textContent = `åº«å­˜ï¼š${g.stock}`;
        }
        priceStock.appendChild(price);
        priceStock.appendChild(stock);
        body.appendChild(priceStock);

        card.appendChild(imgWrap);
        card.appendChild(body);
        randomContainer.appendChild(card);
      }
    }

    function pickRandomGames(arr, n) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    // è©³ç´°å½ˆçª— + ä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡
    function openGameModal(game) {
      currentGame = game;
      modalTitle.textContent = game.nameZh || game.nameEn || '(æœªå‘½å)';
      modalSubtitle.textContent = (game.nameEn || '') + (game.year ? ` Â· ${game.year}` : '');
      modalImage.src = game.image || '';
      modalImage.alt = game.nameZh || game.nameEn || '';

      // Meta
      modalMetaRow.innerHTML = '';
      const playerTag = document.createElement('div');
      playerTag.className = 'meta-tag';
      playerTag.innerHTML = `<strong>äººæ•¸ï¼š</strong>${formatRange(game.minPlayers, game.maxPlayers, 'äºº')}`;
      modalMetaRow.appendChild(playerTag);

      const timeTag = document.createElement('div');
      timeTag.className = 'meta-tag';
      timeTag.innerHTML = `<strong>æ™‚é–“ï¼š</strong>${formatRange(game.minPlaytime, game.maxPlaytime, 'åˆ†')}`;
      modalMetaRow.appendChild(timeTag);

      const ratingTag = document.createElement('div');
      ratingTag.className = 'meta-tag';
      ratingTag.innerHTML =
        `<strong>è©•åˆ†ï¼š</strong>${formatNumber(game.ratingBayes)} / ${formatNumber(game.ratingAvg)}ï¼ˆ${game.usersRated ?? '-'} äººï¼‰`;
      modalMetaRow.appendChild(ratingTag);

      const weightTag = document.createElement('div');
      weightTag.className = 'meta-tag';
      weightTag.innerHTML = `<strong>é‡é‡ï¼š</strong>${formatNumber(game.weight)}`;
      modalMetaRow.appendChild(weightTag);

      const mechTag = document.createElement('div');
      mechTag.className = 'meta-tag';
      const mc = game.mechanismCount ?? (Array.isArray(game.mechanisms) ? game.mechanisms.length : null);
      mechTag.innerHTML = `<strong>æ©Ÿåˆ¶æ•¸ï¼š</strong>${mc ?? '-'}`;
      modalMetaRow.appendChild(mechTag);

      // åƒ¹æ ¼ï¼åº«å­˜
      modalPriceStock.innerHTML = '';
      const price = document.createElement('div');
      price.className = 'price';
      price.textContent = game.price != null ? `NT$ ${game.price}` : 'åƒ¹æ ¼æœªè¨­å®š';
      const stock = document.createElement('div');
      stock.className = 'stock';
      if (game.stock == null) {
        stock.textContent = '';
      } else if (game.stock <= 0) {
        stock.textContent = 'å”®å®Œ';
        stock.classList.add('stock-zero');
      } else {
        stock.textContent = `åº«å­˜ï¼š${game.stock}`;
      }
      modalPriceStock.appendChild(price);
      modalPriceStock.appendChild(stock);

      // åˆ†é¡ï¼æ©Ÿåˆ¶ chipsï¼ˆä¸­æ–‡ï¼‰
      modalCategories.innerHTML = '';
      (game.categories || []).forEach(c => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'chip';
        chip.textContent = c;
        chip.addEventListener('click', () => toggleFilterChip('category', c));
        modalCategories.appendChild(chip);
      });

      modalMechanisms.innerHTML = '';
      (game.mechanisms || []).forEach(m => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'chip';
        chip.textContent = m;
        chip.addEventListener('click', () => toggleFilterChip('mechanism', m));
        modalMechanisms.appendChild(chip);
      });

      // BGG é€£çµ
      if (game.bggUrl) {
        modalBggLink.href = game.bggUrl;
        modalBggLink.style.display = '';
      } else {
        modalBggLink.style.display = 'none';
      }

      // ä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡
      renderSimilarGames(game);

      modalBackdrop.classList.add('show');
    }

    function renderSimilarGames(baseGame) {
      similarContainer.innerHTML = '';
      if (!allGames || allGames.length === 0) return;

      const sims = computeSimilarGames(baseGame, 8); // æœ€å¤š 8 å€‹
      for (const g of sims) {
        const card = document.createElement('article');
        card.className = 'similar-card';
        card.addEventListener('click', () => openGameModal(g));

        const imgWrap = document.createElement('div');
        imgWrap.className = 'similar-img-wrapper';
        const img = document.createElement('img');
        img.className = 'similar-img';
        img.src = g.image || '';
        img.alt = g.nameZh || g.nameEn || '';
        imgWrap.appendChild(img);

        const body = document.createElement('div');
        body.className = 'similar-body';

        const title = document.createElement('div');
        title.className = 'similar-title';
        title.textContent = g.nameZh || g.nameEn || '(æœªå‘½å)';
        body.appendChild(title);

        const subtitle = document.createElement('div');
        subtitle.className = 'similar-subtitle';
        subtitle.textContent =
          `è©•åˆ†ï¼š${formatNumber(g.ratingBayes)} / ${formatNumber(g.ratingAvg)} Â· é‡é‡ï¼š${formatNumber(g.weight)}`;
        body.appendChild(subtitle);

        const priceStock = document.createElement('div');
        priceStock.className = 'price-stock';
        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = g.price != null ? `NT$ ${g.price}` : 'åƒ¹æ ¼æœªè¨­å®š';
        const stock = document.createElement('div');
        stock.className = 'stock';
        if (g.stock == null) {
          stock.textContent = '';
        } else if (g.stock <= 0) {
          stock.textContent = 'å”®å®Œ';
          stock.classList.add('stock-zero');
        } else {
          stock.textContent = `åº«å­˜ï¼š${g.stock}`;
        }
        priceStock.appendChild(price);
        priceStock.appendChild(stock);
        body.appendChild(priceStock);

        card.appendChild(imgWrap);
        card.appendChild(body);
        similarContainer.appendChild(card);
      }
    }

    function computeSimilarGames(baseGame, maxCount) {
      const baseCats = new Set(
        (baseGame.categoriesRaw && baseGame.categoriesRaw.length > 0)
          ? baseGame.categoriesRaw
          : (baseGame.categories || [])
      );
      const baseMechs = new Set(
        (baseGame.mechanismsRaw && baseGame.mechanismsRaw.length > 0)
          ? baseGame.mechanismsRaw
          : (baseGame.mechanisms || [])
      );
      const baseWeight = baseGame.weight;

      const scored = [];
      for (const g of allGames) {
        if (g.id === baseGame.id) continue;
        const cats = new Set(
          (g.categoriesRaw && g.categoriesRaw.length > 0)
            ? g.categoriesRaw
            : (g.categories || [])
        );
        const mechs = new Set(
          (g.mechanismsRaw && g.mechanismsRaw.length > 0)
            ? g.mechanismsRaw
            : (g.mechanisms || [])
        );

        let overlapScore = 0;
        baseCats.forEach(c => { if (cats.has(c)) overlapScore += 2; });
        baseMechs.forEach(m => { if (mechs.has(m)) overlapScore += 3; });

        let weightPenalty = 0;
        if (baseWeight != null && g.weight != null) {
          weightPenalty = Math.abs(baseWeight - g.weight);
        }

        const finalScore = overlapScore - weightPenalty;
        scored.push({ game: g, score: finalScore });
      }

      scored.sort((a, b) => b.score - a.score);
      let picked = scored.filter(s => s.score > 0).slice(0, maxCount);

      // è‡³å°‘è¦ 5 å€‹ï¼Œä¸è¶³å°±è£œ
      if (picked.length < 5) {
        const usedIds = new Set(picked.map(p => p.game.id));
        for (const s of scored) {
          if (picked.length >= maxCount) break;
          if (usedIds.has(s.game.id)) continue;
          picked.push(s);
          usedIds.add(s.game.id);
        }
      }

      // æœ€å¾Œå† cut ä¸€æ¬¡ï¼Œä¿è­‰ <= maxCount
      picked = picked.slice(0, maxCount);
      return picked.map(p => p.game);
    }

    function closeModal() {
      modalBackdrop.classList.remove('show');
      currentGame = null;
    }

    // æ ¼å¼åŒ–å·¥å…·
    function formatRange(min, max, unit) {
      if (min == null && max == null) return '-';
      if (min != null && max != null && min !== max) {
        return `${min}-${max}${unit}`;
      }
      const v = (min != null ? min : max);
      return `${v}${unit}`;
    }

    function formatNumber(x) {
      if (x == null || Number.isNaN(x)) return '-';
      const n = Number(x);
      if (!Number.isFinite(n)) return '-';
      return n.toFixed(2);
    }

    // äº‹ä»¶ç¹«çµ
    function setupEvents() {
      searchInput.addEventListener('input', (e) => {
        state.searchText = e.target.value || '';
        applyFiltersAndRender();
      });

      sortSelect.addEventListener('change', (e) => {
        state.sortKey = e.target.value;
        applyFiltersAndRender();
      });

      clearFiltersBtn.addEventListener('click', () => {
        state.searchText = '';
        state.sortKey = 'name_zh';
        state.selectedCategories.clear();
        state.selectedMechanisms.clear();
        searchInput.value = '';
        sortSelect.value = 'name_zh';
        applyFiltersAndRender();
        syncPanelChipSelection();
      });

      refreshRandomBtn.addEventListener('click', () => {
        renderRandomPreview();
      });

      modalCloseBtn.addEventListener('click', () => {
        closeModal();
      });

      modalBackdrop.addEventListener('click', (ev) => {
        if (ev.target === modalBackdrop) {
          closeModal();
        }
      });

      window.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape' && modalBackdrop.classList.contains('show')) {
          closeModal();
        }
      });
    }

    // åˆå§‹åŒ–
    (async function init() {
      setupEvents();
      const raw = await fetchWithFallback();
      allGames = (raw || []).map(normalizeGame);
      buildTaxonomyMaps();
      initPanels();
      state.sortKey = 'name_zh';
      applyFiltersAndRender();
    })();
  </script>
</body>
</html>
