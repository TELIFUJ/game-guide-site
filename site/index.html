<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>桌遊導覽</title>

<!-- 基本樣式：RWD、卡片、按鈕 -->
<style>
:root {
  --max-width: 1200px;
  --card-radius: 14px;
  --chip-radius: 14px;
  --bg: #fafafa;
  --chip-bg: #eef2f7;
  --chip-text: #333;
  --border: #e0e0e0;
  --shadow: rgba(0,0,0,0.1);
}

body {
  font-family: system-ui, sans-serif;
  margin: 0;
  background: var(--bg);
}

/* 主要容器 */
.wrapper {
  max-width: var(--max-width);
  margin: 0 auto;
  padding: 12px;
}

/* 搜尋區 + 篩選列 */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

/* Input 與 Select 都統一設計 */
.filters input,
.filters select,
button {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 14px;
}

button {
  background: white;
  cursor: pointer;
}
button:hover {
  background: #f1f1f1;
}

/* 卡片區設定 */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 16px;
}

/* 卡片 */
.card {
  background: white;
  border-radius: var(--card-radius);
  border: 1px solid var(--border);
  box-shadow: 0 2px 4px var(--shadow);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* 卡片圖片：自動比例裁切 */
.card img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  background: #ddd;
}

/* 卡片內容 */
.card-body {
  padding: 10px 14px 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex: 1;
}

/* 遊戲名稱 */
.title {
  font-size: 16px;
  font-weight: 700;
  line-height: 1.3;
}

/* 英文副標 */
.subtitle {
  font-size: 13px;
  color: #666;
}

/* Chips（分類與機制） */
.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
}

.chip {
  padding: 3px 8px;
  background: var(--chip-bg);
  color: var(--chip-text);
  border-radius: var(--chip-radius);
  font-size: 12px;
}

/* 二手價格 / 庫存 */
.price-stock {
  margin-top: auto;
  font-size: 14px;
  color: #333;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
}

/* BGG 分數區 */
.rating {
  font-size: 14px;
  font-weight: 600;
  color: #3367d6;
}

/* 手機優化：卡片圖片略縮小高度 */
@media(max-width: 600px){
  .card img {
    height: 150px;
  }
  .title {
    font-size: 15px;
  }
}

/* 隨機預覽 modal */
#previewModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: none;
  justify-content: center;
  align-items: center;
  padding: 20px;
  z-index: 3000;
}

#previewModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
  box-shadow: 0 0 12px black;
}

#previewClose {
  position: absolute;
  top: 20px;
  right: 20px;
  background: white;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
}
</style>
</head>
<body>

<div class="wrapper">

  <!-- 搜尋與篩選區 -->
  <div class="filters">
    <input id="search" placeholder="搜尋：中文名 / EN / 關鍵字">
    <select id="catSelect"><option value="">全部分類</option></select>
    <select id="mechSelect"><option value="">全部機制</option></select>

    <select id="sortSelect">
      <option value="name_zh">按名稱</option>
      <option value="rating_bayes">BGG 榜分（貝葉斯）</option>
      <option value="rating_avg">玩家平均分</option>
      <option value="weight">重量</option>
      <option value="used_price_twd">二手價格</option>
    </select>

    <button id="randomBtn">隨機預覽</button>
  </div>

  <!-- 卡片容器 -->
  <div id="list" class="grid"></div>

</div>

<!-- 隨機預覽 modal -->
<div id="previewModal">
  <div id="previewClose">關閉</div>
  <img id="previewImg">
</div>

<script>
/* ========== 全域變數 ========== */
let DATA = [];
let UNIQUE_CATS = new Set();
let UNIQUE_MECHS = new Set();

/* ==========================================================
   讀取 JSON
========================================================== */
async function loadData(){
  try{
    const res = await fetch("data/games.json");
    DATA = await res.json();

    // 建立分類與機制（含中文）
    DATA.forEach(g=>{
      (g.categories_zh || g.categories || []).forEach(c=>UNIQUE_CATS.add(c));
      (g.mechanisms_zh || g.mechanisms || []).forEach(m=>UNIQUE_MECHS.add(m));
    });

    buildSelectors();
    render();
  }catch(e){
    console.error(e);
    document.getElementById("list").innerHTML =
      "<p style='padding:20px'>資料載入失敗</p>";
  }
}


/* ==========================================================
   建立分類、機制選單（含中文）
========================================================== */
function buildSelectors(){
  const catSelect = document.getElementById("catSelect");
  const mechSelect = document.getElementById("mechSelect");

  [...UNIQUE_CATS].sort().forEach(c=>{
    let opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    catSelect.appendChild(opt);
  });

  [...UNIQUE_MECHS].sort().forEach(m=>{
    let opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    mechSelect.appendChild(opt);
  });
}


/* ==========================================================
   主渲染：搜尋、篩選、排序 → 產生卡片
========================================================== */
function render(){
  const kw = document.getElementById("search").value.trim().toLowerCase();
  const cat = document.getElementById("catSelect").value;
  const mech = document.getElementById("mechSelect").value;
  const sortKey = document.getElementById("sortSelect").value;

  let list = DATA.filter(g=>{

    // 搜尋：中文、英文、作者、分類、機制都能搜
    let hit = false;
    const text = `
      ${g.name_zh||""}
      ${g.name_en||g.name||""}
      ${(g.categories_zh||g.categories||[]).join(" ")}
      ${(g.mechanisms_zh||g.mechanisms||[]).join(" ")}
    `.toLowerCase();
    if(!kw || text.includes(kw)) hit = true;
    if(!hit) return false;

    // 分類
    if(cat){
      const cats = g.categories_zh || g.categories || [];
      if(!cats.includes(cat)) return false;
    }

    // 機制
    if(mech){
      const mechs = g.mechanisms_zh || g.mechanisms || [];
      if(!mechs.includes(mech)) return false;
    }

    return true;
  });

  // 排序
  list.sort((a,b)=>{
    let A = a[sortKey] ?? 0;
    let B = b[sortKey] ?? 0;
    if(typeof A === "string") A = A.toLowerCase();
    if(typeof B === "string") B = B.toLowerCase();
    return A > B ? 1 : -1;
  });

  // 渲染
  const box = document.getElementById("list");
  box.innerHTML = list.map(g=>createCard(g)).join("");
}


/* ==========================================================
   卡片模板（含圖片、分類 Chips、BGG 分數、庫存、二手價）
========================================================== */
function createCard(g){
  const img = g.image || g.thumbnail || "assets/img/noimg.png";

  const cats = (g.categories_zh || g.categories || [])
    .map(c=>`<span class="chip">${c}</span>`).join("");

  const mechs = (g.mechanisms_zh || g.mechanisms || [])
    .map(m=>`<span class="chip">${m}</span>`).join("");

  return `
  <div class="card">
    <img src="${img}" onclick="openPreview('${img}')">

    <div class="card-body">
      <div class="title">${g.name_zh || g.name}</div>
      <div class="subtitle">${g.name_en || ""}</div>

      <div class="rating">BGG：${g.rating_bayes ?? "—"}</div>

      <div class="chips">${cats}${mechs}</div>

      <div class="price-stock">
        <span>${g.used_price_twd ? "二手 $" + g.used_price_twd : ""}</span>
        <span>${g.stock ? "庫存：" + g.stock : ""}</span>
      </div>
    </div>
  </div>
  `;
}
/* ==========================================================
   隨機預覽（從所有遊戲中抽 1 張圖）
========================================================== */
function openRandom(){
  if(!DATA.length) return;
  const g = DATA[Math.floor(Math.random()*DATA.length)];
  const img = g.image || g.thumbnail || "assets/img/noimg.png";
  openPreview(img);
}

/* 開啟預覽 Modal */
function openPreview(src){
  document.getElementById("previewImg").src = src;
  document.getElementById("previewModal").style.display = "flex";
}

/* 關閉預覽 Modal */
function closePreview(){
  document.getElementById("previewModal").style.display = "none";
}
document.getElementById("previewClose").onclick = closePreview;

/* 按下 ESC 關閉預覽 */
document.addEventListener("keydown", e=>{
  if(e.key === "Escape") closePreview();
});


/* ==========================================================
   搜尋 & 篩選 & 排序事件綁定
========================================================== */
document.getElementById("search").addEventListener("input", render);
document.getElementById("catSelect").addEventListener("change", render);
document.getElementById("mechSelect").addEventListener("change", render);
document.getElementById("sortSelect").addEventListener("change", render);
document.getElementById("randomBtn").addEventListener("click", openRandom);


/* ==========================================================
   啟動
========================================================== */
loadData();
</script>

</body>
</html>
