# --- 在 scripts/fetch_bgg.py 中，替換 parse_items 為下方版本 ---
def parse_items(root):
    def float_or_none(v):
        try:
            return None if v in (None, "NaN", "N/A") else float(v)
        except:
            return None
    def int_or_none(v):
        try:
            return None if v in (None, "0", "N/A", "Not Ranked") else int(v)
        except:
            return None

    out=[]
    for item in root.findall("item"):
        try:
            bid=int(item.get("id"))
        except:
            continue

        # 名稱
        name_en=None
        for n in item.findall("name"):
            if n.get("type")=="primary":
                name_en=n.get("value")
                break

        # 常用小工具
        def val(tag, attr="value"):
            el=item.find(tag)
            return el.get(attr) if el is not None and el.get(attr) is not None else None

        # 重量（策略強度）
        avgw=item.find("statistics/ratings/averageweight")
        weight=float_or_none(avgw.get("value")) if avgw is not None else None

        # 影像
        image_el=item.find("image"); thumb_el=item.find("thumbnail")
        image_url=image_el.text if image_el is not None else None
        thumb_url=thumb_el.text if thumb_el is not None else None

        # 類別 / 機制
        categories=[l.get("value") for l in item.findall("link[@type='boardgamecategory']")]
        mechanics=[l.get("value") for l in item.findall("link[@type='boardgamemechanic']")]

        # 版本數
        versions_el=item.find("versions")
        versions_count=len(versions_el.findall("item")) if versions_el is not None else 0

        # ===== 新增：評分、排名、評分人數 =====
        ratings = item.find("statistics/ratings")
        rating_avg = rating_bayes = None
        users_rated = None
        rank_overall = None

        if ratings is not None:
            a = ratings.find("average")
            b = ratings.find("bayesaverage")
            u = ratings.find("usersrated")
            rating_avg   = float_or_none(a.get("value")) if a is not None else None
            rating_bayes = float_or_none(b.get("value")) if b is not None else None
            users_rated  = int_or_none(u.get("value")) if u is not None else None

            ranks = ratings.find("ranks")
            if ranks is not None:
                for r in ranks.findall("rank"):
                    # BGG 總榜（Overall）標識：name="boardgame"
                    if (r.get("name") or "").lower() == "boardgame":
                        rank_overall = int_or_none(r.get("value"))
                        break

        out.append({
            "bgg_id": bid,
            "name_en": name_en,
            "year": int_or_none(val("yearpublished")),
            "players": [int_or_none(val("minplayers")), int_or_none(val("maxplayers"))],
            "time_min": int_or_none(val("minplaytime")),
            "time_max": int_or_none(val("maxplaytime")),
            "weight": weight,
            "categories": categories,
            "mechanics": mechanics,
            "image_url": image_url or thumb_url,
            "thumb_url": thumb_url or image_url,
            "versions_count": versions_count,

            # 新增欄位（HTML 已使用）
            "rating_avg": rating_avg,
            "rating_bayes": rating_bayes,
            "users_rated": users_rated,
            "rank_overall": rank_overall,
        })
    return out
