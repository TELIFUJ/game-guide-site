<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Board Game Guide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font:16px/1.5 system-ui;margin:20px}
    .filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{border:1px solid #ddd;padding:10px;border-radius:8px;background:#fff}
    .card img{width:100%;height:160px;object-fit:cover;border-radius:4px;background:#f7f7f7}
    .row{display:flex;gap:8px;align-items:center}
    .price{font-weight:700}
    .note{font-size:12px;color:#555;margin-top:4px}
    input,select{padding:6px 8px;border:1px solid #ccc;border-radius:6px}
    .chip{display:inline-block;padding:2px 8px;margin-right:6px;margin-top:4px;border:1px solid #ccc;border-radius:999px;font-size:12px}
  </style>
</head>
<body>

<form class="filters" autocomplete="off" onsubmit="return false">
  <input id="q" name="q_no_autofill"
         placeholder="搜尋：中文名 / EN / 關鍵字" style="min-width:200px"
         autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <select id="cat"><option value="">全部分類</option></select>
  <input id="pmin" name="pmin_no_autofill" type="number" placeholder="最低價"
         autocomplete="off" inputmode="numeric" spellcheck="false">
  <input id="pmax" name="pmax_no_autofill" type="number" placeholder="最高價"
         autocomplete="off" inputmode="numeric" spellcheck="false">
  <select id="sort">
    <option value="">排序</option>
    <option value="price">售價（低→高）</option>
    <option value="used">二手價（低→高）</option>
    <option value="weight">策略強度（低→高）</option>
  </select>
</form>

<div id="grid" class="grid"></div>
<div id="err" style="color:#c00;margin-top:12px;"></div>

<script>
  // 動態更名避免瀏覽器自動填入
  document.getElementById('q')
    .setAttribute('name','q_'+Math.random().toString(36).slice(2));

  const G   = document.getElementById("grid");
  const ERR = document.getElementById("err");
  const Q   = document.getElementById("q");
  const C   = document.getElementById("cat");
  const S   = document.getElementById("sort");
  const PMIN= document.getElementById("pmin");
  const PMAX= document.getElementById("pmax");

  // 依所在路徑自動決定 JSON 位置（根目錄或 /site/ 都能用）
  const DATA_URL = (location.pathname.includes('/site/')
        ? '../data/games_full.json'
        : 'data/games_full.json') + '?ts=' + Date.now();

  let DATA = [];

  // 取分類（中文優先，退回英文），最多 10 個
  const getCats = (x) => (x.categories_zh && x.categories_zh.length
                        ? x.categories_zh
                        : (x.categories || []))
                        .slice(0, 10);

  // 價格塊
  function priceBlock(x){
    const msrp = x.price_msrp_twd, price = x.price_twd, used = x.used_price_twd;
    let lines = [];
    if (price != null) lines.push(`$${price.toLocaleString()}`);
    if (used  != null) lines.push(`｜二手 $${used.toLocaleString()}`);
    const main = lines.join(' ');
    const notes = [x.price_note, x.used_note].filter(Boolean).join('；');
    const msrpNote = (msrp!=null) ? `新品參考價（未打折）$${msrp.toLocaleString()}` : '';
    return `
      <div class="price">${main}</div>
      ${msrpNote ? `<div class="note">${msrpNote}</div>` : ''}
      ${notes ? `<div class="note">${notes}</div>` : ''}
    `;
  }

  // 初始化
  fetch(DATA_URL).then(r=>{
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }).then(d=>{
    DATA = d;
    // 下拉分類（中文優先）
    const cats = [...new Set(DATA.flatMap(getCats))].sort();
    cats.forEach(c=>{
      const o=document.createElement('option');
      o.value=c; o.textContent=c; C.appendChild(o);
    });
    render();
    [Q,C,S,PMIN,PMAX].forEach(el=>el.addEventListener('input',render));
  }).catch(e=>{
    console.error('載入資料失敗：', e);
    ERR.textContent = '讀取資料失敗：' + e.message + '（請確認 /data/games_full.json 是否存在，或路徑是否正確）';
  });

  function render(){
    let list = DATA.slice();

    // 搜尋
    const q = Q.value.trim().toLowerCase();
    if(q){
      list = list.filter(x=>{
        const blob = [
          x.name_zh||"", x.name_en||"",
          ...(x.aliases_zh||[]), ...(x.search_keywords||[])
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    // 分類（中文優先）
    const cat = C.value;
    if(cat) list = list.filter(x => getCats(x).includes(cat));

    // 價格區間（售價）
    const pmin = Number(PMIN.value||0), pmax = Number(PMAX.value||0);
    if(pmin>0) list = list.filter(x => (x.price_twd??1e12) >= pmin);
    if(pmax>0) list = list.filter(x => (x.price_twd??1e12) <= pmax);

    // 排序
    if(S.value==="price")  list.sort((a,b)=>(a.price_twd??1e12)-(b.price_twd??1e12));
    if(S.value==="used")   list.sort((a,b)=>(a.used_price_twd??1e12)-(b.used_price_twd??1e12));
    if(S.value==="weight") list.sort((a,b)=>(a.weight??1e12)-(b.weight??1e12));

    // 卡片
    G.innerHTML = list.map(x => {
      const img = (x.image||'').startsWith('http') ? x.image
                 : ((location.pathname.includes('/site/') ? '../' : '') + (x.image||''));
      const cats = getCats(x).map(t=>`<span class="chip">${t}</span>`).join('');
      return `
        <div class="card">
          <img loading="lazy"
               src="${img}"
               alt="${x.name_zh||x.name_en||''}"
               onerror="this.src='https://via.placeholder.com/300x160?text=No+Image'">
          <h3>${x.name_zh||x.name_en||''}</h3>
          <div>${x.name_en?`<small>${x.name_en}</small>`:''}</div>
          <div>${cats}</div>
          ${priceBlock(x)}
          <div class="note">${x.description||''}</div>
          <div><a href="${x.bgg_url||'#'}" target="_blank" rel="nofollow noopener">BGG</a></div>
        </div>
      `;
    }).join('');
  }
</script>
</body>
</html>
