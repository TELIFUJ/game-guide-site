<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Board Game Guide</title>
  <style>
    :root {
      --c-bg: #f5f7fb;
      --c-surface: #ffffff;
      --c-border: #d0d7e2;
      --c-border-strong: #1e90ff;
      --c-text: #222222;
      --c-muted: #6b7280;
      --c-accent: #2563eb;
      --c-accent-soft: #e0edff;
      --c-danger: #dc2626;
      --c-chip-bg: #eef2ff;
      --c-chip-border: #c7d2fe;
      --c-chip-active-bg: #2563eb;
      --c-chip-active-text: #ffffff;
      --shadow-soft: 0 4px 12px rgba(15, 23, 42, 0.08);
      --radius-lg: 18px;
      --radius-xl: 22px;
      --radius-pill: 999px;
      --card-img-ratio: 4 / 5;
      --toolbar-max-width: 1280px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
      background: var(--c-bg);
      color: var(--c-text);
    }

    a {
      color: var(--c-accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .page {
      max-width: 1320px;
      margin: 0 auto;
      padding: 16px 12px 32px;
    }

    header.page-header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px 16px;
      margin-bottom: 16px;
    }

    header.page-header h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.06em;
    }

    header.page-header .subtitle {
      font-size: 13px;
      color: var(--c-muted);
    }

    .toolbar {
      max-width: var(--toolbar-max-width);
      background: var(--c-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 10px 14px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) repeat(4, minmax(0, 1fr)) auto;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      margin-top: 8px;
      font-size: 13px;
      color: var(--c-muted);
    }

    .toolbar-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-row button.small {
      font-size: 12px;
      padding: 4px 10px;
    }

    .search-input {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-input input {
      width: 100%;
      padding: 8px 10px;
      padding-left: 28px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-border);
      font-size: 14px;
      outline: none;
    }

    .search-input input:focus {
      border-color: var(--c-border-strong);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    .search-input::before {
      content: "ğŸ”";
      position: absolute;
      left: 8px;
      font-size: 13px;
      opacity: 0.6;
    }

    select,
    button.toolbar-btn {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-border);
      background: #ffffff;
      font-size: 13px;
      cursor: pointer;
      text-align: left;
    }

    button.toolbar-btn.primary {
      background: var(--c-accent);
      color: #ffffff;
      border-color: var(--c-accent);
      text-align: center;
    }

    button.toolbar-btn.danger {
      border-color: var(--c-danger);
      color: var(--c-danger);
      text-align: center;
    }

    button.toolbar-btn.primary:hover {
      background: #1d4ed8;
    }

    button.toolbar-btn:hover {
      border-color: var(--c-border-strong);
    }

    .stats-bar {
      margin: 4px 4px 10px;
      font-size: 13px;
      color: var(--c-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
    }

    .stats-bar .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: var(--c-chip-bg);
      border: 1px solid var(--c-chip-border);
      font-size: 12px;
      color: var(--c-muted);
    }

    .stats-bar .badge strong {
      color: var(--c-text);
    }

    /* Recommendation panel */

    .recommendation-panel {
      background: var(--c-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px 14px;
      margin-bottom: 16px;
    }

    .recommendation-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .recommendation-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .recommendation-header small {
      color: var(--c-muted);
      font-size: 12px;
    }

    .recommendation-layout {
      display: grid;
      grid-template-columns: minmax(0, 280px) minmax(0, 1fr);
      gap: 16px;
    }

    .rec-main-game {
      display: flex;
      gap: 10px;
    }

    .rec-main-game img {
      width: 96px;
      height: auto;
      border-radius: 12px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .rec-main-meta {
      font-size: 13px;
    }

    .rec-main-meta .title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .rec-main-meta .meta-line {
      color: var(--c-muted);
      margin-bottom: 4px;
    }

    .rec-main-meta .chips-line {
      margin-top: 4px;
    }

    .rec-main-meta .price-line {
      margin-top: 4px;
      font-size: 13px;
    }

    .rec-main-meta .price-line strong {
      margin-right: 6px;
    }

    .rec-main-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .rec-main-actions button {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-border);
      background: #ffffff;
      font-size: 12px;
      cursor: pointer;
    }

    .rec-main-actions button.primary {
      border-color: var(--c-accent);
      background: var(--c-accent-soft);
      color: var(--c-accent);
    }

    .rec-main-actions button:hover {
      border-color: var(--c-border-strong);
    }

    .rec-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
      font-size: 12px;
    }

    .rec-card {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px;
      border-radius: 14px;
      border: 1px solid var(--c-border);
      background: #ffffff;
      cursor: pointer;
      transition: box-shadow 0.15s ease, transform 0.15s ease, border-color 0.15s ease;
    }

    .rec-card:hover {
      box-shadow: var(--shadow-soft);
      transform: translateY(-1px);
      border-color: var(--c-border-strong);
    }

    .rec-card img {
      width: 100%;
      aspect-ratio: var(--card-img-ratio);
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 4px;
    }

    .rec-card .name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .rec-card .meta {
      color: var(--c-muted);
      font-size: 11px;
      margin-bottom: 2px;
    }

    .rec-card .price-stock {
      font-size: 11px;
    }

    /* Main grid */

    .grid-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin: 6px 4px 8px;
      font-size: 13px;
      color: var(--c-muted);
    }

    .pager {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }

    .pager button {
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-border);
      background: #ffffff;
      font-size: 12px;
      cursor: pointer;
    }

    .pager button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .pager button:not(:disabled):hover {
      border-color: var(--c-border-strong);
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 14px;
    }

    .game-card {
      background: var(--c-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.14s ease, box-shadow 0.14s ease, border-color 0.14s ease;
      border: 1px solid transparent;
    }

    .game-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
      border-color: var(--c-border-strong);
    }

    .game-card-header {
      display: flex;
      gap: 10px;
    }

    .game-card img {
      width: 120px;
      aspect-ratio: var(--card-img-ratio);
      border-radius: 14px;
      object-fit: cover;
      flex-shrink: 0;
      background: #e5e7eb;
    }

    .game-card-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .game-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
      line-height: 1.35;
    }

    .game-title small {
      font-weight: 400;
      font-size: 12px;
      color: var(--c-muted);
      margin-left: 4px;
    }

    .rating-line {
      font-size: 12px;
      color: var(--c-muted);
    }

    .rating-line span + span::before {
      content: "ï½œ";
      margin: 0 4px;
      color: #d1d5db;
    }

    .price-stock-line {
      font-size: 12px;
      margin-top: 2px;
    }

    .price-stock-line span + span::before {
      content: "ï½œ";
      margin: 0 4px;
      color: #d1d5db;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .chip {
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-chip-border);
      background: var(--c-chip-bg);
      padding: 2px 8px;
      font-size: 11px;
      color: var(--c-muted);
      cursor: pointer;
      white-space: nowrap;
    }

    .chip.mechanism {
      border-style: dashed;
    }

    .chip.active {
      background: var(--c-chip-active-bg);
      border-color: var(--c-chip-active-bg);
      color: var(--c-chip-active-text);
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .card-footer-left {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--c-muted);
    }

    .card-footer-right {
      display: flex;
      gap: 6px;
    }

    .pill-btn {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-border);
      background: #ffffff;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-btn.primary {
      border-color: var(--c-accent);
      background: var(--c-accent-soft);
      color: var(--c-accent);
    }

    .pill-btn.icon {
      padding-inline: 8px;
    }

    .pill-btn[disabled] {
      opacity: 0.4;
      cursor: default;
    }

    .pill-btn:hover:not([disabled]) {
      border-color: var(--c-border-strong);
    }

    .pill-btn .star {
      font-size: 13px;
    }

    .game-card.favorited {
      border-color: #facc15;
    }

    .game-card.duplicate {
      box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.4), var(--shadow-soft);
    }

    /* Mechanism bottom sheet */

    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.28);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 40;
    }

    .sheet-backdrop.open {
      display: flex;
    }

    .sheet {
      width: 100%;
      max-width: 900px;
      max-height: 70vh;
      background: var(--c-surface);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -6px 16px rgba(15, 23, 42, 0.18);
      padding: 10px 14px 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .sheet-header-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sheet-header-title strong {
      font-size: 14px;
    }

    .sheet-header-title span {
      color: var(--c-muted);
      font-size: 12px;
    }

    .sheet-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .sheet-actions button {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-border);
      background: #ffffff;
      font-size: 12px;
      cursor: pointer;
    }

    .sheet-actions button.primary {
      border-color: var(--c-accent);
      background: var(--c-accent-soft);
      color: var(--c-accent);
    }

    .sheet-actions button.danger {
      border-color: var(--c-danger);
      color: var(--c-danger);
    }

    .sheet-body {
      overflow: auto;
      padding-top: 4px;
    }

    .sheet-chip-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .sheet-chip {
      border-radius: var(--radius-pill);
      border: 1px solid var(--c-chip-border);
      background: var(--c-chip-bg);
      padding: 3px 9px;
      font-size: 11px;
      color: var(--c-muted);
      cursor: pointer;
      white-space: nowrap;
    }

    .sheet-chip strong {
      color: var(--c-text);
      margin-right: 4px;
    }

    .sheet-chip span.count {
      font-size: 10px;
      color: var(--c-muted);
    }

    .sheet-chip.selected {
      background: var(--c-chip-active-bg);
      border-color: var(--c-chip-active-bg);
      color: var(--c-chip-active-text);
    }

    /* Responsive */

    @media (max-width: 960px) {
      .toolbar {
        grid-template-columns: minmax(0, 1.7fr) repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 768px) {
      .page {
        padding-inline: 10px;
      }

      .toolbar {
        grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.2fr);
      }

      .recommendation-layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .game-card-header {
        flex-direction: column;
      }

      .game-card img {
        width: 100%;
      }
    }

    @media (max-width: 540px) {
      header.page-header h1 {
        font-size: 20px;
      }

      .toolbar {
        grid-template-columns: minmax(0, 1fr);
      }

      .recommendation-panel {
        padding: 12px 10px 10px;
      }

      .card-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1>Board Game Guide</h1>
      <div class="subtitle">é€¢ç”²æ¡ŒéŠåº—ï½œç§Ÿå€Ÿèˆ‡äºŒæ‰‹æ¸…å–®å°è¦½ï¼ˆæœ¬åœ° CSV ï¼‹ BGG è©•åˆ†è³‡æ–™ï¼‰</div>
    </header>

    <section class="toolbar" aria-label="ç¯©é¸èˆ‡æ’åº">
      <div class="search-input">
        <input id="search-input" type="search" placeholder="æœå°‹ï¼šä¸­æ–‡ï¼è‹±æ–‡ï¼åŸåï¼åˆ†é¡ï¼æ©Ÿåˆ¶" />
      </div>

      <select id="category-select" title="åˆ†é¡">
        <option value="ALL">å…¨éƒ¨åˆ†é¡</option>
      </select>

      <button id="mechanism-button" class="toolbar-btn" type="button">å…¨éƒ¨æ©Ÿåˆ¶</button>

      <select id="sort-select" title="æ’åº">
        <option value="name_zh,asc">æŒ‰åç¨±ï¼ˆä¸­æ–‡ï¼‰</option>
        <option value="rating_bayes,desc">Bayes è©•åˆ†ï¼ˆé«˜â†’ä½ï¼‰</option>
        <option value="rating_avg,desc">å‡åˆ†ï¼ˆé«˜â†’ä½ï¼‰</option>
        <option value="users_rated,desc">è©•åˆ†äººæ•¸ï¼ˆå¤šâ†’å°‘ï¼‰</option>
        <option value="weight,asc">é‡åº¦ï¼ˆè¼•â†’é‡ï¼‰</option>
        <option value="weight,desc">é‡åº¦ï¼ˆé‡â†’è¼•ï¼‰</option>
        <option value="used_price_twd,asc">äºŒæ‰‹åƒ¹ï¼ˆä½â†’é«˜ï¼‰</option>
        <option value="used_price_twd,desc">äºŒæ‰‹åƒ¹ï¼ˆé«˜â†’ä½ï¼‰</option>
      </select>

      <select id="page-size-select" title="æ¯é ç­†æ•¸">
        <option value="25">æ¯é  25 ç­†</option>
        <option value="50">æ¯é  50 ç­†</option>
        <option value="100">æ¯é  100 ç­†</option>
      </select>

      <button id="random-button" class="toolbar-btn primary" type="button">éš¨æ©Ÿé è¦½</button>

      <div class="toolbar-row">
        <label><input id="only-fav-checkbox" type="checkbox" /> åªçœ‹æ”¶è—</label>
        <label><input id="only-dup-checkbox" type="checkbox" /> åªçœ‹é‡è¤‡å“é …</label>
        <button id="download-fav-btn" class="small pill-btn" type="button">ä¸‹è¼‰æ”¶è—æ¸…å–®ï¼ˆCSVï¼‰</button>
        <button id="clear-filter-btn" class="small pill-btn" type="button">æ¸…é™¤ç¯©é¸</button>
        <span id="dup-stat" class="badge"></span>
      </div>
    </section>

    <div class="stats-bar">
      <span>ç¸½æ•¸ <strong id="total-count">0</strong> æ¬¾ï¼Œç¬¦åˆç¯©é¸
        <strong id="filtered-count">0</strong> æ¬¾ï¼Œé¡¯ç¤ºç¬¬
        <strong id="range-from">0</strong>â€“<strong id="range-to">0</strong>
        ç­†ï¼ˆç¬¬ <strong id="page-index">1</strong> / <strong id="page-count">1</strong> é ï¼‰</span>
      <span id="mechanism-stat" class="badge"></span>
      <span id="category-stat" class="badge"></span>
    </div>

    <section class="recommendation-panel" aria-label="ç›®å‰é¸å–çš„éŠæˆ²èˆ‡æ¨è–¦">
      <div class="recommendation-header">
        <div>
          <h2>ç›®å‰é¸å–çš„éŠæˆ² &amp; ä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡</h2>
          <small id="rec-subtitle">è«‹å…ˆå¾ä¸‹æ–¹å¡ç‰‡é»é¸ä¸€æ¬¾éŠæˆ²ï¼Œæˆ–ä½¿ç”¨ã€Œéš¨æ©Ÿé è¦½ã€ã€‚</small>
        </div>
        <button id="close-rec-btn" class="pill-btn icon" type="button">é—œé–‰</button>
      </div>
      <div class="recommendation-layout">
        <div id="rec-main" class="rec-main-game"></div>
        <div id="rec-list" class="rec-list"></div>
      </div>
    </section>

    <div class="grid-toolbar">
      <div class="pager">
        <button id="prev-page-btn" type="button">ä¸Šä¸€é </button>
        <span id="page-label">ç¬¬ 1 / 1 é </span>
        <button id="next-page-btn" type="button">ä¸‹ä¸€é </button>
      </div>
      <div>é»æ“Šå¡ç‰‡å¯æ›´æ–°ä¸Šæ–¹ã€Œä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡ã€çš„æ¨è–¦çµæœã€‚</div>
    </div>

    <section id="card-grid" class="card-grid" aria-label="éŠæˆ²æ¸…å–®"></section>

    <div class="grid-toolbar">
      <div class="pager">
        <button id="prev-page-btn-bottom" type="button">ä¸Šä¸€é </button>
        <span id="page-label-bottom">ç¬¬ 1 / 1 é </span>
        <button id="next-page-btn-bottom" type="button">ä¸‹ä¸€é </button>
      </div>
      <div></div>
    </div>
  </div>

  <!-- Mechanism bottom sheet -->
  <div id="sheet-backdrop" class="sheet-backdrop" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheet-title">
      <div class="sheet-header">
        <div class="sheet-header-title">
          <strong id="sheet-title">é¸æ“‡æ©Ÿåˆ¶ï¼ˆå¯è¤‡é¸ï¼‰</strong>
          <span id="sheet-subtitle">é»é¸æ©Ÿåˆ¶ chips ä»¥åŠ å…¥æˆ–ç§»é™¤ç¯©é¸æ¢ä»¶ã€‚</span>
        </div>
        <div class="sheet-actions">
          <button id="sheet-clear-btn" class="danger" type="button">å…¨éƒ¨æ¸…é™¤</button>
          <button id="sheet-apply-btn" class="primary" type="button">å¥—ç”¨</button>
          <button id="sheet-close-btn" type="button">é—œé–‰</button>
        </div>
      </div>
      <div class="sheet-body">
        <div id="sheet-chip-grid" class="sheet-chip-grid"></div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // å…¨åŸŸç‹€æ…‹
    // -----------------------------
    let ALL_GAMES = [];
    let FILTERED = [];
    let CURRENT_PAGE = 1;
    let PAGE_SIZE = 25;

    let SELECTED_CATEGORY = "ALL";
    let SELECTED_MECHANISMS = new Set();
    let SEARCH_TEXT = "";
    let SORT_KEY = "name_zh";
    let SORT_DIR = "asc";
    let ONLY_FAVORITES = false;
    let ONLY_DUPLICATES = false;

    let FAVORITE_IDS = new Set();
    let MECHANISM_STATS = {};
    let CATEGORY_STATS = {};
    let DUPLICATE_IDS = new Set();

    let CURRENT_SELECTED_GAME = null;

    const FAV_KEY = "bgg_favorites_v1";

    // -----------------------------
    // åˆå§‹åŒ–
    // -----------------------------
    document.addEventListener("DOMContentLoaded", () => {
      initFavorites();
      loadGames()
        .then((games) => {
          ALL_GAMES = games;
          enrichGames(ALL_GAMES);
          buildStats(ALL_GAMES);
          initControls();
          applyFiltersAndRender();
        })
        .catch((err) => {
          console.error(err);
          alert("è¼‰å…¥ data/games.json å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        });
    });

    // -----------------------------
    // è¼‰å…¥ JSONï¼ˆæ”¯æ´ /data èˆ‡ /site/dataï¼‰
    // -----------------------------
    async function loadGames() {
      const candidates = [
        "data/games.json",
        "site/data/games.json",
        "/data/games.json",
        "/site/data/games.json",
      ];

      for (const url of candidates) {
        try {
          const resp = await fetch(url, { cache: "no-store" });
          if (resp.ok) {
            const data = await resp.json();
            console.log("[INFO] Loaded games from", url, "rows=", data.length);
            return data;
          }
        } catch (e) {
          console.warn("[WARN] load failed for", url, e);
        }
      }
      throw new Error("æ‰¾ä¸åˆ°ä»»ä½• games.jsonï¼ˆå·²å˜—è©¦ data/ èˆ‡ site/data/ï¼‰");
    }

    // -----------------------------
    // è³‡æ–™å¢è£œï¼šé¡¯ç¤ºåç¨±ã€æ©Ÿåˆ¶æ•¸ç­‰
    // -----------------------------
    function enrichGames(list) {
      for (const g of list) {
        g.name_zh = g.name_zh || g.name || g.name_en || "";
        g.name_en = g.name_en || g.name || "";
        g.display_name = g.name_zh || g.name_en || "";
        g.categories = Array.isArray(g.categories) ? g.categories : [];
        g.mechanisms = Array.isArray(g.mechanisms) ? g.mechanisms : [];
        g.mechanism_count = g.mechanism_count || g.mechanisms.length || 0;
        g.weight = typeof g.weight === "number" ? g.weight : null;
        g.rating_bayes = typeof g.rating_bayes === "number" ? g.rating_bayes : null;
        g.rating_avg = typeof g.rating_avg === "number"
          ? g.rating_avg
          : (typeof g.rating === "number" ? g.rating : null);
        if (g.users_rated == null && g.usersrated != null) g.users_rated = g.usersrated;
        g.users_rated = typeof g.users_rated === "number" ? g.users_rated : null;
        g.used_price_twd = g.used_price_twd != null ? g.used_price_twd : null;
        g.stock = g.stock != null ? g.stock : null;
        g.bgg_id = g.bgg_id || g.id_bgg || null;
        if (!g.bgg_url && g.bgg_id) {
          g.bgg_url = "https://boardgamegeek.com/boardgame/" + g.bgg_id;
        }
      }
    }

    // -----------------------------
    // çµ±è¨ˆåˆ†é¡ï¼æ©Ÿåˆ¶ï¼é‡è¤‡å“é …
    // -----------------------------
    function buildStats(list) {
      MECHANISM_STATS = {};
      CATEGORY_STATS = {};
      const duplicateKeyCount = {};

      for (const g of list) {
        const mechSet = new Set(g.mechanisms || []);
        for (const m of mechSet) {
          MECHANISM_STATS[m] = (MECHANISM_STATS[m] || 0) + 1;
        }
        const catSet = new Set(g.categories || []);
        for (const c of catSet) {
          CATEGORY_STATS[c] = (CATEGORY_STATS[c] || 0) + 1;
        }
        const key = g.bgg_id || g.name_zh || g.name_en || g.name || "";
        if (key) {
          duplicateKeyCount[key] = (duplicateKeyCount[key] || 0) + 1;
        }
      }

      DUPLICATE_IDS = new Set();
      const approx = new Set();
      for (const g of list) {
        const key = g.bgg_id || g.name_zh || g.name_en || g.name || "";
        if (key && duplicateKeyCount[key] > 1) {
          DUPLICATE_IDS.add(g.id);
          approx.add(key);
        }
      }

      const dupStat = document.getElementById("dup-stat");
      const dupKinds = approx.size;
      if (dupStat) {
        dupStat.textContent = `åµæ¸¬åˆ°é‡è¤‡å“é …ç´„ ${dupKinds} ç­†ï¼ˆä»¥ BGGï¼åç¨±æ¨ä¼°ï¼‰`;
      }

      const mechStatEl = document.getElementById("mechanism-stat");
      if (mechStatEl) {
        const mechCount = Object.keys(MECHANISM_STATS).length;
        mechStatEl.innerHTML = `æ©Ÿåˆ¶ <strong>${mechCount}</strong> ç¨®`;
      }
      const catStatEl = document.getElementById("category-stat");
      if (catStatEl) {
        const catCount = Object.keys(CATEGORY_STATS).length;
        catStatEl.innerHTML = `åˆ†é¡ <strong>${catCount}</strong> ç¨®`;
      }
    }

    // -----------------------------
    // æ”¶è—ï¼ˆlocalStorageï¼‰
    // -----------------------------
    function initFavorites() {
      try {
        const raw = localStorage.getItem(FAV_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) {
          FAVORITE_IDS = new Set(arr);
        }
      } catch (e) {
        console.warn("load favorites failed", e);
      }
    }

    function saveFavorites() {
      try {
        const arr = Array.from(FAVORITE_IDS);
        localStorage.setItem(FAV_KEY, JSON.stringify(arr));
      } catch (e) {
        console.warn("save favorites failed", e);
      }
    }

    function toggleFavorite(id) {
      if (FAVORITE_IDS.has(id)) {
        FAVORITE_IDS.delete(id);
      } else {
        FAVORITE_IDS.add(id);
      }
      saveFavorites();
      applyFiltersAndRender(false); // ä¸é‡ç½®é æ•¸
    }

    // -----------------------------
    // UI æ§åˆ¶é …åˆå§‹åŒ–
    // -----------------------------
    function initControls() {
      const totalCountEl = document.getElementById("total-count");
      totalCountEl.textContent = ALL_GAMES.length.toString();

      // åˆ†é¡ä¸‹æ‹‰
      const catSelect = document.getElementById("category-select");
      const cats = Object.keys(CATEGORY_STATS).sort((a, b) =>
        a.localeCompare(b, "zh-Hant")
      );
      for (const c of cats) {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        catSelect.appendChild(opt);
      }

      catSelect.addEventListener("change", () => {
        SELECTED_CATEGORY = catSelect.value || "ALL";
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
      });

      // æœå°‹
      const searchInput = document.getElementById("search-input");
      searchInput.addEventListener("input", () => {
        SEARCH_TEXT = searchInput.value.trim();
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
      });

      // æ’åº
      const sortSelect = document.getElementById("sort-select");
      sortSelect.addEventListener("change", () => {
        const val = sortSelect.value || "name_zh,asc";
        const [key, dir] = val.split(",");
        SORT_KEY = key;
        SORT_DIR = dir || "asc";
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
      });

      // æ¯é ç­†æ•¸
      const pageSizeSelect = document.getElementById("page-size-select");
      PAGE_SIZE = parseInt(pageSizeSelect.value, 10) || 25;
      pageSizeSelect.addEventListener("change", () => {
        PAGE_SIZE = parseInt(pageSizeSelect.value, 10) || 25;
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
      });

      // åªçœ‹æ”¶è—ï¼åªçœ‹é‡è¤‡
      const favCheckbox = document.getElementById("only-fav-checkbox");
      favCheckbox.addEventListener("change", () => {
        ONLY_FAVORITES = favCheckbox.checked;
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
      });

      const dupCheckbox = document.getElementById("only-dup-checkbox");
      dupCheckbox.addEventListener("change", () => {
        ONLY_DUPLICATES = dupCheckbox.checked;
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
      });

      // æ¸…é™¤ç¯©é¸
      const clearBtn = document.getElementById("clear-filter-btn");
      clearBtn.addEventListener("click", () => {
        SEARCH_TEXT = "";
        SELECTED_CATEGORY = "ALL";
        SELECTED_MECHANISMS.clear();
        ONLY_FAVORITES = false;
        ONLY_DUPLICATES = false;
        SORT_KEY = "name_zh";
        SORT_DIR = "asc";
        PAGE_SIZE = 25;
        CURRENT_PAGE = 1;

        searchInput.value = "";
        catSelect.value = "ALL";
        sortSelect.value = "name_zh,asc";
        pageSizeSelect.value = "25";
        favCheckbox.checked = false;
        dupCheckbox.checked = false;

        updateMechanismButtonLabel();
        syncSheetChipSelection();

        applyFiltersAndRender();
      });

      // éš¨æ©Ÿé è¦½
      const randomBtn = document.getElementById("random-button");
      randomBtn.addEventListener("click", () => {
        if (!FILTERED.length) return;
        const idx = Math.floor(Math.random() * FILTERED.length);
        const game = FILTERED[idx];
        CURRENT_SELECTED_GAME = game;
        renderRecommendation();
        const indexInFiltered = FILTERED.findIndex((g) => g.id === game.id);
        if (indexInFiltered >= 0) {
          CURRENT_PAGE = Math.floor(indexInFiltered / PAGE_SIZE) + 1;
          renderGrid();
          updateStatsBar();
        }
      });

      // é é¢åˆ‡æ›ï¼ˆä¸Šæ–¹èˆ‡ä¸‹æ–¹ï¼‰
      const prevBtn = document.getElementById("prev-page-btn");
      const nextBtn = document.getElementById("next-page-btn");
      const prevBtnBottom = document.getElementById("prev-page-btn-bottom");
      const nextBtnBottom = document.getElementById("next-page-btn-bottom");

      function go(delta) {
        const pageCount = Math.max(1, Math.ceil(FILTERED.length / PAGE_SIZE));
        let next = CURRENT_PAGE + delta;
        if (next < 1) next = 1;
        if (next > pageCount) next = pageCount;
        if (next !== CURRENT_PAGE) {
          CURRENT_PAGE = next;
          renderGrid();
          updateStatsBar();
        }
      }

      prevBtn.addEventListener("click", () => go(-1));
      nextBtn.addEventListener("click", () => go(1));
      prevBtnBottom.addEventListener("click", () => go(-1));
      nextBtnBottom.addEventListener("click", () => go(1));

      // æ”¶è—ä¸‹è¼‰
      const downloadBtn = document.getElementById("download-fav-btn");
      downloadBtn.addEventListener("click", downloadFavoritesCsv);

      // æ¨è–¦å€é—œé–‰
      const closeRecBtn = document.getElementById("close-rec-btn");
      closeRecBtn.addEventListener("click", () => {
        CURRENT_SELECTED_GAME = null;
        renderRecommendation();
      });

      // æ©Ÿåˆ¶ bottom sheet
      initMechanismSheet();
    }

    // -----------------------------
    // æ©Ÿåˆ¶ bottom sheet
    // -----------------------------
    function initMechanismSheet() {
      const backdrop = document.getElementById("sheet-backdrop");
      const grid = document.getElementById("sheet-chip-grid");
      grid.innerHTML = "";

      const entries = Object.entries(MECHANISM_STATS).sort((a, b) => {
        if (b[1] !== a[1]) return b[1] - a[1];
        return a[0].localeCompare(b[0], "en");
      });

      for (const [name, count] of entries) {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "sheet-chip";
        chip.dataset.mechanism = name;
        chip.innerHTML = `<strong>${name}</strong><span class="count">${count}</span>`;
        chip.addEventListener("click", () => {
          const key = chip.dataset.mechanism;
          if (SELECTED_MECHANISMS.has(key)) {
            SELECTED_MECHANISMS.delete(key);
          } else {
            SELECTED_MECHANISMS.add(key);
          }
          chip.classList.toggle("selected", SELECTED_MECHANISMS.has(key));
          updateMechanismButtonLabel();
        });
        grid.appendChild(chip);
      }

      const mechBtn = document.getElementById("mechanism-button");
      mechBtn.addEventListener("click", () => {
        backdrop.classList.add("open");
        backdrop.setAttribute("aria-hidden", "false");
        syncSheetChipSelection();
      });

      const closeBtn = document.getElementById("sheet-close-btn");
      const applyBtn = document.getElementById("sheet-apply-btn");
      const clearBtn = document.getElementById("sheet-clear-btn");

      function closeSheet() {
        backdrop.classList.remove("open");
        backdrop.setAttribute("aria-hidden", "true");
      }

      closeBtn.addEventListener("click", closeSheet);

      applyBtn.addEventListener("click", () => {
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
        closeSheet();
      });

      clearBtn.addEventListener("click", () => {
        SELECTED_MECHANISMS.clear();
        syncSheetChipSelection();
        updateMechanismButtonLabel();
        CURRENT_PAGE = 1;
        applyFiltersAndRender();
      });

      backdrop.addEventListener("click", (ev) => {
        if (ev.target === backdrop) {
          closeSheet();
        }
      });

      updateMechanismButtonLabel();
      syncSheetChipSelection();
    }

    function syncSheetChipSelection() {
      const chips = document.querySelectorAll(".sheet-chip");
      chips.forEach((chip) => {
        const key = chip.dataset.mechanism;
        chip.classList.toggle("selected", SELECTED_MECHANISMS.has(key));
      });
    }

    function updateMechanismButtonLabel() {
      const mechBtn = document.getElementById("mechanism-button");
      if (!SELECTED_MECHANISMS.size) {
        mechBtn.textContent = "å…¨éƒ¨æ©Ÿåˆ¶";
      } else if (SELECTED_MECHANISMS.size <= 3) {
        mechBtn.textContent = Array.from(SELECTED_MECHANISMS).join("ã€");
      } else {
        const first = Array.from(SELECTED_MECHANISMS).slice(0, 3).join("ã€");
        mechBtn.textContent = `${first} ç­‰ ${SELECTED_MECHANISMS.size} ç¨®`;
      }
    }

    // -----------------------------
    // ç¯©é¸ï¼‹æ’åºï¼‹æ¸²æŸ“ä¸»æµç¨‹
    // -----------------------------
    function applyFiltersAndRender(resetPage = true) {
      FILTERED = ALL_GAMES.filter((g) => {
        if (SELECTED_CATEGORY !== "ALL") {
          const cats = g.categories || [];
          if (!cats.includes(SELECTED_CATEGORY)) return false;
        }

        if (SELECTED_MECHANISMS.size) {
          const mechs = new Set(g.mechanisms || []);
          let matched = false;
          for (const m of SELECTED_MECHANISMS) {
            if (mechs.has(m)) {
              matched = true;
              break;
            }
          }
          if (!matched) return false;
        }

        if (ONLY_FAVORITES && !FAVORITE_IDS.has(g.id)) return false;
        if (ONLY_DUPLICATES && !DUPLICATE_IDS.has(g.id)) return false;

        if (SEARCH_TEXT) {
          const q = SEARCH_TEXT.toLowerCase();
          const fields = [
            g.name_zh || "",
            g.name_en || "",
            g.name || "",
            (g.categories || []).join(" "),
            (g.mechanisms || []).join(" "),
          ];
          const hay = fields.join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        return true;
      });

      FILTERED.sort((a, b) => {
        const key = SORT_KEY;
        let va = a[key];
        let vb = b[key];

        if (key === "name_zh") {
          const na = a.name_zh || a.name_en || a.name || "";
          const nb = b.name_zh || b.name_en || b.name || "";
          const cmp = na.localeCompare(nb, "zh-Hant");
          return SORT_DIR === "asc" ? cmp : -cmp;
        }

        if (va == null && vb == null) return 0;
        if (va == null) return 1;
        if (vb == null) return -1;

        if (typeof va === "string" || typeof vb === "string") {
          const cmp = String(va).localeCompare(String(vb), "zh-Hant");
          return SORT_DIR === "asc" ? cmp : -cmp;
        }

        if (SORT_DIR === "asc") return va - vb;
        return vb - va;
      });

      if (resetPage) CURRENT_PAGE = 1;

      renderGrid();
      updateStatsBar();
    }

    function updateStatsBar() {
      const total = ALL_GAMES.length;
      const filtered = FILTERED.length;
      const totalEl = document.getElementById("total-count");
      const filteredEl = document.getElementById("filtered-count");
      const fromEl = document.getElementById("range-from");
      const toEl = document.getElementById("range-to");
      const pageIndexEl = document.getElementById("page-index");
      const pageCountEl = document.getElementById("page-count");

      totalEl.textContent = total.toString();
      filteredEl.textContent = filtered.toString();

      const pageCount = Math.max(1, Math.ceil(filtered / PAGE_SIZE));
      if (CURRENT_PAGE > pageCount) CURRENT_PAGE = pageCount;

      const from = filtered === 0 ? 0 : (CURRENT_PAGE - 1) * PAGE_SIZE + 1;
      const to = Math.min(filtered, CURRENT_PAGE * PAGE_SIZE);

      fromEl.textContent = from.toString();
      toEl.textContent = to.toString();
      pageIndexEl.textContent = pageCount === 0 ? "0" : CURRENT_PAGE.toString();
      pageCountEl.textContent = pageCount.toString();

      const labelTop = document.getElementById("page-label");
      const labelBottom = document.getElementById("page-label-bottom");
      const labelText = `ç¬¬ ${pageCount === 0 ? 0 : CURRENT_PAGE} / ${pageCount} é `;
      labelTop.textContent = labelText;
      labelBottom.textContent = labelText;

      const prevBtn = document.getElementById("prev-page-btn");
      const nextBtn = document.getElementById("next-page-btn");
      const prevBtnBottom = document.getElementById("prev-page-btn-bottom");
      const nextBtnBottom = document.getElementById("next-page-btn-bottom");

      const canPrev = CURRENT_PAGE > 1;
      const canNext = CURRENT_PAGE < pageCount;

      prevBtn.disabled = !canPrev;
      prevBtnBottom.disabled = !canPrev;
      nextBtn.disabled = !canNext;
      nextBtnBottom.disabled = !canNext;
    }

    // -----------------------------
    // æ¸²æŸ“ä¸»å¡ç‰‡
    // -----------------------------
    function renderGrid() {
      const grid = document.getElementById("card-grid");
      grid.innerHTML = "";

      if (!FILTERED.length) {
        const empty = document.createElement("div");
        empty.textContent = "ç›®å‰æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„éŠæˆ²ã€‚";
        empty.style.padding = "16px";
        empty.style.color = "#6b7280";
        grid.appendChild(empty);
        return;
      }

      const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
      const end = Math.min(FILTERED.length, CURRENT_PAGE * PAGE_SIZE);
      const slice = FILTERED.slice(start, end);

      for (const g of slice) {
        const card = document.createElement("article");
        card.className = "game-card";
        card.dataset.id = g.id;
        if (FAVORITE_IDS.has(g.id)) card.classList.add("favorited");
        if (DUPLICATE_IDS.has(g.id)) card.classList.add("duplicate");

        card.addEventListener("click", (ev) => {
          if (ev.target.closest("button")) return;
          CURRENT_SELECTED_GAME = g;
          renderRecommendation();
        });

        const header = document.createElement("div");
        header.className = "game-card-header";

        const img = document.createElement("img");
        img.loading = "lazy";
        img.src = g.image || g.thumbnail || "";
        img.alt = g.display_name;
        header.appendChild(img);

        const main = document.createElement("div");
        main.className = "game-card-main";

        const title = document.createElement("div");
        title.className = "game-title";
        const yearText = g.year ? `(${g.year})` : "";
        const minP = g.min_players ?? g.minplayers;
        const maxP = g.max_players ?? g.maxplayers;
        const playersText = (minP && maxP) ? `${minP}â€“${maxP}äºº` : "";
        title.textContent = g.name_zh || g.name_en || g.name || "";
        if (yearText || playersText) {
          const small = document.createElement("small");
          small.textContent = [yearText, playersText].filter(Boolean).join("ï¼");
          title.appendChild(small);
        }
        main.appendChild(title);

        const ratingLine = document.createElement("div");
        ratingLine.className = "rating-line";
        ratingLine.innerHTML = `
          <span>Bayesï¼š<strong>${fmtNum(g.rating_bayes, 2)}</strong></span>
          <span>å‡åˆ†ï¼š<strong>${fmtNum(g.rating_avg, 2)}</strong></span>
          <span>è©•åˆ†äººæ•¸ï¼š<strong>${fmtInt(g.users_rated)}</strong></span>
          <span>é‡åº¦ï¼š<strong>${fmtNum(g.weight, 2)}</strong></span>
          <span>æ©Ÿåˆ¶æ•¸ï¼š<strong>${g.mechanism_count || g.mechanisms.length || 0}</strong></span>
        `;
        main.appendChild(ratingLine);

        const priceLine = document.createElement("div");
        priceLine.className = "price-stock-line";
        priceLine.innerHTML = `
          <span>äºŒæ‰‹ï¼š${g.used_price_twd != null ? "NT$" + g.used_price_twd : "ï¼"}</span>
          <span>åº«å­˜ï¼š${g.stock != null ? g.stock : "ï¼"}</span>
        `;
        main.appendChild(priceLine);

        const chipRow = document.createElement("div");
        chipRow.className = "chip-row";

        for (const cat of g.categories || []) {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "chip category";
          chip.textContent = cat;
          chip.addEventListener("click", (ev) => {
            ev.stopPropagation();
            const catSelect = document.getElementById("category-select");
            SELECTED_CATEGORY = cat;
            catSelect.value = cat;
            CURRENT_PAGE = 1;
            applyFiltersAndRender();
          });
          chipRow.appendChild(chip);
        }

        for (const mech of g.mechanisms || []) {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "chip mechanism";
          chip.textContent = mech;
          chip.addEventListener("click", (ev) => {
            ev.stopPropagation();
            if (SELECTED_MECHANISMS.has(mech)) {
              SELECTED_MECHANISMS.delete(mech);
            } else {
              SELECTED_MECHANISMS.add(mech);
            }
            updateMechanismButtonLabel();
            syncSheetChipSelection();
            CURRENT_PAGE = 1;
            applyFiltersAndRender();
          });
          chipRow.appendChild(chip);
        }

        main.appendChild(chipRow);
        header.appendChild(main);
        card.appendChild(header);

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const footerLeft = document.createElement("div");
        footerLeft.className = "card-footer-left";
        const mechCnt = g.mechanism_count || g.mechanisms.length || 0;
        footerLeft.innerHTML = `<span>BGG IDï¼š${g.bgg_id || "ï¼"}</span><span>æ©Ÿåˆ¶æ•¸ï¼š${mechCnt}</span>`;
        footer.appendChild(footerLeft);

        const footerRight = document.createElement("div");
        footerRight.className = "card-footer-right";

        const favBtn = document.createElement("button");
        favBtn.type = "button";
        favBtn.className = "pill-btn icon";
        favBtn.innerHTML = `<span class="star">${FAVORITE_IDS.has(g.id) ? "â˜…" : "â˜†"}</span>æ”¶è—`;
        favBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          toggleFavorite(g.id);
        });
        footerRight.appendChild(favBtn);

        const bggBtn = document.createElement("button");
        bggBtn.type = "button";
        bggBtn.className = "pill-btn icon";
        bggBtn.textContent = "BGG";
        bggBtn.disabled = !g.bgg_url;
        bggBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if (g.bgg_url) window.open(g.bgg_url, "_blank");
        });
        footerRight.appendChild(bggBtn);

        footer.appendChild(footerRight);
        card.appendChild(footer);

        grid.appendChild(card);
      }
    }

    // -----------------------------
    // æ¨è–¦å€ï¼ˆä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡ï¼‰
    // -----------------------------
    function renderRecommendation() {
      const mainEl = document.getElementById("rec-main");
      const listEl = document.getElementById("rec-list");
      const subtitleEl = document.getElementById("rec-subtitle");

      mainEl.innerHTML = "";
      listEl.innerHTML = "";

      if (!CURRENT_SELECTED_GAME) {
        subtitleEl.textContent = "è«‹å…ˆå¾ä¸‹æ–¹å¡ç‰‡é»é¸ä¸€æ¬¾éŠæˆ²ï¼Œæˆ–ä½¿ç”¨ã€Œéš¨æ©Ÿé è¦½ã€ã€‚";
        return;
      }

      const g = CURRENT_SELECTED_GAME;
      subtitleEl.textContent = "æ ¹æ“šåˆ†é¡ï¼æ©Ÿåˆ¶èˆ‡é‡åº¦ï¼Œå¾ç›®å‰è³‡æ–™ä¸­æ¨è–¦ç›¸è¿‘çš„éŠæˆ²ã€‚";

      const img = document.createElement("img");
      img.src = g.image || g.thumbnail || "";
      img.alt = g.display_name;
      img.loading = "lazy";
      mainEl.appendChild(img);

      const meta = document.createElement("div");
      meta.className = "rec-main-meta";

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = g.name_zh || g.name_en || g.name || "";
      meta.appendChild(title);

      const metaLine = document.createElement("div");
      metaLine.className = "meta-line";
      metaLine.innerHTML = `
        Bayesï¼š<strong>${fmtNum(g.rating_bayes, 2)}</strong>ã€€
        å‡åˆ†ï¼š<strong>${fmtNum(g.rating_avg, 2)}</strong>ã€€
        è©•åˆ†äººæ•¸ï¼š<strong>${fmtInt(g.users_rated)}</strong>ã€€
        é‡åº¦ï¼š<strong>${fmtNum(g.weight, 2)}</strong>
      `;
      meta.appendChild(metaLine);

      const chipsLine = document.createElement("div");
      chipsLine.className = "chips-line";
      chipsLine.innerHTML = `
        <div>åˆ†é¡ï¼š<span>${(g.categories || []).join(" ï¼ ") || "ï¼"}</span></div>
        <div>æ©Ÿåˆ¶ï¼š<span>${((g.mechanisms || []).length ? g.mechanisms : []).join(" ï¼ ") || "ï¼"}</span></div>
      `;
      meta.appendChild(chipsLine);

      const priceLine = document.createElement("div");
      priceLine.className = "price-line";
      priceLine.innerHTML = `
        <strong>äºŒæ‰‹ï¼š</strong>${g.used_price_twd != null ? "NT$" + g.used_price_twd : "ï¼"}
        <strong>åº«å­˜ï¼š</strong>${g.stock != null ? g.stock : "ï¼"}
      `;
      meta.appendChild(priceLine);

      const actions = document.createElement("div");
      actions.className = "rec-main-actions";

      const favBtn = document.createElement("button");
      favBtn.type = "button";
      favBtn.className = "primary";
      favBtn.textContent = FAVORITE_IDS.has(g.id) ? "å·²æ”¶è—" : "åŠ å…¥æ”¶è—";
      favBtn.addEventListener("click", () => {
        toggleFavorite(g.id);
        favBtn.textContent = FAVORITE_IDS.has(g.id) ? "å·²æ”¶è—" : "åŠ å…¥æ”¶è—";
      });
      actions.appendChild(favBtn);

      const bggBtn = document.createElement("button");
      bggBtn.type = "button";
      bggBtn.textContent = "åœ¨ BGG æŸ¥çœ‹";
      bggBtn.disabled = !g.bgg_url;
      bggBtn.addEventListener("click", () => {
        if (g.bgg_url) window.open(g.bgg_url, "_blank");
      });
      actions.appendChild(bggBtn);

      meta.appendChild(actions);
      mainEl.appendChild(meta);

      const recommendations = computeRecommendations(g, ALL_GAMES, 8);

      if (!recommendations.length) {
        const empty = document.createElement("div");
        empty.style.fontSize = "12px";
        empty.style.color = "#6b7280";
        empty.textContent = "æš«æ™‚æ²’æœ‰æ˜é¡¯ç›¸ä¼¼çš„éŠæˆ²ã€‚";
        listEl.appendChild(empty);
        return;
      }

      for (const rec of recommendations) {
        const card = document.createElement("div");
        card.className = "rec-card";
        card.dataset.id = rec.game.id;

        card.addEventListener("click", () => {
          CURRENT_SELECTED_GAME = rec.game;
          renderRecommendation();
          const idx = FILTERED.findIndex((x) => x.id === rec.game.id);
          if (idx >= 0) {
            CURRENT_PAGE = Math.floor(idx / PAGE_SIZE) + 1;
            renderGrid();
            updateStatsBar();
          }
        });

        const img2 = document.createElement("img");
        img2.src = rec.game.image || rec.game.thumbnail || "";
        img2.alt = rec.game.display_name;
        img2.loading = "lazy";
        card.appendChild(img2);

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = rec.game.name_zh || rec.game.name_en || rec.game.name || "";
        card.appendChild(name);

        const metaLine2 = document.createElement("div");
        metaLine2.className = "meta";
        metaLine2.textContent =
          `Bayes ${fmtNum(rec.game.rating_bayes, 2)}ï½œé‡åº¦ ${fmtNum(rec.game.weight, 2)}ï½œæ©Ÿåˆ¶æ•¸ ${rec.game.mechanism_count || rec.game.mechanisms.length || 0}`;
        card.appendChild(metaLine2);

        const priceStock = document.createElement("div");
        priceStock.className = "price-stock";
        priceStock.textContent =
          `äºŒæ‰‹ ${rec.game.used_price_twd != null ? "NT$" + rec.game.used_price_twd : "ï¼"}ï¼åº«å­˜ ${rec.game.stock != null ? rec.game.stock : "ï¼"}`;
        card.appendChild(priceStock);

        const cats = (rec.game.categories || []).slice(0, 2).join("ï¼");
        const mechs = (rec.game.mechanisms || []).slice(0, 2).join("ï¼");
        if (cats || mechs) {
          const cm = document.createElement("div");
          cm.className = "meta";
          cm.textContent = [cats, mechs].filter(Boolean).join("ï½œ");
          card.appendChild(cm);
        }

        listEl.appendChild(card);
      }
    }

    function computeRecommendations(target, all, maxCount) {
      const tCats = new Set(target.categories || []);
      const tMechs = new Set(target.mechanisms || []);
      const tWeight = typeof target.weight === "number" ? target.weight : null;

      const scored = [];
      for (const g of all) {
        if (g.id === target.id) continue;
        if (!g.mechanisms || !g.mechanisms.length) continue;

        const gCats = new Set(g.categories || []);
        const gMechs = new Set(g.mechanisms || []);

        let mechOverlap = 0;
        for (const m of tMechs) if (gMechs.has(m)) mechOverlap++;

        let catOverlap = 0;
        for (const c of tCats) if (gCats.has(c)) catOverlap++;

        if (mechOverlap === 0 && catOverlap === 0) continue;

        let weightScore = 0;
        if (tWeight != null && typeof g.weight === "number") {
          const diff = Math.abs(tWeight - g.weight);
          weightScore = Math.max(0, 2.5 - diff);
        }

        const score = mechOverlap * 3 + catOverlap * 1.5 + weightScore;
        if (score <= 0) continue;

        scored.push({ game: g, score });
      }

      scored.sort((a, b) => b.score - a.score);
      return scored.slice(0, maxCount);
    }

    // -----------------------------
    // æ”¶è—æ¸…å–®ä¸‹è¼‰
    // -----------------------------
    function downloadFavoritesCsv() {
      if (!FAVORITE_IDS.size) {
        alert("ç›®å‰æ²’æœ‰æ”¶è—ä»»ä½•éŠæˆ²ã€‚");
        return;
      }

      const header = [
        "id",
        "name_zh",
        "name_en",
        "bgg_id",
        "used_price_twd",
        "stock",
        "rating_bayes",
        "rating_avg",
        "users_rated",
        "weight",
        "categories",
        "mechanisms",
      ];

      const rows = [header.join(",")];

      for (const id of FAVORITE_IDS) {
        const g = ALL_GAMES.find((x) => x.id === id);
        if (!g) continue;
        const row = [
          safeCsv(g.id),
          safeCsv(g.name_zh || ""),
          safeCsv(g.name_en || g.name || ""),
          safeCsv(g.bgg_id || ""),
          g.used_price_twd != null ? g.used_price_twd : "",
          g.stock != null ? g.stock : "",
          g.rating_bayes != null ? g.rating_bayes : "",
          g.rating_avg != null ? g.rating_avg : "",
          g.users_rated != null ? g.users_rated : "",
          g.weight != null ? g.weight : "",
          safeCsv((g.categories || []).join(" / ")),
          safeCsv((g.mechanisms || []).join(" / ")),
        ];
        rows.push(row.join(","));
      }

      const csv = rows.join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const now = new Date();
      const ts =
        now.getFullYear().toString() +
        String(now.getMonth() + 1).padStart(2, "0") +
        String(now.getDate()).padStart(2, "0");
      a.download = `boardgame_favorites_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function safeCsv(value) {
      const s = String(value ?? "");
      if (s.includes(",") || s.includes("\"") || s.includes("\n")) {
        return "\"" + s.replace(/\"/g, "\"\"") + "\"";
      }
      return s;
    }

    // -----------------------------
    // å°å·¥å…·
    // -----------------------------
    function fmtNum(v, digits) {
      if (v == null || isNaN(v)) return "ï¼";
      return Number(v).toFixed(digits);
    }

    function fmtInt(v) {
      if (v == null || isNaN(v)) return "ï¼";
      return Math.round(v).toString();
    }
  </script>
</body>
</html>
