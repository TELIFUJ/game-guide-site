name: Update Game Data

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * *"  # 台灣 01:00（UTC+8）

concurrency:
  group: update-game-data
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests pillow

      # 先確保備份檔存在（若已有 games_full.json 且沒有 backup，就複製一份）
      - name: Ensure backup exists
        run: |
          mkdir -p data
          if [ -f data/games_full.json ] && [ ! -f data/games_full_backup.json ]; then
            cp data/games_full.json data/games_full_backup.json
          fi
          # 若 taxonomy 對照檔不存在，建表頭
          [ -f data/mechanism_map_zh.csv ] || echo 'bgg_mechanism_en,mechanism_zh' > data/mechanism_map_zh.csv
          [ -f data/category_map_zh.csv ]  || echo 'bgg_category_en,category_zh'     > data/category_map_zh.csv
          mkdir -p assets/img

      # 跑 repo 內 scripts
      - name: Run scripts (bootstrap: 放寬門檻一次)
        env:
          BGG_HOSTS: 'api.geekdo.com,boardgamegeek.com'  # 先打 api.geekdo.com，再備援 bgg
          BGG_BATCH: '6'          # 小批次
          BGG_SLEEP: '4.0'        # 批間延遲
          BGG_RETRY: '6'          # 重試次數
          BGG_JITTER: '0.8'       # 抖動，避免節律命中
          BGG_MIN_SAVE: '1'       # ← 先設 1 筆就覆蓋舊檔（之後再調回 30~50）
          BGG_VERSIONS: '0'       # 關 versions 降負荷
          BUILD_MIN_ITEMS: '1'    # ← 先設 1 筆就產出（之後再調回 10）
        run: |
          python scripts/resolve_bgg.py || true
          python scripts/fetch_bgg.py
          python scripts/apply_taxonomy_and_price.py || true
          python scripts/make_mechanism_map.py || true
          python scripts/fetch_version_image.py || true
          python scripts/download_images.py || true
          python scripts/build_json.py

      - name: Sanity check (counts)
        run: |
          python - <<'PY'
          import json, pathlib
          p1 = pathlib.Path('data/bgg_data.json')
          p2 = pathlib.Path('data/games_full.json')
          n1 = len(json.loads(p1.read_text(encoding='utf-8'))) if p1.exists() else -1
          n2 = len(json.loads(p2.read_text(encoding='utf-8'))) if p2.exists() else -1
          print(f'INFO bgg_data.json rows={n1}, games_full.json rows={n2}')
          if n2 <= 0:
              print('::warning::games_full.json is empty; site will show empty state.')
          PY

      - name: Commit changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 清理舊遺留（可有可無）
          git rm -f data/comments_cache.json 2>/dev/null || true
          git rm -f scripts/fetch_comments.py 2>/dev/null || true
          # 更新檔案（含備份）
          git add data/games_full.json data/games_full_backup.json data/bgg_data.json data/bgg_ids.json || true
          git add data/mechanism_map_zh.csv data/mechanism_map_candidates.csv || true
          git add assets/img/* || true
          git commit -m "Auto-update game data (bootstrap)" || echo "No changes to commit"
          git push || echo "No changes to push"
