name: Build & Deploy Game Data

on:
  workflow_dispatch:
    inputs:
      force_fetch:
        description: "強制重新抓取 BGG（忽略快取/TTL）"
        type: boolean
        required: false
        default: false
  schedule:
    - cron: "15 21 * * *"   # 每日 05:15 (+08)

concurrency:
  group: build-deploy-game-data
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    env:
      BGG_HOSTS: boardgamegeek.com,api.geekdo.com
      BGG_BATCH: "20"
      BGG_SLEEP: "6.0"
      BGG_RETRY: "6"
      BGG_JITTER: "0.8"
      BGG_VERSIONS: "0"
      HTTP_UA: "PlayClass-BGG-Fetch/1.0 (contact: you@example.com)"
      HTTP_ACCEPT_LANGUAGE: "en-US,en;q=0.9"
      BGG_TOKEN: ${{ secrets.BGG_TOKEN }}
      PYTHONPATH: ${{ github.workspace }}
      BGG_TTL_DAYS: "7"
      FORCE_FETCH: ${{ github.event.inputs.force_fetch == 'true' && '1' || '0' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests lxml pillow tenacity

      - name: Ensure dirs
        run: mkdir -p data assets/img site/assets/img site/data || true

      # ① 快取同時包含 assets/img（來源）與 site/assets/img（目標）
      - name: Restore cache (data & images)
        uses: actions/cache@v4
        with:
          path: |
            data
            assets/img
            site/assets/img
          key: bgg-data-v1-${{ hashFiles('data/bgg_ids.json') }}-${{ env.BGG_VERSIONS }}
          restore-keys: |
            bgg-data-v1-

      - name: Resolve IDs (optional)
        run: |
          if [ -f scripts/resolve_bgg.py ]; then
            python -u scripts/resolve_bgg.py || true
          fi

      - name: Plan fetch
        id: plan
        shell: python
        run: |
          import os, json, pathlib, hashlib, time
          P = pathlib.Path
          ids = P("data/bgg_ids.json")
          out = P("data/bgg_data.json")
          stamp = P("data/.bgg_stamp")
          hfile = P("data/.bgg_ids.hash")
          ttl_days = int(os.getenv("BGG_TTL_DAYS","7"))
          force = os.getenv("FORCE_FETCH","0") == "1"
          def sha(p): return (p.read_bytes() and __import__("hashlib").sha256(p.read_bytes()).hexdigest()) if p.exists() else ""
          cur_hash = sha(ids); prev_hash = hfile.read_text().strip() if hfile.exists() else ""
          ids_changed = (cur_hash != prev_hash)
          now=time.time()
          if not out.exists():
            need=True; reason=["no_data"]
          else:
            base = stamp.stat().st_mtime if stamp.exists() else out.stat().st_mtime
            age = (now-base)/86400; need = age>ttl_days; reason=[f"age={age:.2f}>ttl={ttl_days}"] if need else []
          if ids_changed: need=True; reason.append("ids_changed")
          if force: need=True; reason.append("forced")
          print("need_fetch:", need, "reason:", "|".join(reason) or "none")
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"do_fetch={'true' if need else 'false'}\n")
            f.write(f"reason={'|'.join(reason) or 'none'}\n")

      - name: Show fetch plan
        run: |
          echo "do_fetch = ${{ steps.plan.outputs.do_fetch }}"
          echo "reason   = ${{ steps.plan.outputs.reason }}"

      - name: Fetch BGG (XML2)
        if: steps.plan.outputs.do_fetch == 'true'
        shell: bash
        run: |
          python -u scripts/fetch_bgg.py || true

      - name: Apply taxonomy & price merge
        run: python -u scripts/apply_taxonomy_and_price.py

      - name: Normalize data & enrich (ranking)
        run: |
          if [ -f scripts/normalize_bgg_data.py ]; then
            python -u scripts/normalize_bgg_data.py
          fi

      - name: Use version image if specified
        run: |
          if [ -f scripts/fetch_version_image.py ]; then
            python -u scripts/fetch_version_image.py
          fi

      - name: Download & thumbnail images (best-effort)
        run: |
          if [ -f scripts/download_images.py ]; then
            python -u scripts/download_images.py || true
          fi

      # ② 關鍵：把 assets/img 同步到 site/assets/img（前端以相對路徑讀圖）
      - name: Sync images into site
        run: |
          mkdir -p site/assets/img
          rsync -a --delete assets/img/ site/assets/img/ || true
          echo "images_in_site=$(find site/assets/img -type f | wc -l)"

      - name: Build final site JSON (full + site)
        run: python -u scripts/build_json.py

      - name: Publish site data (normalize image URLs)
        run: |
          if [ -f scripts/publish_games.py ]; then
            python -u scripts/publish_games.py
          fi

      - name: Update cache markers
        if: steps.plan.outputs.do_fetch == 'true'
        shell: python
        run: |
          import pathlib, hashlib, time
          ids=pathlib.Path("data/bgg_ids.json")
          h=pathlib.Path("data/.bgg_ids.hash"); s=pathlib.Path("data/.bgg_stamp")
          if ids.exists(): h.write_text(hashlib.sha256(ids.read_bytes()).hexdigest())
          s.touch()

      # ③ 部署前檢查：大小＆檔數應顯著提升
      - name: Sanity check site bundle
        run: |
          du -sh site || true
          echo "images_in_site=$(find site/assets/img -type f | wc -l)"

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
