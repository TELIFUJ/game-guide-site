name: Update Game Data

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * *"   # 台灣 01:00（UTC+8）

concurrency:
  group: update-game-data
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests pillow

      - name: Ensure backup exists
        run: |
          mkdir -p data assets/img
          if [ -f data/games_full.json ] && [ ! -f data/games_full_backup.json ]; then
            cp data/games_full.json data/games_full_backup.json
          fi
          [ -f data/mechanism_map_zh.csv ] || echo 'bgg_mechanism_en,mechanism_zh' > data/mechanism_map_zh.csv
          [ -f data/category_map_zh.csv ]  || echo 'bgg_category_en,category_zh'     > data/category_map_zh.csv

      # ========= Run scripts, step by step =========
      - name: Resolve IDs
        env:
          PYTHONUNBUFFERED: "1"
        run: python -u scripts/resolve_bgg.py || true

      # 首次啟動先限縮 60 筆，確保前端不空白；之後可刪除此步驟
      - name: Bootstrap limit IDs to 60
        run: |
          python - <<'PY'
          import json, pathlib
          p = pathlib.Path('data/bgg_ids.json')
          if p.exists():
              js = json.loads(p.read_text(encoding='utf-8'))
              if isinstance(js, list) and len(js) > 60:
                  p.write_text(json.dumps(js[:60], ensure_ascii=False, indent=2), encoding='utf-8')
                  print('Bootstrap limit applied: 60')
          PY

      - name: Fetch BGG
        env:
          PYTHONUNBUFFERED: "1"
          BGG_HOSTS: "api.geekdo.com,boardgamegeek.com"
          BGG_BATCH: "6"
          BGG_SLEEP: "4.0"
          BGG_RETRY: "6"
          BGG_JITTER: "0.8"
          BGG_MIN_SAVE: "1"
          BGG_VERSIONS: "0"
        run: python -u scripts/fetch_bgg.py

      - name: Apply taxonomy & price
        env:
          PYTHONUNBUFFERED: "1"
        run: python -u scripts/apply_taxonomy_and_price.py || true

      - name: Fetch version image (optional)
        env:
          PYTHONUNBUFFERED: "1"
        run: python -u scripts/fetch_version_image.py || true

      - name: Download images (thumbnails)
        env:
          PYTHONUNBUFFERED: "1"
        run: python -u scripts/download_images.py || true

      - name: Build final JSON
        env:
          PYTHONUNBUFFERED: "1"
          BUILD_MIN_ITEMS: "1"   # 首次：1 筆即可產出
        run: python -u scripts/build_json.py

      - name: Sanity check (counts)
        run: |
          python - <<'PY'
          import json, pathlib
          p1 = pathlib.Path('data/bgg_data.json')
          p2 = pathlib.Path('data/games_full.json')
          n1 = len(json.loads(p1.read_text(encoding='utf-8'))) if p1.exists() else -1
          n2 = len(json.loads(p2.read_text(encoding='utf-8'))) if p2.exists() else -1
          print(f'INFO bgg_data.json rows={n1}, games_full.json rows={n2}')
          if n2 <= 0:
              print('::warning::games_full.json is empty; site will show empty state.')
          PY

      - name: Commit changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git rm -f data/comments_cache.json 2>/dev/null || true
          git rm -f scripts/fetch_comments.py 2>/dev/null || true
          git add data/games_full.json data/games_full_backup.json data/bgg_data.json data/bgg_ids.json || true
          git add data/mechanism_map_zh.csv data/mechanism_map_candidates.csv || true
          git add assets/img/* || true
          git commit -m "Auto-update game data (bootstrap, limited IDs)" || echo "No changes to commit"
          git push || echo "No changes to push"
