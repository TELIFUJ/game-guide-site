name: Update game data & Deploy Pages (v1.2)

on:
  workflow_dispatch:
  schedule:
    - cron: "37 17 * * *"   # 每日 01:37+08 部署

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}

      - name: Install deps (best-effort)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          pip install requests lxml tenacity || true

      # === 你的資料流程（保留可選步驟） ===
      - name: Fetch BGG (optional)
        if: ${{ hashFiles('scripts/fetch_bgg*.py') != '' }}
        run: |
          python -u scripts/fetch_bgg.py || true

      - name: Apply taxonomy & price (optional)
        run: |
          if [ -f scripts/apply_taxonomy_and_price.py ]; then python -u scripts/apply_taxonomy_and_price.py; fi
          if [ -f scripts/normalize_bgg_data.py ]; then python -u scripts/normalize_bgg_data.py; fi
          if [ -f scripts/fetch_version_image.py ]; then python -u scripts/fetch_version_image.py; fi

      - name: Download images → assets/img
        run: |
          python -u scripts/download_images.py || true

      - name: Build JSON (array) → site/data
        run: |
          python -u scripts/build_json.py

      - name: Publish games (safety fuse)
        run: |
          python -u scripts/publish_games.py || true

      - name: Sync images into site/assets/img
        run: |
          mkdir -p site/assets/img
          rsync -a --delete assets/img/ site/assets/img/
          echo "synced images: $(ls -1 site/assets/img | wc -l)"

      - name: Sanity check
        run: |
          test -s site/data/games.json || (echo "site/data/games.json missing" && exit 1)
          jq 'type' site/data/games.json || true
          echo "Top-5:" && jq '.[0:5] | map({id,name,image})' site/data/games.json || true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
